flutter create ogrenci_intelligence_app --org com.ogrenciintelligence
cd ogrenci_intelligence_app

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
ogrenci_intelligence/


# --------- FOLDERS ----------
$dirs = @(
"lib/src/app",
"lib/src/core/config",
"lib/src/core/constants",
"lib/src/core/error",
"lib/src/core/logging",
"lib/src/core/routing",
"lib/src/core/supabase",
"lib/src/core/theme",
"lib/src/shared/utils",
"lib/src/shared/widgets",
"lib/src/features/auth/data",
"lib/src/features/auth/domain",
"lib/src/features/auth/presentation/controllers",
"lib/src/features/auth/presentation/screens",
"lib/src/features/user/data",
"lib/src/features/user/domain",
"lib/src/features/user/presentation/controllers",
"lib/src/features/user/presentation/screens",
"lib/src/features/company/data",
"lib/src/features/company/domain",
"lib/src/features/company/presentation/controllers",
"lib/src/features/company/presentation/screens",
"lib/src/features/admin/data",
"lib/src/features/admin/domain",
"lib/src/features/admin/presentation/controllers",
"lib/src/features/admin/presentation/screens",
".github/workflows",
"docs"
)

$dirs | ForEach-Object { New-Item -ItemType Directory -Force -Path $_ | Out-Null }

# --------- FILES ----------
$files = @(
"lib/src/app/app.dart",
"lib/src/app/bootstrap.dart",
"lib/src/core/config/env.dart",
"lib/src/core/constants/app_constants.dart",
"lib/src/core/error/app_exception.dart",
"lib/src/core/error/failure.dart",
"lib/src/core/logging/logger.dart",
"lib/src/core/routing/app_router.dart",
"lib/src/core/routing/routes.dart",
"lib/src/core/routing/route_guards.dart",
"lib/src/core/supabase/supabase_service.dart",
"lib/src/core/theme/app_theme.dart",
"lib/src/core/theme/app_colors.dart",
"lib/src/core/theme/app_typography.dart",
"lib/src/shared/utils/validators.dart",
"lib/src/shared/utils/formatters.dart",
"lib/src/shared/widgets/app_button.dart",
"lib/src/shared/widgets/app_text_field.dart",
"lib/src/shared/widgets/loading_view.dart",
"lib/src/shared/widgets/empty_state.dart",

"lib/src/features/auth/data/auth_repository.dart",
"lib/src/features/auth/domain/auth_models.dart",
"lib/src/features/auth/presentation/controllers/auth_controller.dart",
"lib/src/features/auth/presentation/screens/login_screen.dart",
"lib/src/features/auth/presentation/screens/register_screen.dart",
"lib/src/features/auth/presentation/screens/forgot_password_screen.dart",
"lib/src/features/auth/presentation/screens/email_verification_screen.dart",

"lib/src/features/user/data/user_repository.dart",
"lib/src/features/user/domain/user_models.dart",
"lib/src/features/user/presentation/controllers/user_controller.dart",
"lib/src/features/user/presentation/screens/user_dashboard_screen.dart",
"lib/src/features/user/presentation/screens/user_profile_screen.dart",
"lib/src/features/user/presentation/screens/user_settings_screen.dart",

"lib/src/features/company/data/company_repository.dart",
"lib/src/features/company/domain/company_models.dart",
"lib/src/features/company/presentation/controllers/company_controller.dart",
"lib/src/features/company/presentation/screens/company_auth_screen.dart",
"lib/src/features/company/presentation/screens/company_dashboard_screen.dart",

"lib/src/features/admin/data/admin_repository.dart",
"lib/src/features/admin/domain/admin_models.dart",
"lib/src/features/admin/presentation/controllers/admin_controller.dart",
"lib/src/features/admin/presentation/screens/admin_login_screen.dart",
"lib/src/features/admin/presentation/screens/admin_dashboard_screen.dart",

".github/workflows/flutter-ci.yml",
"docs/architecture.md",
"docs/api-contracts.md",
".env.example",
"README.md"
)

$files | ForEach-Object { New-Item -ItemType File -Force -Path $_ | Out-Null }

Write-Host "Scaffold created."

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

git init
git add .
git commit -m "Initial Flutter scaffold"

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

echo "" >> .gitignore
echo "# Local environment files" >> .gitignore
echo ".env" >> .gitignore
echo "*.keystore" >> .gitignore

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

git branch -M main
git remote add origin https://github.com/<YOUR_USERNAME>/ogrenci_intelligence.git
git push -u origin main

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
.github/workflows/flutter-ci.yml

name: Flutter CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Static analysis
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
          if-no-files-found: ignore

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

.github/dependabot.yml

version: 2
enable-beta-ecosystems: true

updates:
  - package-ecosystem: "pub"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5
    groups:
      pub-deps:
        patterns:
          - "*"

  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    groups:
      gha:
        patterns:
          - "*"

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

.github/pull_request_template.md

## Summary
- What does this PR change?

## Screenshots / Video (if UI)
- Attach evidence for UI changes

## Checklist
- [ ] I ran `flutter analyze`
- [ ] I ran `flutter test`
- [ ] I ran `dart format .`
- [ ] No secrets committed (.env, keys, credentials)
- [ ] Relevant docs updated (README / docs/)

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

SECURITY.md

# Security Policy

## Supported Versions
We support the latest version on the `main` branch.

## Reporting a Vulnerability
Please do not open a public issue.
Instead, email the maintainer with:
- vulnerability description
- reproduction steps
- impact assessment
- suggested fix (if available)

We will respond as soon as possible and coordinate a responsible disclosure.

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\pubspec.yaml

name: ogrenci_intelligence
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ">=3.10.0 <4.0.0"
  flutter: 3.38.5

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  # UI/Icons
  cupertino_icons: ^1.0.8

  # Core packages (MOVED HERE from the 'flutter:' section)
  go_router: ^16.0.0
  flutter_riverpod: ^2.6.1
  supabase_flutter: ^2.9.0
  flutter_dotenv: ^5.2.0

  # UI/UX helpers
  flutter_svg: ^2.0.10+1
  cached_network_image: ^3.4.1
  intl: ^0.20.0

  # Logging
  logger: ^2.6.0

dev_dependencies:
  flutter_test:
    sdk: flutter

  # Code generation & development tools (MOVED HERE)
  build_runner: ^2.4.12
  freezed: ^3.2.0
  freezed_annotation: ^3.1.0
  json_serializable: ^6.8.0
  json_annotation: ^4.9.0

  # Linting (Note: 'flutter_lints' is a DEV dependency)
  flutter_lints: ^6.0.0

flutter:
  # Only Flutter-specific configurations belong here:
  uses-material-design: true
  assets:
    - .env

  # assets:
  #   - images/
  # fonts:
  #   - family: ...
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

D:\Dev\ogrenci_intelligence\analysis_options.yaml

# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

analyzer:
  errors:
    invalid_annotation_target: ignore
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
# Safety / correctness
    always_declare_return_types: true
    avoid_dynamic_calls: true
    avoid_print: true
    cancel_subscriptions: true
    close_sinks: true
    prefer_final_locals: true
    require_trailing_commas: true
    unawaited_futures: true

    # Style / maintainability
    directives_ordering: true
    sort_pub_dependencies: false

    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

lib/main.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'src/app/bootstrap.dart';
import 'src/app/app.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await bootstrap(); // loads env + initializes Supabase

  runApp(const ProviderScope(child: App()));
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/app/bootstrap.dart

import '../core/config/env.dart';
import '../core/supabase/supabase_service.dart';

Future<void> bootstrap() async {
  await Env.load();

  await SupabaseService.initialize(
    supabaseUrl: Env.supabaseUrl,
    supabaseAnonKey: Env.supabaseAnonKey,
  );
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

lib/src/core/config/env.dart

// lib/src/core/config/env.dart
import 'package:flutter_dotenv/flutter_dotenv.dart';

class Env {
  static Future<void> load() async {
    await dotenv.load(fileName: '.env');
  }

  static String _must(String key) {
    final v = dotenv.env[key];
    if (v == null || v.trim().isEmpty) {
      throw StateError('Missing env var: $key');
    }
    return v.trim();
  }

  static String get supabaseUrl => _must('SUPABASE_URL');
  static String get supabaseAnonKey => _must('SUPABASE_ANON_KEY');

  static String get deepLinkScheme =>
      (dotenv.env['DEEPLINK_SCHEME'] ?? 'com.ogrenciintelligence').trim();

  static Uri get deepLinkCallback => Uri.parse(
        (dotenv.env['DEEPLINK_CALLBACK'] ?? '$deepLinkScheme://login-callback')
            .trim(),
      );

  static Uri get deepLinkResetPassword => Uri.parse(
        (dotenv.env['DEEPLINK_RESET_PASSWORD'] ??
                '$deepLinkScheme://reset-password')
            .trim(),
      );
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/supabase/supabase_service.dart


import 'package:supabase_flutter/supabase_flutter.dart';

class SupabaseService {
  static Future<void> initialize({
    required String supabaseUrl,
    required String supabaseAnonKey,
  }) async {
    if (supabaseUrl.isEmpty || supabaseAnonKey.isEmpty) {
      throw Exception('Missing SUPABASE_URL or SUPABASE_ANON_KEY in .env');
    }

    await Supabase.initialize(
      url: supabaseUrl,
      anonKey: supabaseAnonKey,
      authOptions: const FlutterAuthClientOptions(
        authFlowType: AuthFlowType.pkce,
      ),
    );
  }

  static SupabaseClient get client => Supabase.instance.client;
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/routes.dart


class Routes {
  // Public
  static const home = '/';
  static const login = '/login';
  static const register = '/register';
  static const forgotPassword = '/forgot-password';
  static const emailVerification = '/email-verification';
  static const resetPassword = '/reset-password';

  static const companyAuth = '/company/auth';

  static const adminLogin = '/admin/login';
  static const adminSetup = '/admin/setup';

  // Student (protected)
  static const dashboard = '/dashboard';
  static const profile = '/profile';
  static const settings = '/settings';
  static const courses = '/courses';
  static const courseDetail = '/courses/:id';
  static const jobs = '/jobs';
  static const jobDetail = '/jobs/:id';
  static const internships = '/internships';
  static const internshipDetail = '/internships/:id';
  static const applications = '/applications';
  static const favorites = '/favorites';
  static const notifications = '/notifications';
  static const leaderboard = '/leaderboard';
  static const pointsSystem = '/points-system';
  static const debug = '/debug';

  // Footer pages (public)
  static const howItWorks = '/how-it-works';
  static const about = '/about';
  static const contact = '/contact';
  static const privacy = '/privacy-policy';
  static const terms = '/terms-of-service';

  // Company (protected)
  static const companyDashboard = '/company/dashboard';
  static const companyRegister = '/company/register';
  static const companyJobs = '/company/jobs';
  static const companyJobsCreate = '/company/jobs/create';
  static const companyJobsEdit = '/company/jobs/:id/edit';
  static const companyJobApplications = '/company/jobs/:id/applications';

  static const companyInternships = '/company/internships';
  static const companyInternshipsCreate = '/company/internships/create';
  static const companyInternshipsEdit = '/company/internships/:id/edit';
  static const companyInternshipApplications = '/company/internships/:id/applications';

  static const companyProfile = '/company/profile';
  static const companyReports = '/company/reports';
  static const companyApplications = '/company/applications';
  static const companyPricing = '/company/pricing';

  // Admin (protected)
  static const adminDashboard = '/admin/dashboard';
  static const adminCompanies = '/admin/companies';
  static const adminUsers = '/admin/users';
  static const adminJobs = '/admin/jobs';
  static const adminSubscriptions = '/admin/subscriptions';
  static const adminReports = '/admin/reports';
  static const adminSettings = '/admin/settings';
  static const adminLogs = '/admin/logs';
  static const adminProfile = '/admin/profile';
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/route_guards.dart


import '../../features/auth/domain/auth_models.dart';
import 'routes.dart';

class RouteGuards {
  // Mirrors React's studentOnlyPaths (including detail pages)
  static const List<String> _studentRoots = [
    Routes.courses,
    Routes.jobs,
    Routes.internships,
    Routes.applications,
    Routes.favorites,
    Routes.notifications,
    Routes.leaderboard,
    Routes.profile,
    Routes.dashboard,
    Routes.settings,
    Routes.debug,
  ];

  static bool isStudentPath(String location) {
    return _studentRoots.any(
      (root) => location == root || location.startsWith('$root/'),
    );
  }

  /// Treat everything under /company as company area.
  static bool isCompanyPath(String location) =>
      location == '/company' || location.startsWith('/company/');

  /// Treat everything under /admin as admin area (safer than enumerating).
  static bool isAdminPath(String location) =>
      location == '/admin' || location.startsWith('/admin/');

  static bool isPublicPath(String location) {
    const publicExact = <String>{
      Routes.home,
      Routes.login,
      Routes.register,
      Routes.forgotPassword,
      Routes.emailVerification,
      Routes.resetPassword, // ✅ deep link recovery must be public

      Routes.companyAuth,

      Routes.adminLogin,
      Routes.adminSetup,

      Routes.howItWorks,
      Routes.about,
      Routes.contact,
      Routes.privacy,
      Routes.terms,

      // React: public
      Routes.pointsSystem,
    };
    return publicExact.contains(location);
  }

  /// Role-based redirects (mirrors GlobalRouteControl + ProtectedRoute behavior)
  static String? redirectForRole({
    required UserType userType,
    required String location,
  }) {
    // Never role-redirect public pages (router handles auth pages separately)
    if (isPublicPath(location)) return null;

    // Admin can access ONLY admin area (recommended)
    if (userType == UserType.admin) {
      if (!isAdminPath(location)) return Routes.adminDashboard;
      return null;
    }

    // Company can access company area, not student/admin
    if (userType == UserType.company) {
      if (isAdminPath(location)) return Routes.companyDashboard;
      if (isStudentPath(location)) return Routes.companyDashboard;
      return null;
    }

    // Student can access student area, not company/admin
    if (userType == UserType.student) {
      if (isAdminPath(location)) return Routes.dashboard;
      if (isCompanyPath(location)) return Routes.dashboard;
      return null;
    }

    // Guest handling is done by router "not authorized" block
    return null;
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/app/app.dart


import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../core/deeplink/deep_link_service.dart';
import '../core/routing/app_router.dart';
import '../core/supabase/supabase_service.dart';

class App extends ConsumerStatefulWidget {
  const App({super.key});

  @override
  ConsumerState<App> createState() => _AppState();
}

class _AppState extends ConsumerState<App> {
  DeepLinkService? _deepLinks;

  @override
  void initState() {
    super.initState();

    final router = ref.read(goRouterProvider);

    _deepLinks = DeepLinkService(
      client: SupabaseService.client,
      router: router,
    );

    unawaited(_deepLinks!.start());
  }

  @override
  void dispose() {
    unawaited(_deepLinks?.stop() ?? Future.value());
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final router = ref.watch(goRouterProvider);

    return MaterialApp.router(
      debugShowCheckedModeBanner: false,
      title: 'Öğrenci Intelligence',
      routerConfig: router,
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/shared/widgets/empty_state.dart


import 'package:flutter/material.dart';

class PlaceholderScreen extends StatelessWidget {
  const PlaceholderScreen({super.key, required this.title, this.subtitle});

  final String title;
  final String? subtitle;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(title, style: Theme.of(context).textTheme.headlineSmall),
                if (subtitle != null) ...[
                  const SizedBox(height: 8),
                  Text(
                    subtitle!,
                    textAlign: TextAlign.center,
                    style: Theme.of(context).textTheme.bodyMedium,
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/domain/auth_models.dart


class CompanyMembership {
  const CompanyMembership({
    required this.companyId,
    required this.role,
  });

  final String companyId;
  final String role;

  factory CompanyMembership.fromJson(Map<String, dynamic> json) {
    return CompanyMembership(
      companyId: json['company_id'].toString(),
      role: (json['role'] ?? '').toString(),
    );
  }
}

enum AppRole { guest, student, company, admin }

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/data/auth_repository.dart


// lib/features/auth/data/auth_repository.dart
import 'package:supabase_flutter/supabase_flutter.dart';
import '../domain/auth_models.dart';

class AuthRepository {
  AuthRepository(this._client);

  final SupabaseClient _client;

  User? get currentUser => _client.auth.currentUser;
  Session? get currentSession => _client.auth.currentSession;

  Stream<AuthState> authStateChanges() => _client.auth.onAuthStateChange;

  Future<User> signIn({
    required String email,
    required String password,
  }) async {
    final res = await _client.auth.signInWithPassword(
      email: email,
      password: password,
    );

    final user = res.user;
    if (user == null) {
      throw const AuthException('Sign-in failed: user is null.');
    }

    // Block if email not confirmed (same as React)
    if (user.emailConfirmedAt == null) {
      await _client.auth.signOut();
      throw const AuthException('Please verify your email address.');
    }

    return user;
  }

  Future<User> signUp({
    required String email,
    required String password,
    required String fullName,
  }) async {
    final res = await _client.auth.signUp(
      email: email,
      password: password,
      data: {'full_name': fullName},
    );

    final user = res.user;
    if (user == null) {
      throw const AuthException('Sign-up failed: user is null.');
    }
    return user;
  }

  Future<void> signOut() => _client.auth.signOut();

  Future<void> resetPassword({
    required String email,
    String? redirectTo,
  }) async {
    await _client.auth.resetPasswordForEmail(email, redirectTo: redirectTo);
  }

  Future<void> updatePassword(String newPassword) async {
    await _client.auth.updateUser(UserAttributes(password: newPassword));
  }

  Future<void> updateProfile(Map<String, dynamic> updates) async {
    await _client.auth.updateUser(UserAttributes(data: updates));
  }

  Future<Session?> refreshSession() async {
    final res = await _client.auth.refreshSession();
    return res.session;
  }

  Future<void> resendSignupOtp({required String email}) async {
    await _client.auth.resend(
      type: OtpType.signup,
      email: email,
    );
  }

  Future<void> upsertStudentProfile({
    required String userId,
    required String email,
    required String fullName,
    required String department,
    required int year,
  }) async {
    await _client.from('profiles').upsert({
      'id': userId,
      'email': email,
      'full_name': fullName,
      'department': department,
      'year': year,
      'updated_at': DateTime.now().toUtc().toIso8601String(),
    });
  }

  Future<CompanyMembership?> fetchCompanyMembership(String userId) async {
    final row = await _client
        .from('company_users')
        .select('company_id, role')
        .eq('user_id', userId)
        .maybeSingle();

    if (row == null) return null;
    return CompanyMembership.fromJson(row);
  }

  Future<User?> getFreshUser() async {
  final res = await _client.auth.getUser();
  return res.user;
}

Future<void> resendSignupVerificationEmail(String email) async {
  await _client.auth.resend(type: OtpType.signup, email: email);
}

}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/controllers/auth_controller.dart


import 'dart:async';
// ✅ for unawaited
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/config/env.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../../../admin/presentation/controllers/admin_controller.dart';
import '../../data/auth_repository.dart';
import '../../domain/auth_models.dart';

class AuthViewState {
  const AuthViewState({
    required this.user,
    required this.session,
    required this.loading,
    required this.userType,
    this.companyId,
    this.companyRole,
  });

  final User? user;
  final Session? session;
  final bool loading;

  final UserType userType;
  final String? companyId;
  final String? companyRole;

  bool get isEmailVerified => user?.emailConfirmedAt != null;

  // ✅ AUTHENTICATED = signed in + verified
  bool get isAuthenticated => user != null && session != null && isEmailVerified;
}

final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository(SupabaseService.client);
});

final authViewStateProvider = StreamProvider<AuthViewState>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  final controller = StreamController<AuthViewState>.broadcast();

  Future<void> emit(Session? session, {required bool loading}) async {
    final user = session?.user;

    // Default state
    UserType userType = UserType.guest;
    String? companyId;
    String? companyRole;

    // If user exists but not verified -> keep as guest (not authenticated)
    final verified = user != null && user.emailConfirmedAt != null;

    if (verified) {
      userType = UserType.student; // ✅ default if verified

      // Admin check (best-effort, must not break auth stream)
      try {
        final admin = await ref.read(activeAdminProvider.future);
        if (admin != null) {
          userType = UserType.admin;
        }
      } catch (_) {
        // ignore: treat as not admin
      }

      // Company membership (best-effort)
      if (userType != UserType.admin) {
        try {
          final membership = await repo.fetchCompanyMembership(user.id);
          if (membership != null) {
            userType = UserType.company;
            companyId = membership.companyId;
            companyRole = membership.role;
          }
        } catch (_) {
          // ignore: treat as student
        }
      }
    }

    // ✅ ALWAYS emit a state (never skip)
    controller.add(
      AuthViewState(
        user: user,
        session: session,
        loading: loading,
        userType: userType,
        companyId: companyId,
        companyRole: companyRole,
      ),
    );
  }
  // initial
  controller.add(const AuthViewState(
    user: null,
    session: null,
    loading: true,
    userType: UserType.guest,
  ));

  unawaited(() async {
    await emit(repo.currentSession, loading: false);
  }());

  final sub = repo.authStateChanges().listen((evt) async {
    try {
      ref.invalidate(activeAdminProvider);
      await emit(evt.session, loading: false);
    } catch (_) {
      // last-resort: still emit minimal state
      controller.add(AuthViewState(
        user: evt.session?.user,
        session: evt.session,
        loading: false,
        userType: UserType.guest,
      ));
    }
  });

  ref.onDispose(() {
    unawaited(sub.cancel());
    unawaited(controller.close());
  });

  return controller.stream;
});

final authActionLoadingProvider =
    StateNotifierProvider<AuthActionController, bool>((ref) {
  return AuthActionController(ref.watch(authRepositoryProvider));
});

class AuthActionController extends StateNotifier<bool> {
  AuthActionController(this._repo) : super(false);
  final AuthRepository _repo;

  Future<String?> signIn(String email, String password) async {
    try {
      state = true;
      await _repo.signIn(email: email, password: password);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signUp(String email, String password, String fullName) async {
    try {
      state = true;
      await _repo.signUp(email: email, password: password, fullName: fullName);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signOut() async {
    try {
      state = true;
      await _repo.signOut();
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> resetPassword(String email) async {
    try {
      state = true;
      await _repo.resetPassword(
        email: email,
        redirectTo: Env.deepLinkResetPassword.toString(),
      );
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> updatePassword(String newPassword) async {
    try {
      state = true;
      await _repo.updatePassword(newPassword);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
android/app/src/main/AndroidManifest.xml

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:label="ogrenci_intelligence"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
            
            <intent-filter android:autoVerify="false">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />

                <data
                    android:scheme="com.ogrenciintelligence"
                    android:host="login-callback" />
                <data 
                    android:scheme="com.ogrenciintelligence" 
                    android:host="reset-password" />
            </intent-filter>

        </activity>
        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
</manifest>
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
ios/Runner/Info.plist

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>CFBundleDevelopmentRegion</key>
	<string>$(DEVELOPMENT_LANGUAGE)</string>
	<key>CFBundleDisplayName</key>
	<string>Ogrenci Intelligence</string>
	<key>CFBundleExecutable</key>
	<string>$(EXECUTABLE_NAME)</string>
	<key>CFBundleIdentifier</key>
	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
	<key>CFBundleInfoDictionaryVersion</key>
	<string>6.0</string>
	<key>CFBundleName</key>
	<string>ogrenci_intelligence</string>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleShortVersionString</key>
	<string>$(FLUTTER_BUILD_NAME)</string>
	<key>CFBundleSignature</key>
	<string>????</string>
	<key>CFBundleVersion</key>
	<string>$(FLUTTER_BUILD_NUMBER)</string>
	<key>LSRequiresIPhoneOS</key>
	<true/>
	<key>UILaunchStoryboardName</key>
	<string>LaunchScreen</string>
	<key>UIMainStoryboardFile</key>
	<string>Main</string>
	<key>UISupportedInterfaceOrientations</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
	<key>UISupportedInterfaceOrientations~ipad</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationPortraitUpsideDown</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
	<key>CADisableMinimumFrameDurationOnPhone</key>
	<true/>
	<key>UIApplicationSupportsIndirectInputEvents</key>
	<true/>
	<key>CFBundleURLTypes</key>
	<array>
	<dict>
		<key>CFBundleURLSchemes</key>
		<array>
		<string>com.ogrenciintelligence</string>
		</array>
	</dict>
	</array>
</dict>
</plist>

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/data/admin_repository.dart


import 'package:supabase_flutter/supabase_flutter.dart';
import '../domain/admin_models.dart';

class AdminRepository {
  AdminRepository(this._client);

  final SupabaseClient _client;

  Future<AdminData?> getActiveAdminByUserId(String userId) async {
    final row = await _client
        .from('admins')
        .select('*')
        .eq('user_id', userId)
        .eq('is_active', true)
        .maybeSingle();

    if (row == null) return null;
    return AdminData.fromJson(row);
  }

  Future<void> logAdminAction({
    required String adminId,
    required String actionType,
    required String targetType,
    String? targetId,
    Map<String, dynamic> details = const {},
  }) async {
    await _client.from('admin_logs').insert({
      'admin_id': adminId,
      'action_type': actionType,
      'target_type': targetType,
      'target_id': targetId,
      'details': details,
      // On mobile, don't pretend we have the public IP.
      'ip_address': null,
    });
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
import 'dart:async';

import 'package:app_links/app_links.dart';
import 'package:flutter/foundation.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class DeepLinkService {
  DeepLinkService(this._client);

  final SupabaseClient _client;
  final AppLinks _appLinks = AppLinks();
  StreamSubscription<Uri>? _sub;

  Future<void> start() async {
    final initial = await _appLinks.getInitialLink(); // app_links 6.x
    if (initial != null) {
      await _handle(initial);
    }

    _sub = _appLinks.uriLinkStream.listen((uri) {
      unawaited(_handle(uri));
    }, onError: (e) {
      if (kDebugMode) {
        // print('Deep link stream error: $e');
      }
    });
  }

  Future<void> stop() async {
    await _sub?.cancel();
    _sub = null;
  }

  Future<void> _handle(Uri uri) async {
    try {
      final s = uri.toString();

      // Only process auth-related links
      final looksAuth = s.contains('access_token=') ||
          s.contains('refresh_token=') ||
          s.contains('type=recovery') ||
          s.contains('code=');

      if (!looksAuth) return;

      await _client.auth.getSessionFromUrl(uri);
    } catch (e) {
      if (kDebugMode) {
        // print('Deep link parse failed: $e');
      }
    }
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/domain/admin_models.dart


class AdminData {
  const AdminData({
    required this.id,
    required this.userId,
    required this.role,
    required this.isActive,
    required this.permissions,
    required this.raw,
  });

  final String id;
  final String userId;
  final String role;
  final bool isActive;
  final Map<String, dynamic> permissions;
  final Map<String, dynamic> raw;

  bool get isSuperAdmin => role == 'super_admin';

  factory AdminData.fromJson(Map<String, dynamic> json) {
    return AdminData(
      id: (json['id'] ?? '').toString(),
      userId: (json['user_id'] ?? '').toString(),
      role: (json['role'] ?? '').toString(),
      isActive: json['is_active'] == true,
      permissions: (json['permissions'] as Map?)?.cast<String, dynamic>() ?? const {},
      raw: json,
    );
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/presentation/controllers/admin_controller.dart


import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/supabase/supabase_service.dart';
import '../../data/admin_repository.dart';
import '../../domain/admin_models.dart';

final adminRepositoryProvider = Provider<AdminRepository>((ref) {
  return AdminRepository(SupabaseService.client);
});

final activeAdminProvider = FutureProvider<AdminData?>((ref) async {
  final User? user = SupabaseService.client.auth.currentUser;
  if (user == null) return null;
  final repo = ref.watch(adminRepositoryProvider);
  return repo.getActiveAdminByUserId(user.id);
});

final isAdminProvider = Provider<bool>((ref) {
  return ref.watch(activeAdminProvider).valueOrNull != null;
});

final isSuperAdminProvider = Provider<bool>((ref) {
  final admin = ref.watch(activeAdminProvider).valueOrNull;
  return admin?.isSuperAdmin ?? false;
});

final adminActionControllerProvider =
    StateNotifierProvider<AdminActionController, bool>((ref) {
  return AdminActionController(ref.watch(adminRepositoryProvider), ref);
});

class AdminActionController extends StateNotifier<bool> {
  AdminActionController(this._repo, this._ref) : super(false);

  final AdminRepository _repo;
  final Ref _ref;

  Future<String?> logAction({
  required String actionType,
  required String targetType,
  String? targetId,
  Map<String, dynamic> details = const {},
}) async {
  try {
    state = true;

    final admin = await _ref.read(activeAdminProvider.future);
    if (admin == null) return 'Not an admin';

    await _repo.logAdminAction(
      adminId: admin.id,
      actionType: actionType,
      targetType: targetType,
      targetId: targetId,
      details: details,
    );
    return null;
  } catch (e) {
    return e.toString();
  } finally {
    state = false;
  }
}
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/domain/auth_models.dart


enum UserType { guest, student, company, admin }

class CompanyMembership {
  const CompanyMembership({
    required this.companyId,
    required this.role,
  });

  final String companyId;
  final String role;

  factory CompanyMembership.fromJson(Map<String, dynamic> json) {
    return CompanyMembership(
      companyId: json['company_id'].toString(),
      role: (json['role'] ?? '').toString(),
    );
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/controllers/auth_controller.dart


// lib/features/auth/presentation/controllers/auth_controller.dart
import 'dart:async';
import 'package:flutter/foundation.dart'; // ✅ for unawaited
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/config/env.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../../../admin/presentation/controllers/admin_controller.dart';
import '../../data/auth_repository.dart';
import '../../domain/auth_models.dart';

class AuthViewState {
  const AuthViewState({
    required this.user,
    required this.session,
    required this.loading,
    required this.userType,
    this.companyId,
    this.companyRole,
  });

  final User? user;
  final Session? session;
  final bool loading;

  final UserType userType;
  final String? companyId;
  final String? companyRole;

  bool get isAuthenticated => user != null; // has session/user
bool get isEmailVerified => user?.emailConfirmedAt != null;
}

final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository(SupabaseService.client);
});

final authViewStateProvider = StreamProvider<AuthViewState>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  final controller = StreamController<AuthViewState>.broadcast();

  Future<void> emit(Session? session, {required bool loading}) async {
    final user = session?.user;

    UserType userType = UserType.guest;
    String? companyId;
    String? companyRole;

    if (user != null && user.emailConfirmedAt != null) {
      // Admin has priority
      final admin = await ref.read(activeAdminProvider.future);
      if (admin != null) {
        userType = UserType.admin;
      } else {
        final membership = await repo.fetchCompanyMembership(user.id);
        if (membership != null) {
          userType = UserType.company;
          companyId = membership.companyId;
          companyRole = membership.role;
        } else {
          userType = UserType.student;
        }
      }
    }

    controller.add(
      AuthViewState(
        user: user,
        session: session,
        loading: loading,
        userType: userType,
        companyId: companyId,
        companyRole: companyRole,
      ),
    );
  }

  // initial
  controller.add(const AuthViewState(
    user: null,
    session: null,
    loading: true,
    userType: UserType.guest,
  ));

  unawaited(() async {
    await emit(repo.currentSession, loading: false);
  }());

  final sub = repo.authStateChanges().listen((evt) async {
    ref.invalidate(activeAdminProvider);
    await emit(evt.session, loading: false);
  });

  ref.onDispose(() {
    unawaited(sub.cancel());
    unawaited(controller.close());
  });

  return controller.stream;
});

final authActionLoadingProvider =
    StateNotifierProvider<AuthActionController, bool>((ref) {
  return AuthActionController(ref.watch(authRepositoryProvider));
});

class AuthActionController extends StateNotifier<bool> {
  AuthActionController(this._repo) : super(false);
  final AuthRepository _repo;

  Future<String?> signIn(String email, String password) async {
    try {
      state = true;
      await _repo.signIn(email: email, password: password);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signUp(String email, String password, String fullName) async {
    try {
      state = true;
      await _repo.signUp(email: email, password: password, fullName: fullName);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signOut() async {
    try {
      state = true;
      await _repo.signOut();
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> resetPassword(String email) async {
    try {
      state = true;
      await _repo.resetPassword(
        email: email,
        redirectTo: Env.deepLinkResetPassword.toString(),
      );
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> updatePassword(String newPassword) async {
    try {
      state = true;
      await _repo.updatePassword(newPassword);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/reset_password_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../controllers/auth_controller.dart';

class ResetPasswordScreen extends ConsumerStatefulWidget {
  const ResetPasswordScreen({super.key});

  @override
  ConsumerState<ResetPasswordScreen> createState() => _ResetPasswordScreenState();
}

class _ResetPasswordScreenState extends ConsumerState<ResetPasswordScreen> {
  final _password = TextEditingController();

  @override
  void dispose() {
    _password.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Reset Password')),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _password,
              obscureText: true,
              decoration: const InputDecoration(
                labelText: 'New password',
              ),
            ),
            const SizedBox(height: 12),
            ElevatedButton(
              onPressed: busy
                  ? null
                  : () async {
                      final err = await ref
                          .read(authActionLoadingProvider.notifier)
                          .updatePassword(_password.text.trim());
                      if (!context.mounted) return;

                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(content: Text(err ?? 'Password updated')),
                      );
                    },
              child: busy
                  ? const SizedBox(
                      height: 18,
                      width: 18,
                      child: CircularProgressIndicator(strokeWidth: 2),
                    )
                  : const Text('Update'),
            ),
          ],
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/company/data/company_repository.dart


import 'package:supabase_flutter/supabase_flutter.dart';

class CompanyRepository {
  CompanyRepository(this._client);

  final SupabaseClient _client;

  /// Returns membership if the current user belongs to a company.
  /// Mirrors React: supabase.from("company_users").select("company_id, role").eq("user_id", user.id).maybeSingle()
  Future<({String companyId, String role})?> getMembershipByUserId(String userId) async {
    final row = await _client
        .from('company_users')
        .select('company_id, role')
        .eq('user_id', userId)
        .maybeSingle();

    if (row == null) return null;

    return (
      companyId: row['company_id'].toString(),
      role: (row['role'] ?? '').toString(),
    );
  }

  /// Optional: get company basic profile (we'll expand later based on your DB schema).
  Future<Map<String, dynamic>?> getCompanyById(String companyId) async {
    final row = await _client
        .from('companies')
        .select('*')
        .eq('id', companyId)
        .maybeSingle();
    return row;
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/login_screen.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../controllers/auth_controller.dart';

class LoginScreen extends ConsumerStatefulWidget {
  const LoginScreen({super.key, this.from});

  final String? from;

  @override
  ConsumerState<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends ConsumerState<LoginScreen> {
  final _email = TextEditingController();
  final _password = TextEditingController();
  bool _showPassword = false;
  bool _rememberMe = false;
  String? _error;

  @override
  void dispose() {
    _email.dispose();
    _password.dispose();
    super.dispose();
  }

  /// React-parity:
  /// - If redirected to /login?from=..., after login go back to that exact location.
  /// - If missing/invalid, go to student default: /dashboard
  /// - Prevent external redirects + auth-page loops
  String _resolveFromTarget() {
    final raw = widget.from?.trim();
    if (raw == null || raw.isEmpty) return Routes.dashboard;

    String decoded;
    try {
      decoded = Uri.decodeComponent(raw);
    } catch (_) {
      return Routes.dashboard;
    }

    // Must be an internal absolute path.
    if (!decoded.startsWith('/')) return Routes.dashboard;

    final uri = Uri.tryParse(decoded);
    if (uri == null) return Routes.dashboard;

    // Block external redirects
    if (uri.hasScheme || uri.hasAuthority) return Routes.dashboard;

    // Avoid loops back into auth pages
    const blocked = <String>{
      Routes.login,
      Routes.register,
      Routes.forgotPassword,
      Routes.emailVerification,
      Routes.companyAuth,
      Routes.companyRegister,
      Routes.adminLogin,
      Routes.adminSetup,
    };

    if (blocked.contains(uri.path)) return Routes.dashboard;

    // Preserve path + query exactly
    return uri.toString();
  }

Future<void> _submit() async {
  setState(() => _error = null);

  final email = _email.text.trim();
  final pass = _password.text;

  if (email.isEmpty || pass.isEmpty) {
    setState(() => _error = 'Please fill in all fields.');
    return;
  }

  final err = await ref
      .read(authActionLoadingProvider.notifier)
      .signIn(email, pass);

  if (!mounted) return;

  if (err != null) {
    setState(() => _error = err);
    return;
  }

  // ✅ If auth state is already updated, navigate immediately.
  final current = ref.read(authViewStateProvider).valueOrNull;
  if (current?.isAuthenticated == true) {
    context.go(_resolveFromTarget());
    return;
  }

  // ✅ Otherwise wait a bit for the auth stream to emit (but never hang forever).
  try {
    await ref
        .read(authViewStateProvider.stream)
        .firstWhere((s) => s.isAuthenticated)
        .timeout(const Duration(seconds: 2));
  } catch (_) {
    // ignore timeout; router redirect will handle if needed
  }

  if (!mounted) return;
  context.go(_resolveFromTarget());
}

  @override
  Widget build(BuildContext context) {
    
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.lock_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Welcome back',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'Student login',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.mail_outline),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _password,
                      obscureText: !_showPassword,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        prefixIcon: const Icon(Icons.lock_outline),
                        suffixIcon: IconButton(
                          onPressed: () =>
                              setState(() => _showPassword = !_showPassword),
                          icon: Icon(
                            _showPassword ? Icons.visibility_off : Icons.visibility,
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Checkbox(
                          value: _rememberMe,
                          onChanged: (v) =>
                              setState(() => _rememberMe = v ?? false),
                        ),
                        const Text('Remember me'),
                        const Spacer(),
                        TextButton(
                          onPressed: () => context.push(Routes.forgotPassword),
                          child: const Text('Forgot password?'),
                        ),
                      ],
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(
                          _error!,
                          style: const TextStyle(color: Colors.red),
                        ),
                      ),
                    ],

                    const SizedBox(height: 14),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Login'),
                    ),

                    const SizedBox(height: 14),
                    const Divider(),
                    const SizedBox(height: 10),

                    OutlinedButton(
                      onPressed: () => context.push(Routes.companyAuth),
                      child: const Text('Login as company'),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text('No account? '),
                        TextButton(
                          onPressed: () => context.push(Routes.register),
                          child: const Text('Register'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/features/auth/presentation/screens/register_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../controllers/auth_controller.dart';

class RegisterScreen extends ConsumerStatefulWidget {
  const RegisterScreen({super.key});

  @override
  ConsumerState<RegisterScreen> createState() => _RegisterScreenState();
}

class _RegisterScreenState extends ConsumerState<RegisterScreen> {
  final _fullName = TextEditingController();
  final _email = TextEditingController();
  final _password = TextEditingController();
  final _confirm = TextEditingController();

  bool _showPassword = false;
  bool _acceptTerms = false;

  String? _department;
  int? _year;

  String? _error;

  static const departments = [
    "Bilgisayar Mühendisliği",
    "Yazılım Mühendisliği",
    "Elektrik-Elektronik Mühendisliği",
    "Endüstri Mühendisliği",
    "Makine Mühendisliği",
    "İnşaat Mühendisliği",
    "Mimarlık",
    "İşletme",
    "İktisat",
    "Hukuk",
    "Tıp",
    "Diş Hekimliği",
    "Eczacılık",
    "Hemşirelik",
    "Psikoloji",
    "Öğretmenlik",
    "İletişim",
    "Güzel Sanatlar",
    "Diğer",
  ];

  @override
  void dispose() {
    _fullName.dispose();
    _email.dispose();
    _password.dispose();
    _confirm.dispose();
    super.dispose();
  }

  bool _validate() {
    setState(() => _error = null);

    if (_password.text != _confirm.text) {
      setState(() => _error = 'Passwords do not match.');
      return false;
    }
    if (_password.text.length < 6) {
      setState(() => _error = 'Password must be at least 6 characters.');
      return false;
    }
    if (_department == null) {
      setState(() => _error = 'Please select your department.');
      return false;
    }
    if (_year == null) {
      setState(() => _error = 'Please select your year.');
      return false;
    }
    if (!_acceptTerms) {
      setState(() => _error = 'You must accept Terms & Privacy.');
      return false;
    }
    return true;
  }

  Future<void> _submit() async {
    if (!_validate()) return;

    final email = _email.text.trim();
    final pass = _password.text;
    final fullName = _fullName.text.trim();

    final err = await ref
        .read(authActionLoadingProvider.notifier)
        .signUp(email, pass, fullName);

    if (!mounted) return;

    if (err != null) {
      setState(() => _error = err);
      return;
    }

    // Try to update profile (same as React). Ignore errors if RLS blocks it.
    try {
      final user = SupabaseService.client.auth.currentUser;
      if (user != null) {
      await SupabaseService.client.from('profiles').upsert({
        'id': user.id,
        'full_name': fullName,
        'department': _department,
        'year': _year,
        'email': email,
        'updated_at': DateTime.now().toUtc().toIso8601String(),
      });
      }
    } catch (_) {
      // ignore
    }

    // Professional flow: show email verification page, with email hint
    final uri = Uri(
      path: Routes.emailVerification,
      queryParameters: {'email': email},
    ).toString();

    context.go(uri);
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Register')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.person_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Create your account',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'Student registration',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _fullName,
                      decoration: const InputDecoration(
                        labelText: 'Full name',
                        prefixIcon: Icon(Icons.badge_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.mail_outline),
                      ),
                    ),
                    const SizedBox(height: 12),

                    DropdownButtonFormField<String>(
                      initialValue: _department,
                      items: departments
                          .map((d) => DropdownMenuItem(value: d, child: Text(d)))
                          .toList(),
                      onChanged: (v) => setState(() => _department = v),
                      decoration: const InputDecoration(
                        labelText: 'Department',
                        prefixIcon: Icon(Icons.school_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    DropdownButtonFormField<int>(
                      initialValue: _year,
                      items: const [1, 2, 3, 4, 5]
                          .map((y) => DropdownMenuItem(
                                value: y,
                                child: Text(y == 5 ? '5+ (and above)' : '$y'),
                              ))
                          .toList(),
                      onChanged: (v) => setState(() => _year = v),
                      decoration: const InputDecoration(
                        labelText: 'Year',
                        prefixIcon: Icon(Icons.calendar_today_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _password,
                      obscureText: !_showPassword,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        prefixIcon: const Icon(Icons.lock_outline),
                        suffixIcon: IconButton(
                          onPressed: () => setState(() => _showPassword = !_showPassword),
                          icon: Icon(_showPassword ? Icons.visibility_off : Icons.visibility),
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _confirm,
                      obscureText: !_showPassword,
                      decoration: const InputDecoration(
                        labelText: 'Confirm password',
                        prefixIcon: Icon(Icons.lock_outline),
                      ),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Checkbox(
                          value: _acceptTerms,
                          onChanged: (v) => setState(() => _acceptTerms = v ?? false),
                        ),
                        Expanded(
                          child: Padding(
                            padding: const EdgeInsets.only(top: 10),
                            child: Wrap(
                              children: [
                                const Text('I accept '),
                                GestureDetector(
                                  onTap: () => context.push(Routes.terms),
                                  child: Text(
                                    'Terms of Service',
                                    style: TextStyle(
                                      color: Theme.of(context).colorScheme.primary,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                                const Text(' and '),
                                GestureDetector(
                                  onTap: () => context.push(Routes.privacy),
                                  child: Text(
                                    'Privacy Policy',
                                    style: TextStyle(
                                      color: Theme.of(context).colorScheme.primary,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                                const Text('.'),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(_error!, style: const TextStyle(color: Colors.red)),
                      ),
                    ],

                    const SizedBox(height: 14),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Register'),
                    ),

                    const SizedBox(height: 14),
                    const Divider(),
                    const SizedBox(height: 10),

                    OutlinedButton(
                      onPressed: () => context.push(Routes.companyAuth),
                      child: const Text('Register as company'),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text('Already have an account? '),
                        TextButton(
                          onPressed: () => context.go(Routes.login),
                          child: const Text('Login'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/features/auth/presentation/screens/forgot_password_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../../../../core/routing/routes.dart';
import '../controllers/auth_controller.dart';

class ForgotPasswordScreen extends ConsumerStatefulWidget {
  const ForgotPasswordScreen({super.key});

  @override
  ConsumerState<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends ConsumerState<ForgotPasswordScreen> {
  final _email = TextEditingController();
  bool _submitted = false;
  String? _error;

  @override
  void dispose() {
    _email.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    setState(() => _error = null);

    final email = _email.text.trim();
    if (email.isEmpty) return;

    final err = await ref.read(authActionLoadingProvider.notifier).resetPassword(email);

    if (!mounted) return;

    if (err != null) {
      setState(() => _error = err);
    } else {
      setState(() => _submitted = true);
    }
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    if (_submitted) {
      return Scaffold(
        appBar: AppBar(title: const Text('Forgot Password')),
        body: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 520),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Card(
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Icon(Icons.check_circle_outline, size: 54),
                      const SizedBox(height: 12),
                      Text(
                        'Email sent!',
                        style: Theme.of(context).textTheme.titleLarge?.copyWith(
                              fontWeight: FontWeight.w700,
                            ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'A password reset link was sent to:\n${_email.text.trim()}',
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.amber.withOpacity(0.15),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.amber.withOpacity(0.35)),
                        ),
                        child: const Text(
                          'If you don’t see it, check your spam/junk folder.',
                          textAlign: TextAlign.center,
                        ),
                      ),
                      const SizedBox(height: 14),
                      TextButton(
                        onPressed: () => Navigator.of(context).pushNamed(Routes.login),
                        child: const Text('Back to Login'),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ),
      );
    }

    return Scaffold(
      appBar: AppBar(title: const Text('Forgot Password')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.mail_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Reset your password',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'We will send a reset link to your email.',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.alternate_email),
                      ),
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(
                          _error!,
                          style: const TextStyle(color: Colors.red),
                        ),
                      ),
                    ],

                    const SizedBox(height: 16),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Send reset link'),
                    ),

                    const SizedBox(height: 10),

                    TextButton.icon(
                      onPressed: () => Navigator.of(context).pushNamed(Routes.login),
                      icon: const Icon(Icons.arrow_back),
                      label: const Text('Back to Login'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/app_router.dart

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../features/auth/domain/auth_models.dart';
import '../../features/auth/presentation/controllers/auth_controller.dart';
import '../../features/auth/presentation/screens/company_auth_screen.dart';
import '../../features/auth/presentation/screens/email_verification_screen.dart';
import '../../features/auth/presentation/screens/forgot_password_screen.dart';
import '../../features/auth/presentation/screens/login_screen.dart';
import '../../features/auth/presentation/screens/register_screen.dart';
import '../../features/auth/presentation/screens/reset_password_screen.dart';
import '../../features/courses/presentation/screens/course_detail_screen.dart';
import '../../features/courses/presentation/screens/courses_screen.dart';
import '../../features/home/presentation/screens/home_screen.dart';
import '../../features/student_dashboard/presentation/screens/student_dashboard_screen.dart';
import '../../shared/widgets/app_navbar.dart';
import '../../shared/widgets/empty_state.dart';
import 'route_guards.dart';
import 'routes.dart';

final goRouterProvider = Provider<GoRouter>((ref) {
  final authStream = ref.watch(authViewStateProvider.stream);

  // ✅ IMPORTANT (Web): use the real browser URL, not defaultRouteName "/"
  final String initialLocation = () {
    if (kIsWeb) {
      final base = Uri.base;

      // Keep full path + query (React-like behavior)
      var loc = base.path;
      if (loc.isEmpty) loc = Routes.home;
      if (!loc.startsWith('/')) loc = '/$loc';

      if (base.hasQuery) loc = '$loc?${base.query}';
      return loc;
    }

    // Mobile/desktop: platform initial route name is fine
    final initial = WidgetsBinding.instance.platformDispatcher.defaultRouteName;
    return initial.isEmpty ? Routes.home : initial;
  }();

  return GoRouter(
    initialLocation: initialLocation,
    refreshListenable: GoRouterRefreshStream(authStream),

    redirect: (context, state) {
      final location = state.uri.path;

      final authAsync = ref.read(authViewStateProvider);
      if (authAsync.isLoading) return null;

      final auth = authAsync.value;
      if (auth == null) return null;

      // ✅ Always allow reset-password (deep-link recovery flow)
      if (location == Routes.resetPassword) return null;

      final isAuthorized = auth.isAuthenticated;

      // 1) Not authorized: allow only public routes
      if (!isAuthorized) {
        if (RouteGuards.isPublicPath(location)) return null;

        // Preserve "from" like React (login then come back)
        final from = Uri.encodeComponent(state.uri.toString());
        return '${Routes.login}?from=$from';
      }

      // 2) Authorized: role-based protection (protected areas)
      final roleRedirect = RouteGuards.redirectForRole(
        userType: auth.userType,
        location: location,
      );
      if (roleRedirect != null) return roleRedirect;

      // 3) Keep authenticated users out of auth pages
      const authPages = <String>{
        Routes.login,
        Routes.register,
        Routes.forgotPassword,
        Routes.emailVerification,
        Routes.companyAuth,
        Routes.companyRegister,
        Routes.adminLogin,
        Routes.adminSetup,
      };

      if (authPages.contains(location)) {
        if (auth.userType == UserType.admin) return Routes.adminDashboard;
        if (auth.userType == UserType.company) return Routes.companyDashboard;
        return Routes.dashboard;
      }

      // 4) Optional: redirect "/" for admin/company (students can see home)
      if (location == Routes.home) {
        if (auth.userType == UserType.admin) return Routes.adminDashboard;
        if (auth.userType == UserType.company) return Routes.companyDashboard;
      }

      return null;
    },

    routes: [
      // -----------------------------
      // Admin auth routes (standalone)
      // -----------------------------
      GoRoute(
        path: Routes.adminLogin,
        builder: (_, __) =>
            const PlaceholderScreen(title: 'Admin Login', showAppBar: true),
      ),
      GoRoute(
        path: Routes.adminSetup,
        builder: (_, __) =>
            const PlaceholderScreen(title: 'Admin Setup', showAppBar: true),
      ),

      // -------------
      // Admin shell
      // -------------
      ShellRoute(
        builder: (context, state, child) => AdminShell(child: child),
        routes: [
          GoRoute(
            path: Routes.adminDashboard,
            builder: (_, __) => const PlaceholderView(title: 'Admin Dashboard'),
          ),
          GoRoute(
            path: Routes.adminCompanies,
            builder: (_, __) => const PlaceholderView(title: 'Admin Companies'),
          ),
          GoRoute(
            path: Routes.adminUsers,
            builder: (_, __) => const PlaceholderView(title: 'Admin Users'),
          ),
          GoRoute(
            path: Routes.adminJobs,
            builder: (_, __) => const PlaceholderView(title: 'Admin Jobs'),
          ),
          GoRoute(
            path: Routes.adminSubscriptions,
            builder: (_, __) =>
                const PlaceholderView(title: 'Admin Subscriptions'),
          ),
          GoRoute(
            path: Routes.adminReports,
            builder: (_, __) => const PlaceholderView(title: 'Admin Reports'),
          ),
          GoRoute(
            path: Routes.adminSettings,
            builder: (_, __) => const PlaceholderView(title: 'Admin Settings'),
          ),
          GoRoute(
            path: Routes.adminLogs,
            builder: (_, __) => const PlaceholderView(title: 'Admin Logs'),
          ),
          GoRoute(
            path: Routes.adminProfile,
            builder: (_, __) => const PlaceholderView(title: 'Admin Profile'),
          ),
        ],
      ),

      // -----------------------------
      // Main shell (public + student + company)
      // -----------------------------
      ShellRoute(
        builder: (context, state, child) => MainShell(child: child),
        routes: [
          // Public
          GoRoute(
            path: Routes.home,
            builder: (_, __) => const HomeScreen(),
          ),

          // Auth screens
          GoRoute(
            path: Routes.login,
            builder: (context, state) => LoginScreen(
              from: state.uri.queryParameters['from'],
            ),
          ),
          GoRoute(
            path: Routes.register,
            builder: (_, __) => const RegisterScreen(),
          ),
          GoRoute(
            path: Routes.forgotPassword,
            builder: (_, __) => const ForgotPasswordScreen(),
          ),
          GoRoute(
            path: Routes.emailVerification,
            builder: (context, state) => EmailVerificationScreen(
              emailHint: state.uri.queryParameters['email'],
            ),
          ),
          GoRoute(
            path: Routes.resetPassword,
            builder: (_, __) => const ResetPasswordScreen(),
          ),

          // Company auth
          GoRoute(
            path: Routes.companyAuth,
            builder: (_, __) => const CompanyAuthScreen(),
          ),
          GoRoute(
            path: Routes.companyRegister,
            builder: (_, __) => const CompanyAuthScreen(initialIsLogin: false),
          ),

           GoRoute(
            path: Routes.dashboard,
            builder: (context, state) => const StudentDashboardScreen(),
          ),

          // Footer pages (public)
          GoRoute(
            path: Routes.howItWorks,
            builder: (_, __) => const PlaceholderView(title: 'How It Works'),
          ),
          GoRoute(
            path: Routes.about,
            builder: (_, __) => const PlaceholderView(title: 'About'),
          ),
          GoRoute(
            path: Routes.contact,
            builder: (_, __) => const PlaceholderView(title: 'Contact'),
          ),
          GoRoute(
            path: Routes.privacy,
            builder: (_, __) => const PlaceholderView(title: 'Privacy Policy'),
          ),
          GoRoute(
            path: Routes.terms,
            builder: (_, __) => const PlaceholderView(title: 'Terms of Service'),
          ),
          GoRoute(
            path: Routes.pointsSystem,
            builder: (_, __) => const PlaceholderView(title: 'Points System'),
          ),
          GoRoute(
            path: Routes.profile,
            builder: (_, __) => const PlaceholderView(title: 'Profile'),
          ),
          GoRoute(
            path: Routes.settings,
            builder: (_, __) => const PlaceholderView(title: 'Settings'),
          ),
          GoRoute(
            path: Routes.courses,
            builder: (_, __) => const CoursesScreen(),
          ),
          GoRoute(
            path: Routes.courseDetail,
            builder: (_, state) {
              final id = state.pathParameters['id']!;
              return CourseDetailScreen(courseId: id);
            },
          ),
          GoRoute(
            path: Routes.jobs,
            builder: (_, __) => const PlaceholderView(title: 'Jobs'),
          ),
          GoRoute(
            path: Routes.jobDetail,
            builder: (_, s) => PlaceholderView(
              title: 'Job Detail',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.internships,
            builder: (_, __) => const PlaceholderView(title: 'Internships'),
          ),
          GoRoute(
            path: Routes.internshipDetail,
            builder: (_, s) => PlaceholderView(
              title: 'Internship Detail',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.applications,
            builder: (_, __) => const PlaceholderView(title: 'Applications'),
          ),
          GoRoute(
            path: Routes.favorites,
            builder: (_, __) => const PlaceholderView(title: 'Favorites'),
          ),
          GoRoute(
            path: Routes.notifications,
            builder: (_, __) => const PlaceholderView(title: 'Notifications'),
          ),
          GoRoute(
            path: Routes.leaderboard,
            builder: (_, __) => const PlaceholderView(title: 'Leaderboard'),
          ),
          GoRoute(
            path: Routes.debug,
            builder: (_, __) => const PlaceholderView(title: 'Database Debug'),
          ),

          // Company protected
          GoRoute(
            path: Routes.companyDashboard,
            builder: (_, __) => const PlaceholderView(title: 'Company Dashboard'),
          ),
          GoRoute(
            path: Routes.companyJobs,
            builder: (_, __) => const PlaceholderView(title: 'Company Jobs'),
          ),
          GoRoute(
            path: Routes.companyJobsCreate,
            builder: (_, __) => const PlaceholderView(title: 'Create Job'),
          ),
          GoRoute(
            path: Routes.companyJobsEdit,
            builder: (_, s) => PlaceholderView(
              title: 'Edit Job',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyJobApplications,
            builder: (_, s) => PlaceholderView(
              title: 'Job Applications',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyInternships,
            builder: (_, __) =>
                const PlaceholderView(title: 'Internship Management'),
          ),
          GoRoute(
            path: Routes.companyInternshipsCreate,
            builder: (_, __) => const PlaceholderView(title: 'Create Internship'),
          ),
          GoRoute(
            path: Routes.companyInternshipsEdit,
            builder: (_, s) => PlaceholderView(
              title: 'Edit Internship',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyInternshipApplications,
            builder: (_, s) => PlaceholderView(
              title: 'Internship Applications',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyProfile,
            builder: (_, __) => const PlaceholderView(title: 'Company Profile'),
          ),
          GoRoute(
            path: Routes.companyReports,
            builder: (_, __) => const PlaceholderView(title: 'Reports'),
          ),
          GoRoute(
            path: Routes.companyApplications,
            builder: (_, __) =>
                const PlaceholderView(title: 'Company Applications'),
          ),
          GoRoute(
            path: Routes.companyPricing,
            builder: (_, __) => const PlaceholderView(title: 'Pricing'),
          ),
        ],
      ),
    ],

    errorBuilder: (_, state) => PlaceholderScreen(
      title: '404',
      subtitle: state.error?.toString(),
      showAppBar: true,
    ),
  );
});

class GoRouterRefreshStream extends ChangeNotifier {
  GoRouterRefreshStream(Stream<dynamic> stream) {
    _sub = stream.listen((_) => notifyListeners());
  }

  late final StreamSubscription _sub;

  @override
  void dispose() {
    _sub.cancel();
    super.dispose();
  }
}

/// Main Shell (React-like Navbar + Footer)
class MainShell extends StatelessWidget {
  const MainShell({super.key, required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      // ✅ No AppBar (we reproduce React navbar)
      body: Column(
        children: [
          const AppNavbar(), // sticky-like top
          Expanded(child: child),
          const _Footer(),
        ],
      ),
    );
  }
}

/// Admin Shell (temporary)
class AdminShell extends StatelessWidget {
  const AdminShell({super.key, required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Admin')),
      body: child,
    );
  }
}

class _Footer extends StatelessWidget {
  const _Footer();

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      top: false,
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Text(
          '© ${DateTime.now().year} Öğrenci Intelligence',
          style: Theme.of(context).textTheme.bodySmall,
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/core/deeplink/deep_link_service.dart

// lib/src/core/deeplink/deep_link_service.dart
import 'dart:async';

import 'package:app_links/app_links.dart';
import 'package:flutter/foundation.dart';
import 'package:go_router/go_router.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../config/env.dart';
import '../routing/routes.dart';

class DeepLinkService {
  DeepLinkService({SupabaseClient? client, GoRouter? router})
      : _client = client ?? Supabase.instance.client,
        _router = router;

  final SupabaseClient _client;
  final GoRouter? _router;

  final AppLinks _appLinks = AppLinks();
  StreamSubscription<Uri>? _sub;

  /// Start listening to deep links.
  /// app_links ^6.x: `uriLinkStream` emits the initial link + subsequent links.
  Future<void> start() async {
    if (_sub != null) return;

    _sub = _appLinks.uriLinkStream.listen(
      (uri) => unawaited(_handle(uri)),
      onError: (e) {
        if (kDebugMode) debugPrint('DeepLink stream error: $e');
      },
    );
  }

  /// Stop listening (matches how you call it from app.dart)
  Future<void> stop() async {
    await _sub?.cancel();
    _sub = null;
  }

  bool _shouldHandle(Uri uri) {
    if (uri.scheme != Env.deepLinkScheme) return false;
    return uri.host == 'login-callback' || uri.host == 'reset-password';
  }

  Future<void> _handle(Uri uri) async {
    if (!_shouldHandle(uri)) return;

    if (kDebugMode) debugPrint('DeepLink received: $uri');

    // 1) Let Supabase parse tokens & establish session (recovery/login callback)
    try {
      await _client.auth.getSessionFromUrl(uri);
    } catch (e) {
      if (kDebugMode) debugPrint('getSessionFromUrl error: $e');
    }

    // 2) Reproduce React behavior: open the correct screen
    // - reset-password deep link should land on /reset-password
    // - login-callback can land on / and redirects will take over
    if (_router != null) {
      await Future.microtask(() {
        if (uri.host == 'reset-password') {
          _router.go(Routes.resetPassword);
        } else if (uri.host == 'login-callback') {
          _router.go(Routes.home);
        }
      });
    }
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/email_verification_screen.dart

import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../controllers/auth_controller.dart';

class EmailVerificationScreen extends ConsumerStatefulWidget {
  const EmailVerificationScreen({super.key, this.emailHint});

  /// If user session is null (e.g., signUp returns no session),
  /// we still show the email and allow "resend" using this.
  final String? emailHint;

  @override
  ConsumerState<EmailVerificationScreen> createState() =>
      _EmailVerificationScreenState();
}

class _EmailVerificationScreenState extends ConsumerState<EmailVerificationScreen> {
  Timer? _timer;
  int _countdown = 0;

  bool _resending = false;
  bool _checking = false;

  @override
  void dispose() {
    _timer?.cancel();
    super.dispose();
  }

  void _startCountdown(int seconds) {
    _timer?.cancel();
    setState(() => _countdown = seconds);

    _timer = Timer.periodic(const Duration(seconds: 1), (t) {
      if (!mounted) return;
      if (_countdown <= 1) {
        t.cancel();
        setState(() => _countdown = 0);
      } else {
        setState(() => _countdown -= 1);
      }
    });
  }

  String? _emailToShow() {
    final auth = ref.watch(authViewStateProvider).value;
    return auth?.user?.email ?? widget.emailHint;
  }

  Future<void> _resend() async {
    final email = _emailToShow();
    if (email == null || email.trim().isEmpty) {
      _snack('Email not found. Please login again.', isError: true);
      return;
    }

    if (_countdown > 0 || _resending) return;

    setState(() => _resending = true);
    try {
      // Supabase resend signup verification email
      await SupabaseService.client.auth.resend(
        type: OtpType.signup,
        email: email.trim(),
      );

      _snack('Verification email sent again.');
      _startCountdown(60);
    } catch (e) {
      _snack('Failed to resend email: $e', isError: true);
    } finally {
      if (mounted) setState(() => _resending = false);
    }
  }

  Future<void> _check() async {
    final auth = ref.watch(authViewStateProvider).value;
    final user = auth?.user;

    // If no session/user, we cannot call getUser() reliably.
    if (user == null) {
      _snack('Please login again after verifying your email.', isError: true);
      return;
    }

    if (_checking) return;

    setState(() => _checking = true);
    try {
      final res = await SupabaseService.client.auth.getUser();
      final updated = res.user;

      if (updated?.emailConfirmedAt != null) {
        _snack('Email verified successfully!');
        if (!mounted) return;

        // React goes to /profile
        // Guards will redirect if company/admin.
        // ignore: use_build_context_synchronously
        Navigator.of(context).popUntil((route) => route.isFirst);
        // Better with GoRouter, but keep this screen self-contained.
        // Your router will handle redirect from home -> role dashboard.
      } else {
        _snack('Email not verified yet.', isError: true);
      }
    } catch (e) {
      _snack('Verification check failed: $e', isError: true);
    } finally {
      if (mounted) setState(() => _checking = false);
    }
  }

  void _snack(String msg, {bool isError = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: isError ? Colors.red : null,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final auth = ref.watch(authViewStateProvider).value;
    final email = _emailToShow() ?? '—';
    final hasUser = auth?.user != null;

    return Scaffold(
      appBar: AppBar(title: const Text('Email Verification')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              elevation: 2,
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    const SizedBox(height: 6),
                    Center(
                      child: Container(
                        width: 84,
                        height: 84,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.secondaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.mail_outline,
                          size: 42,
                          color: Theme.of(context).colorScheme.onSecondaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Email verification pending',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'To activate your account, please verify your email address.',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 16),

                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Theme.of(context).colorScheme.primaryContainer,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Text(
                        'Verification link sent to: $email',
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                            ),
                      ),
                    ),

                    const SizedBox(height: 18),
                    _StepTile(
                      index: 1,
                      title: 'Check your inbox',
                      subtitle: 'The verification email should arrive in a few minutes.',
                    ),
                    _StepTile(
                      index: 2,
                      title: 'Click the verification link',
                      subtitle: 'Open the email and confirm your account.',
                    ),
                    _StepTile(
                      index: 3,
                      title: 'Return to the app',
                      subtitle: 'After verification, you can access all features.',
                    ),

                    const SizedBox(height: 16),

                    ElevatedButton.icon(
                      onPressed: (_checking || !hasUser) ? null : _check,
                      icon: _checking
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Icon(Icons.verified_outlined),
                      label: Text(_checking ? 'Checking...' : 'I verified my email'),
                    ),

                    const SizedBox(height: 10),

                    OutlinedButton.icon(
                      onPressed: (_resending || _countdown > 0) ? null : _resend,
                      icon: _resending
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Icon(Icons.refresh),
                      label: Text(
                        _resending
                            ? 'Sending...'
                            : _countdown > 0
                                ? 'Resend ($_countdown s)'
                                : 'Resend email',
                      ),
                    ),

                    const SizedBox(height: 14),

                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.amber.withOpacity(0.15),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: Colors.amber.withOpacity(0.35)),
                      ),
                      child: const Text(
                        'Didn’t receive the email? Check spam/junk, or try resending.',
                        style: TextStyle(fontSize: 13),
                      ),
                    ),

                    const SizedBox(height: 16),

                    TextButton(
                      onPressed: () {
                        // Use GoRouter if available
                        // ignore: use_build_context_synchronously
                        Navigator.of(context).pushNamed(Routes.login);
                      },
                      child: const Text('Login with a different account'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _StepTile extends StatelessWidget {
  const _StepTile({
    required this.index,
    required this.title,
    required this.subtitle,
  });

  final int index;
  final String title;
  final String subtitle;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(top: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.primaryContainer,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: Text(
                '$index',
                style: TextStyle(
                  fontWeight: FontWeight.w700,
                  color: Theme.of(context).colorScheme.onPrimaryContainer,
                ),
              ),
            ),
          ),
          const SizedBox(width: 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title,
                    style: Theme.of(context)
                        .textTheme
                        .titleSmall
                        ?.copyWith(fontWeight: FontWeight.w700)),
                const SizedBox(height: 2),
                Text(subtitle, style: Theme.of(context).textTheme.bodySmall),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/company_auth_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/supabase/supabase_service.dart';
import '../../../../core/routing/routes.dart';
import '../../data/auth_repository.dart';
import '../controllers/auth_controller.dart';

class CompanyAuthScreen extends ConsumerStatefulWidget {
  const CompanyAuthScreen({super.key, this.initialIsLogin = true});

  final bool initialIsLogin;

  @override
  ConsumerState<CompanyAuthScreen> createState() => _CompanyAuthScreenState();
}

class _CompanyAuthScreenState extends ConsumerState<CompanyAuthScreen> {
  static const _sectors = <String>[
    "Yazılım",
    "Finans",
    "Eğitim",
    "Sağlık",
    "Üretim",
    "Danışmanlık",
    "E-ticaret",
    "Turizm",
    "Diğer",
  ];

  static const _cities = <String>[
    "İstanbul",
    "Ankara",
    "İzmir",
    "Bursa",
    "Antalya",
    "Adana",
    "Konya",
    "Gaziantep",
    "Kayseri",
    "Diğer",
  ];

  late bool _isLogin;
  bool _showPassword = false;
  bool _loading = false;

  // Login
  final _loginEmail = TextEditingController();
  final _loginPassword = TextEditingController();

  // Register
  final _regCompanyName = TextEditingController();
  String? _regSector;
  String? _regCity;
  final _regTaxNumber = TextEditingController();
  final _regEmail = TextEditingController();
  final _regPassword = TextEditingController();
  final _regPhone = TextEditingController();
  final _regAddress = TextEditingController();

  String? _error;

  @override
  void initState() {
    super.initState();
    _isLogin = widget.initialIsLogin;
  }

  @override
  void dispose() {
    _loginEmail.dispose();
    _loginPassword.dispose();

    _regCompanyName.dispose();
    _regTaxNumber.dispose();
    _regEmail.dispose();
    _regPassword.dispose();
    _regPhone.dispose();
    _regAddress.dispose();
    super.dispose();
  }

  void _snack(String msg, {bool error = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: error ? Colors.red : null,
      ),
    );
  }

  Future<void> _handleLogin() async {
    final email = _loginEmail.text.trim();
    final pass = _loginPassword.text;

    if (email.isEmpty || pass.isEmpty) {
      _snack('Lütfen tüm alanları doldurun', error: true);
      return;
    }

    setState(() {
      _error = null;
      _loading = true;
    });

    try {
      // 1) Supabase sign-in (your repo already blocks unverified emails)
      final err = await ref
          .read(authActionLoadingProvider.notifier)
          .signIn(email, pass);

      if (err != null) {
        setState(() => _error = err);
        return;
      }

      // 2) Verify that this account is actually a company account
      final repo = ref.read(authRepositoryProvider);
      final user = repo.currentUser;

      if (user == null) {
        setState(() => _error = 'Giriş başarısız: kullanıcı bulunamadı');
        return;
      }

      final membership = await repo.fetchCompanyMembership(user.id);
      if (membership == null) {
        await repo.signOut();
        setState(() => _error = 'Bu hesap bir işletme hesabı değil');
        return;
      }

      _snack('Giriş başarılı!');
      if (!mounted) return;
      context.go(Routes.companyDashboard);
    } catch (e) {
      setState(() => _error = 'Bir hata oluştu: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  Future<void> _handleRegister() async {
    final companyName = _regCompanyName.text.trim();
    final sector = _regSector;
    final city = _regCity;
    final tax = _regTaxNumber.text.trim();
    final email = _regEmail.text.trim();
    final pass = _regPassword.text;
    final phone = _regPhone.text.trim();
    final address = _regAddress.text.trim();

    if (companyName.isEmpty ||
        sector == null ||
        city == null ||
        tax.isEmpty ||
        email.isEmpty ||
        pass.isEmpty ||
        phone.isEmpty) {
      _snack('Lütfen tüm zorunlu alanları doldurun', error: true);
      return;
    }

    if (pass.length < 6) {
      _snack('Şifre en az 6 karakter olmalıdır', error: true);
      return;
    }

    setState(() {
      _error = null;
      _loading = true;
    });

    try {
      final client = SupabaseService.client;

      // 1) Tax number uniqueness check
      final existing = await client
          .from('companies')
          .select('id')
          .eq('tax_number', tax)
          .maybeSingle();

      if (existing != null) {
        _snack('Bu vergi numarası ile kayıtlı bir şirket zaten var', error: true);
        return;
      }

      // 2) Create auth user (company user)
      //
      // React also sets user metadata user_type='company'.
      // This is optional for our Flutter logic (we rely on company_users table),
      // but we mirror it for parity.
      final signUpRes = await client.auth.signUp(
        email: email,
        password: pass,
        data: {
          'full_name': companyName,
          'user_type': 'company',
        },
      );

      final user = signUpRes.user;
      if (user == null) {
        _snack('Kullanıcı oluşturulamadı', error: true);
        return;
      }

      // 3) Create company row
      final nowIso = DateTime.now().toIso8601String();
      final createdCompany = await client
          .from('companies')
          .insert({
            'name': companyName,
            'sector': sector,
            'tax_number': tax,
            'phone': phone,
            'city': city,
            'address': address.isEmpty ? null : address,
            'verified': false,
            'created_at': nowIso,
            'updated_at': nowIso,
          })
          .select('id')
          .single();

      final companyId = createdCompany['id'] as String;

      // 4) Link user to company in company_users
      await client.from('company_users').insert({
        'company_id': companyId,
        'user_id': user.id,
        'role': 'owner',
        'permissions': ['all'],
        'created_at': nowIso,
      });

      _snack('Kayıt başarılı! Lütfen email adresinizi doğrulayın.');
      if (!mounted) return;

      // Mirror React: switch back to login.
      setState(() => _isLogin = true);

      // Optional: route to email verification page (recommended UX)
      context.go(Uri(path: Routes.emailVerification, queryParameters: {'email': email}).toString());
    } catch (e) {
      // Important note:
      // React attempted supabase.auth.admin.deleteUser(...) on failure.
      // That’s NOT safe/possible from a client without service_role.
      // So here we show the error and leave cleanup to backend/admin tools.
      setState(() => _error = 'Bir hata oluştu: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final auth = ref.watch(authViewStateProvider).value;
    final isAuthed = auth?.isAuthenticated ?? false;

    // If someone is already logged in, let router redirects handle it.
    // (Your app_router already pushes company->dashboard, student->dashboard)
    if (isAuthed) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    final w = MediaQuery.of(context).size.width;
    final showLeftPanel = w >= 980;

    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Color(0xFF0F172A), // slate-900
              Color(0xFF1E293B), // slate-800
              Color(0xFF1E3A8A), // blue-900
            ],
          ),
        ),
        child: Row(
          children: [
            if (showLeftPanel) Expanded(child: _LeftPanel()),
            Expanded(
              child: Center(
                child: ConstrainedBox(
                  constraints: const BoxConstraints(maxWidth: 520),
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(18),
                    child: _GlassCard(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.stretch,
                        children: [
                          const SizedBox(height: 8),
                          Center(
                            child: Container(
                              width: 84,
                              height: 84,
                              decoration: BoxDecoration(
                                borderRadius: BorderRadius.circular(20),
                                gradient: const LinearGradient(
                                  colors: [Color(0xFF3B82F6), Color(0xFF7C3AED)],
                                ),
                                boxShadow: const [
                                  BoxShadow(
                                    blurRadius: 20,
                                    offset: Offset(0, 8),
                                    color: Colors.black26,
                                  )
                                ],
                              ),
                              child: const Icon(Icons.business, color: Colors.white, size: 44),
                            ),
                          ),
                          const SizedBox(height: 14),
                          Text(
                            _isLogin ? 'İşletme Girişi' : 'İşletme Kaydı',
                            textAlign: TextAlign.center,
                            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                                  color: Colors.white,
                                  fontWeight: FontWeight.w800,
                                ),
                          ),
                          const SizedBox(height: 6),
                          Text(
                            _isLogin ? 'Hesabınıza giriş yapın' : 'Yeni işletme hesabı oluşturun',
                            textAlign: TextAlign.center,
                            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                                  color: Colors.white70,
                                ),
                          ),
                          const SizedBox(height: 18),

                          if (_isLogin) _buildLoginForm(context) else _buildRegisterForm(context),

                          const SizedBox(height: 14),

                          if (_error != null) ...[
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.red.withOpacity(0.12),
                                borderRadius: BorderRadius.circular(14),
                                border: Border.all(color: Colors.red.withOpacity(0.25)),
                              ),
                              child: Text(
                                _error!,
                                style: const TextStyle(color: Colors.redAccent),
                              ),
                            ),
                            const SizedBox(height: 14),
                          ],

                          _GradientButton(
                            text: _isLogin ? 'Giriş Yap' : 'Kayıt Ol',
                            loading: _loading,
                            onPressed: _loading ? null : () async {
                              if (_isLogin) {
                                await _handleLogin();
                              } else {
                                await _handleRegister();
                              }
                            },
                          ),

                          const SizedBox(height: 16),

                          Center(
                            child: Wrap(
                              alignment: WrapAlignment.center,
                              crossAxisAlignment: WrapCrossAlignment.center,
                              children: [
                                Text(
                                  _isLogin ? 'Hesabınız yok mu?' : 'Zaten hesabınız var mı?',
                                  style: const TextStyle(color: Colors.white70),
                                ),
                                TextButton(
                                  onPressed: _loading
                                      ? null
                                      : () => setState(() {
                                            _error = null;
                                            _isLogin = !_isLogin;
                                          }),
                                  child: Text(
                                    _isLogin ? 'Kayıt Ol' : 'Giriş Yap',
                                    style: const TextStyle(
                                      color: Color(0xFF60A5FA),
                                      fontWeight: FontWeight.w800,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 6),
                          Center(
                            child: TextButton(
                              onPressed: _loading ? null : () => context.go(Routes.login),
                              child: const Text(
                                'Öğrenci girişine dön',
                                style: TextStyle(color: Colors.white70),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLoginForm(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        _DarkField(
          label: 'E-posta Adresi',
          controller: _loginEmail,
          keyboardType: TextInputType.emailAddress,
          icon: Icons.mail_outline,
          hint: 'ornek@sirket.com',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Şifre',
          controller: _loginPassword,
          icon: Icons.lock_outline,
          hint: '••••••••',
          obscureText: !_showPassword,
          suffix: IconButton(
            onPressed: () => setState(() => _showPassword = !_showPassword),
            icon: Icon(
              _showPassword ? Icons.visibility_off : Icons.visibility,
              color: Colors.white70,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildRegisterForm(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        _DarkField(
          label: 'Şirket Adı *',
          controller: _regCompanyName,
          icon: Icons.apartment,
          hint: 'Şirket adınız',
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: _DarkDropdown(
                label: 'Sektör *',
                value: _regSector,
                items: _sectors,
                icon: Icons.work_outline,
                onChanged: (v) => setState(() => _regSector = v),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _DarkDropdown(
                label: 'Şehir *',
                value: _regCity,
                items: _cities,
                icon: Icons.location_on_outlined,
                onChanged: (v) => setState(() => _regCity = v),
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Vergi Numarası *',
          controller: _regTaxNumber,
          icon: Icons.receipt_long_outlined,
          hint: 'Vergi numaranız',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'E-posta Adresi *',
          controller: _regEmail,
          keyboardType: TextInputType.emailAddress,
          icon: Icons.mail_outline,
          hint: 'ornek@sirket.com',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Şifre *',
          controller: _regPassword,
          icon: Icons.lock_outline,
          hint: 'En az 6 karakter',
          obscureText: !_showPassword,
          suffix: IconButton(
            onPressed: () => setState(() => _showPassword = !_showPassword),
            icon: Icon(
              _showPassword ? Icons.visibility_off : Icons.visibility,
              color: Colors.white70,
            ),
          ),
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Telefon *',
          controller: _regPhone,
          keyboardType: TextInputType.phone,
          icon: Icons.phone_outlined,
          hint: '0532 XXX XX XX',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Adres',
          controller: _regAddress,
          icon: Icons.home_outlined,
          hint: 'Şirket adresi (opsiyonel)',
          maxLines: 2,
        ),
      ],
    );
  }
}

class _LeftPanel extends StatelessWidget {
  const _LeftPanel();

  @override
  Widget build(BuildContext context) {
    final features = const [
      (Icons.work_outline, 'İlan Yönetimi', 'İş ve staj ilanlarınızı kolayca yönetin'),
      (Icons.people_outline, 'Başvuru Takibi', 'Tüm başvuruları tek panelden inceleyin'),
      (Icons.trending_up, 'Detaylı Analizler', 'İlan performanslarını takip edin'),
      (Icons.emoji_events_outlined, 'Yetenekleri Keşfedin', 'En uygun adayları bulun'),
    ];

    return Stack(
      children: [
        Positioned.fill(
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Colors.blue.withOpacity(0.20),
                  Colors.purple.withOpacity(0.18),
                ],
              ),
            ),
          ),
        ),
        Padding(
          padding: const EdgeInsets.all(28),
          child: Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 520),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Icon(Icons.business, size: 68, color: Color(0xFF60A5FA)),
                  const SizedBox(height: 14),
                  const Text(
                    'İşletme Yönetim Paneli',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 34,
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  const SizedBox(height: 10),
                  const Text(
                    'Geleceğin yetenekleriyle buluşun',
                    style: TextStyle(color: Colors.white70, fontSize: 18),
                  ),
                  const SizedBox(height: 22),
                  ...features.map((f) {
                    final icon = f.$1;
                    final title = f.$2;
                    final desc = f.$3;

                    return Container(
                      margin: const EdgeInsets.only(bottom: 14),
                      padding: const EdgeInsets.all(14),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.10),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.white.withOpacity(0.18)),
                      ),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Container(
                            padding: const EdgeInsets.all(10),
                            decoration: BoxDecoration(
                              gradient: const LinearGradient(
                                colors: [Color(0xFF3B82F6), Color(0xFF7C3AED)],
                              ),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Icon(icon, color: Colors.white, size: 22),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  title,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.w800,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(desc, style: const TextStyle(color: Colors.white70)),
                              ],
                            ),
                          ),
                        ],
                      ),
                    );
                  }),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class _GlassCard extends StatelessWidget {
  const _GlassCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(18),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.10),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: Colors.white.withOpacity(0.18)),
        boxShadow: const [
          BoxShadow(blurRadius: 28, offset: Offset(0, 14), color: Colors.black38),
        ],
      ),
      child: child,
    );
  }
}

class _DarkField extends StatelessWidget {
  const _DarkField({
    required this.label,
    required this.controller,
    required this.icon,
    this.hint,
    this.keyboardType,
    this.obscureText = false,
    this.suffix,
    this.maxLines = 1,
  });

  final String label;
  final TextEditingController controller;
  final IconData icon;
  final String? hint;
  final TextInputType? keyboardType;
  final bool obscureText;
  final Widget? suffix;
  final int maxLines;

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: controller,
      keyboardType: keyboardType,
      obscureText: obscureText,
      maxLines: maxLines,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.white70),
        hintText: hint,
        hintStyle: const TextStyle(color: Colors.white38),
        prefixIcon: Icon(icon, color: Colors.white70),
        suffixIcon: suffix,
        filled: true,
        fillColor: Colors.white.withOpacity(0.10),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.18)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 2),
        ),
      ),
    );
  }
}

class _DarkDropdown extends StatelessWidget {
  const _DarkDropdown({
    required this.label,
    required this.value,
    required this.items,
    required this.icon,
    required this.onChanged,
  });

  final String label;
  final String? value;
  final List<String> items;
  final IconData icon;
  final ValueChanged<String?> onChanged;

  @override
  Widget build(BuildContext context) {
    return DropdownButtonFormField<String>(
      value: value,
      dropdownColor: const Color(0xFF111827),
      style: const TextStyle(color: Colors.white),
      items: items
          .map((v) => DropdownMenuItem<String>(
                value: v,
                child: Text(v, style: const TextStyle(color: Colors.white)),
              ))
          .toList(),
      onChanged: onChanged,
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.white70),
        prefixIcon: Icon(icon, color: Colors.white70),
        filled: true,
        fillColor: Colors.white.withOpacity(0.10),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.18)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 2),
        ),
      ),
    );
  }
}

class _GradientButton extends StatelessWidget {
  const _GradientButton({
    required this.text,
    required this.loading,
    required this.onPressed,
  });

  final String text;
  final bool loading;
  final VoidCallback? onPressed;

  @override
  Widget build(BuildContext context) {
    return DecoratedBox(
      decoration: BoxDecoration(
        gradient: const LinearGradient(colors: [Color(0xFF2563EB), Color(0xFF7C3AED)]),
        borderRadius: BorderRadius.circular(14),
        boxShadow: const [
          BoxShadow(blurRadius: 22, offset: Offset(0, 10), color: Colors.black26),
        ],
      ),
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.transparent,
          shadowColor: Colors.transparent,
          padding: const EdgeInsets.symmetric(vertical: 14),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
        ),
        onPressed: onPressed,
        child: loading
            ? const SizedBox(
                width: 22,
                height: 22,
                child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
              )
            : Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(text, style: const TextStyle(fontWeight: FontWeight.w800)),
                  const SizedBox(width: 10),
                  const Icon(Icons.arrow_forward, size: 18),
                ],
              ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\test\widget_test.dart


import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'package:ogrenci_intelligence/src/app/app.dart';

void main() {
  testWidgets('App boots (smoke test)', (WidgetTester tester) async {
    // Build the real app root
    await tester.pumpWidget(const ProviderScope(child: App()));

    // Let first frames build
    await tester.pump();

    // If we reach here without exceptions, boot is OK.
    expect(find.byType(App), findsOneWidget);
  });
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\app\bootstrap.dart

import '../core/config/env.dart';
import '../core/supabase/supabase_service.dart';

Future<void> bootstrap() async {
  await Env.load();

  await SupabaseService.initialize(
    supabaseUrl: Env.supabaseUrl,
    supabaseAnonKey: Env.supabaseAnonKey,
  );
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\features\home\presentation\screens\home_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../../../auth/presentation/controllers/auth_controller.dart';
import '../widgets/how_it_works_section.dart';

class HomeScreen extends ConsumerWidget {
  const HomeScreen({super.key});

  // Tailwind-like palette (close to your React UI)
  static const _bgTop = Color(0xFFFFFFFF);
  static const _bgBottom = Color(0xFFFAF5FF); // purple-50
  static const _purple700 = Color(0xFF7E22CE);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsync = ref.watch(authViewStateProvider);

    final isLoading = authAsync.isLoading;
    final auth = authAsync.value;
    final isLoggedIn = (!isLoading) && (auth?.isAuthenticated ?? false);

    return DecoratedBox(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [_bgTop, _bgBottom],
        ),
      ),
      child: SafeArea(
        bottom: false,
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 24),
          child: Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 1080),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  _Hero(
                    isLoggedIn: isLoggedIn,
                    isLoading: isLoading,
                    onRegister: () => context.go(Routes.register),
                    onLogin: () => context.go(Routes.login),
                    onProfile: () => context.go(Routes.profile),
                    onLogout: () async {
                      await SupabaseService.client.auth.signOut();
                      if (context.mounted) context.go(Routes.home);
                    },
                  ),

                  const SizedBox(height: 36),

                  _SectionGrid(
                    title: null,
                    cards: const [
                      _InfoCard(
                        icon: Icons.school_outlined,
                        iconColor: _purple700,
                        title: 'Alanına Özel İçerikler',
                        description:
                            'Bölümüne uygun kurslar, stajlar ve iş ilanlarıyla odaklanmış öğrenme.',
                      ),
                      _InfoCard(
                        icon: Icons.work_outline,
                        iconColor: _purple700,
                        title: 'Kariyerine Yön Ver',
                        description:
                            'Kişiselleştirilmiş kariyer rehberliği ve fırsatlarla desteklen.',
                      ),
                      _InfoCard(
                        icon: Icons.assignment_outlined,
                        iconColor: _purple700,
                        title: 'Kolay ve Hızlı Kullanım',
                        description:
                            'Modern tasarım ve kullanıcı dostu arayüz ile zamandan tasarruf et.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  _SectionGrid(
                    title: 'Öğrenciler İçin Faydalar',
                    cards: const [
                      _InfoCard(
                        icon: Icons.track_changes_outlined,
                        iconColor: _purple700,
                        title: 'Hedef Odaklı İçerik',
                        description:
                            'Alanına uygun fırsatlarla zaman kaybetmeden hedefe ulaş.',
                      ),
                      _InfoCard(
                        icon: Icons.star_outline,
                        iconColor: _purple700,
                        title: 'Rekabet Avantajı',
                        description:
                            'Özgeçmişini güçlendirecek fırsatlara herkesten önce ulaş.',
                      ),
                      _InfoCard(
                        icon: Icons.bar_chart_outlined,
                        iconColor: _purple700,
                        title: 'Gelişim Takibi',
                        description:
                            'İlerleyişini takip et, eksiklerini zamanında fark et.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  _SectionGrid(
                    title: 'İşletmeler İçin Faydalar',
                    cards: const [
                      _InfoCard(
                        icon: Icons.people_outline,
                        iconColor: _purple700,
                        title: 'Genç Yeteneklere Erişim',
                        description:
                            'Motivasyonu yüksek, alanına ilgili öğrencilere ulaşın.',
                      ),
                      _InfoCard(
                        icon: Icons.handshake_outlined,
                        iconColor: _purple700,
                        title: 'İşbirliği Olanakları',
                        description:
                            'Projelerinizde üniversite öğrencileriyle birlikte çalışın.',
                      ),
                      _InfoCard(
                        icon: Icons.query_stats_outlined,
                        iconColor: _purple700,
                        title: 'Veriye Dayalı Seçim',
                        description:
                            'Profil verileriyle doğru kişiyi kolayca belirleyin.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  // ✅ Keep it here, from widgets/how_it_works_section.dart
                  const HowItWorksSection(),

                  const SizedBox(height: 24),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _Hero extends StatelessWidget {
  const _Hero({
    required this.isLoggedIn,
    required this.isLoading,
    required this.onRegister,
    required this.onLogin,
    required this.onProfile,
    required this.onLogout,
  });

  final bool isLoggedIn;
  final bool isLoading;
  final VoidCallback onRegister;
  final VoidCallback onLogin;
  final VoidCallback onProfile;
  final Future<void> Function() onLogout;

  static const _purple700 = Color(0xFF7E22CE);
  static const _indigo700 = Color(0xFF4338CA);
  static const _blue800 = Color(0xFF1E40AF);
  static const _yellow400 = Color(0xFFFACC15);
  static const _green400 = Color(0xFF4ADE80);
  static const _red400 = Color(0xFFF87171);

  @override
  Widget build(BuildContext context) {
    final titleStyle = Theme.of(context).textTheme.headlineMedium?.copyWith(
          color: Colors.white,
          fontWeight: FontWeight.w800,
          height: 1.15,
        );

    final subtitleStyle = Theme.of(context).textTheme.titleMedium?.copyWith(
          color: const Color(0xFFC7D2FE), // indigo-200 vibe
          height: 1.5,
        );

    return TweenAnimationBuilder<double>(
      duration: const Duration(milliseconds: 900),
      tween: Tween(begin: 0, end: 1),
      builder: (context, t, child) => Opacity(
        opacity: t,
        child: Transform.translate(offset: Offset(0, (1 - t) * 40), child: child),
      ),
      child: Container(
        padding: const EdgeInsets.all(18),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [_purple700, _indigo700, _blue800],
          ),
          borderRadius: BorderRadius.circular(28),
          boxShadow: const [
            BoxShadow(
              blurRadius: 20,
              spreadRadius: 2,
              offset: Offset(0, 10),
              color: Color(0x26000000),
            )
          ],
        ),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 26),
          child: Column(
            children: [
              Text(
                'Üniversite Hayatını Güçlendir,\nKariyerine Hızla Yön Ver!',
                textAlign: TextAlign.center,
                style: titleStyle,
              ),
              const SizedBox(height: 14),
              ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 720),
                child: Text(
                  'Alanına özel kurslar, stajlar ve iş ilanları ile geleceğine sağlam adımlarla ilerle.',
                  textAlign: TextAlign.center,
                  style: subtitleStyle,
                ),
              ),
              const SizedBox(height: 22),
              if (isLoading)
                const Padding(
                  padding: EdgeInsets.all(8),
                  child: CircularProgressIndicator(color: Colors.white),
                )
              else
                Wrap(
                  spacing: 14,
                  runSpacing: 12,
                  alignment: WrapAlignment.center,
                  children: [
                    if (!isLoggedIn) ...[
                      _FilledCta(
                        label: 'Kayıt Ol',
                        color: _yellow400,
                        textColor: Color(0xFF111827),
                        onTap: onRegister,
                      ),
                      _FilledCta(
                        label: 'Giriş Yap',
                        color: _yellow400,
                        textColor: Color(0xFF111827),
                        onTap: onLogin,
                      ),
                    ] else ...[
                      _FilledCta(
                        label: 'Profil',
                        color: _green400,
                        textColor: Color(0xFF111827),
                        icon: Icons.person_outline,
                        onTap: onProfile,
                      ),
                      _FilledCta(
                        label: 'Çıkış Yap',
                        color: _red400,
                        textColor: Colors.white,
                        icon: Icons.logout_outlined,
                        onTapAsync: onLogout,
                      ),
                    ]
                  ],
                ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FilledCta extends StatefulWidget {
  const _FilledCta({
    required this.label,
    required this.color,
    required this.textColor,
    this.icon,
    this.onTap,
    this.onTapAsync,
  });

  final String label;
  final Color color;
  final Color textColor;
  final IconData? icon;
  final VoidCallback? onTap;
  final Future<void> Function()? onTapAsync;

  @override
  State<_FilledCta> createState() => _FilledCtaState();
}

class _FilledCtaState extends State<_FilledCta> {
  bool _busy = false;

  @override
  Widget build(BuildContext context) {
    final onPressed = (widget.onTapAsync != null)
        ? () async {
            if (_busy) return;
            setState(() => _busy = true);
            try {
              await widget.onTapAsync!.call();
            } finally {
              if (mounted) setState(() => _busy = false);
            }
          }
        : widget.onTap;

    return ElevatedButton(
      onPressed: onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: widget.color,
        foregroundColor: widget.textColor,
        elevation: 10,
        padding: const EdgeInsets.symmetric(horizontal: 22, vertical: 16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (widget.icon != null) ...[
            Icon(widget.icon, size: 18),
            const SizedBox(width: 8),
          ],
          Text(
            _busy ? '...' : widget.label,
            style: const TextStyle(fontWeight: FontWeight.w800),
          ),
        ],
      ),
    );
  }
}

class _SectionGrid extends StatelessWidget {
  const _SectionGrid({
    required this.title,
    required this.cards,
  });

  final String? title;
  final List<_InfoCard> cards;

  @override
  Widget build(BuildContext context) {
    final headerStyle = Theme.of(context).textTheme.headlineSmall?.copyWith(
          fontWeight: FontWeight.w800,
          color: const Color(0xFF3B0764), // deep purple
        );

    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        if (title != null) ...[
          Text(title!, textAlign: TextAlign.center, style: headerStyle),
          const SizedBox(height: 18),
        ],
        LayoutBuilder(
          builder: (context, c) {
            final w = c.maxWidth;
            final gap = 18.0;
            final minItem = 280.0;

            final count = (w / (minItem + gap)).floor().clamp(1, 3);
            final itemW = (w - gap * (count - 1)) / count;

            return Wrap(
              spacing: gap,
              runSpacing: gap,
              children: [
                for (final card in cards) SizedBox(width: itemW, child: card),
              ],
            );
          },
        ),
      ],
    );
  }
}

class _InfoCard extends StatelessWidget {
  const _InfoCard({
    required this.icon,
    required this.iconColor,
    required this.title,
    required this.description,
  });

  final IconData icon;
  final Color iconColor;
  final String title;
  final String description;

  @override
  Widget build(BuildContext context) {
    final titleStyle = Theme.of(context).textTheme.titleLarge?.copyWith(
          fontWeight: FontWeight.w700,
          color: const Color(0xFF5B21B6),
        );

    final descStyle = Theme.of(context).textTheme.bodyMedium?.copyWith(
          color: const Color(0xFF4B5563),
          height: 1.45,
        );

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(26),
        boxShadow: const [
          BoxShadow(
            blurRadius: 14,
            offset: Offset(0, 8),
            color: Color(0x1A000000),
          )
        ],
      ),
      child: Column(
        children: [
          Icon(icon, size: 46, color: iconColor),
          const SizedBox(height: 12),
          Text(title, textAlign: TextAlign.center, style: titleStyle),
          const SizedBox(height: 10),
          Text(description, textAlign: TextAlign.center, style: descStyle),
        ],
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/home/presentation/widgets/how_it_works_section.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../../auth/presentation/controllers/auth_controller.dart';

class HowItWorksSection extends ConsumerWidget {
  const HowItWorksSection({super.key});

  static const _bg = Color(0xFFF9FAFB); // gray-50

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsync = ref.watch(authViewStateProvider);
    final isLoading = authAsync.isLoading;
    final isLoggedIn = (!isLoading) && (authAsync.value?.isAuthenticated ?? false);

    final w = MediaQuery.of(context).size.width;

    // Breakpoints proches du React: md=2 cols, lg=4 cols
    final columns = w >= 1024 ? 4 : (w >= 768 ? 2 : 1);
    final showArrows = columns >= 4;

    const steps = <_HowStep>[
      _HowStep(
        index: 1,
        title: 'Eğitim Modülü',
        description:
            'Alanına özel temel bilgiler, video anlatımlar ve mini sınavlarla kariyer yolculuğuna güçlü bir başlangıç yap.',
        icon: Icons.menu_book_outlined,
        iconColor: Color(0xFF4F46E5), // indigo-600
        bgColor: Color(0xFFEFF6FF), // indigo-50 vibe
        borderColor: Color(0xFFC7D2FE), // indigo-200
      ),
      _HowStep(
        index: 2,
        title: 'Saha Uygulaması',
        description:
            'Teorik bilgilerini pratikte uygulayarak gerçek iş ortamında deneyim kazan. Mentör desteği ile gelişimini pekiştir.',
        icon: Icons.business_center_outlined,
        iconColor: Color(0xFF7C3AED), // purple-600
        bgColor: Color(0xFFF3E8FF), // purple-50
        borderColor: Color(0xFFD8B4FE), // purple-200
      ),
      _HowStep(
        index: 3,
        title: 'Network Oluştur',
        description:
            'Sektör profesyonelleri ve diğer öğrencilerle tanış, kariyer ağını genişlet ve yeni fırsatlar keşfet.',
        icon: Icons.groups_outlined,
        iconColor: Color(0xFF16A34A), // green-600
        bgColor: Color(0xFFECFDF5), // green-50
        borderColor: Color(0xFFBBF7D0), // green-200
      ),
      _HowStep(
        index: 4,
        title: 'Başarıyı Yakala',
        description:
            'Sertifikalarını al, referanslarını topla ve hayalindeki kariyere doğru emin adımlarla ilerle.',
        icon: Icons.emoji_events_outlined,
        iconColor: Color(0xFFCA8A04), // yellow-600
        bgColor: Color(0xFFFFFBEB), // yellow-50
        borderColor: Color(0xFFFDE68A), // yellow-200
      ),
    ];

    return Container(
      width: double.infinity,
      color: _bg,
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 56),
      child: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 1080),
          child: Column(
            children: [
              // Title
              Text(
                'Nasıl Çalışır?',
                textAlign: TextAlign.center,
                style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                      fontWeight: FontWeight.w800,
                      color: const Color(0xFF1F2937),
                    ),
              ),
              const SizedBox(height: 12),
              ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 720),
                child: Text(
                  'Platformumuz dört temel aşamadan oluşur. Her adımda yanındayız!',
                  textAlign: TextAlign.center,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        color: const Color(0xFF6B7280),
                        height: 1.5,
                      ),
                ),
              ),
              const SizedBox(height: 28),

              // Grid
              LayoutBuilder(
                builder: (context, c) {
                  final gap = 16.0;
                  final totalW = c.maxWidth;
                  final itemW = (columns == 1)
                      ? totalW
                      : (totalW - gap * (columns - 1)) / columns;

                  return Wrap(
                    spacing: gap,
                    runSpacing: gap,
                    children: [
                      for (var i = 0; i < steps.length; i++)
                        SizedBox(
                          width: itemW,
                          child: _HowStepCard(
                            step: steps[i],
                            showArrow: showArrows && i < steps.length - 1,
                          ),
                        ),
                    ],
                  );
                },
              ),

              const SizedBox(height: 34),

              // CTA
              _CtaButton(
                label: isLoggedIn ? "Dashboard'a Git" : "Hemen Başla",
                onTap: () => context.go(
                  isLoggedIn ? Routes.dashboard : Routes.register,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _HowStep {
  const _HowStep({
    required this.index,
    required this.title,
    required this.description,
    required this.icon,
    required this.iconColor,
    required this.bgColor,
    required this.borderColor,
  });

  final int index;
  final String title;
  final String description;
  final IconData icon;
  final Color iconColor;
  final Color bgColor;
  final Color borderColor;
}

class _HowStepCard extends StatefulWidget {
  const _HowStepCard({required this.step, required this.showArrow});

  final _HowStep step;
  final bool showArrow;

  @override
  State<_HowStepCard> createState() => _HowStepCardState();
}

class _HowStepCardState extends State<_HowStepCard> {
  bool _hover = false;

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) {
        if (!_hover) setState(() => _hover = true);
      },
      onExit: (_) {
        if (_hover) setState(() => _hover = false);
      },
      child: Stack(
        clipBehavior: Clip.none,
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 180),
            transform: Matrix4.identity()..translate(0.0, _hover ? -4.0 : 0.0),
            padding: const EdgeInsets.all(18),
            decoration: BoxDecoration(
              color: widget.step.bgColor,
              borderRadius: BorderRadius.circular(18),
              border: Border.all(color: widget.step.borderColor, width: 2),
              boxShadow: _hover
                  ? const [
                      BoxShadow(
                        blurRadius: 18,
                        offset: Offset(0, 10),
                        color: Color(0x1A000000),
                      )
                    ]
                  : const [],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Icon(widget.step.icon, size: 40, color: widget.step.iconColor),
                const SizedBox(height: 12),
                Text(
                  widget.step.title,
                  style: Theme.of(context).textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: const Color(0xFF1F2937),
                      ),
                ),
                const SizedBox(height: 10),
                Text(
                  widget.step.description,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        color: const Color(0xFF4B5563),
                        height: 1.45,
                      ),
                ),
              ],
            ),
          ),

          // Step number (top-right)
          Positioned(
            top: -10,
            right: -10,
            child: Container(
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: const Color(0xFF111827),
                borderRadius: BorderRadius.circular(999),
              ),
              alignment: Alignment.center,
              child: Text(
                '${widget.step.index}',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w800,
                  fontSize: 12,
                ),
              ),
            ),
          ),

          // Arrow (only large screens / not last)
          if (widget.showArrow)
            const Positioned(
              right: -14,
              top: 0,
              bottom: 0,
              child: Center(
                child: Icon(
                  Icons.arrow_forward,
                  size: 22,
                  color: Color(0xFF9CA3AF),
                ),
              ),
            ),
        ],
      ),
    );
  }
}

class _CtaButton extends StatefulWidget {
  const _CtaButton({required this.label, required this.onTap});

  final String label;
  final VoidCallback onTap;

  @override
  State<_CtaButton> createState() => _CtaButtonState();
}

class _CtaButtonState extends State<_CtaButton> {
  bool _hover = false;
  static const _purple = Color(0xFF7C3AED);
  static const _purpleHover = Color(0xFF6D28D9);

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) {
        if (!_hover) setState(() => _hover = true);
      },
      onExit: (_) {
        if (_hover) setState(() => _hover = false);
      },
      child: AnimatedScale(
        duration: const Duration(milliseconds: 160),
        scale: _hover ? 1.05 : 1.0,
        child: ElevatedButton(
          onPressed: widget.onTap,
          style: ElevatedButton.styleFrom(
            backgroundColor: _hover ? _purpleHover : _purple,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 14),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            elevation: 10,
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(widget.label, style: const TextStyle(fontWeight: FontWeight.w800)),
              const SizedBox(width: 10),
              const Icon(Icons.arrow_forward, size: 18),
            ],
          ),
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\shared\widgets\app_navbar.dart


// lib/src/shared/widgets/app_navbar.dart
import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../core/routing/routes.dart';
import '../../core/supabase/supabase_service.dart';
import '../../features/auth/domain/auth_models.dart';
import '../../features/auth/presentation/controllers/auth_controller.dart';

class AppNavbar extends ConsumerStatefulWidget {
  const AppNavbar({super.key});

  @override
  ConsumerState<AppNavbar> createState() => _AppNavbarState();
}

class _AppNavbarState extends ConsumerState<AppNavbar> {
  bool _mobileOpen = false;

  // Points cache (student only)
  Future<int>? _pointsFuture;
  String? _pointsUserId;

  // ✅ Type-safe metadata read
  String? _metaString(Map<String, dynamic>? meta, String key) {
    final v = meta?[key];
    if (v is String) {
      final s = v.trim();
      return s.isEmpty ? null : s;
    }
    return null;
  }

  String _displayNameFromUser(User? user) {
    if (user == null) return 'Kullanıcı';

    final fullName = _metaString(user.userMetadata, 'full_name');
    if (fullName != null) return fullName;

    final email = user.email;
    if (email != null && email.contains('@')) return email.split('@').first;

    return 'Kullanıcı';
  }

  Future<void> _logout(BuildContext context) async {
    final err = await ref.read(authActionLoadingProvider.notifier).signOut();
    _closeMobile();

    if (!mounted) return;

    if (err != null && err.isNotEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Çıkış yapılamadı: $err')),
      );
      return;
    }
    context.go(Routes.home);
  }

  @override
  Widget build(BuildContext context) {
    final authAsync = ref.watch(authViewStateProvider);
    final isLoading = authAsync.isLoading;
    final auth = authAsync.value;

    final isLoggedIn = (!isLoading) && (auth?.isAuthenticated ?? false);

    // ✅ IMPORTANT: default should be guest (not student)
    final userType = auth?.userType ?? UserType.guest;

    // ✅ Real Supabase User (from AuthViewState)
    final user = auth?.user;

    // ✅ Safe display name
    final userName = _displayNameFromUser(user);

    final isCompany = isLoggedIn && userType == UserType.company;
    final isStudent = isLoggedIn && userType == UserType.student;

    // React-like menu sets
    final studentMenu = const <_NavItem>[
      _NavItem('Anasayfa', Routes.home),
      _NavItem('Kurslar', Routes.courses),
      _NavItem('İş İlanları', Routes.jobs),
      _NavItem('Stajlar', Routes.internships),
    ];

    final companyMenu = const <_NavItem>[
      _NavItem('İlanlarım', Routes.companyJobs),
      _NavItem('Staj Yönetimi', Routes.companyInternships),
      _NavItem('Başvurular', Routes.companyApplications),
      _NavItem('Raporlar', Routes.companyReports),
    ];

    final menuItems = isCompany ? companyMenu : studentMenu;

    final studentDropdown = const <_NavItem>[
      _NavItem('Profilim', Routes.profile),
      _NavItem('Dashboard', Routes.dashboard),
      _NavItem('Başvurularım', Routes.applications),
      _NavItem('Favorilerim', Routes.favorites),
      _NavItem('Bildirimler', Routes.notifications),
      _NavItem('Ayarlar', Routes.settings),
    ];

    final companyDropdown = const <_NavItem>[
      _NavItem('Şirket Profili', Routes.companyProfile),
      _NavItem('Dashboard', Routes.companyDashboard),
      _NavItem('Paketler ve Fiyatlar', Routes.companyPricing),
    ];

    final dropdownItems = isCompany ? companyDropdown : studentDropdown;

    // Desktop breakpoint similar to React md+
    final w = MediaQuery.of(context).size.width;
    final isDesktop = w >= 768;

    // Student points chip: prepare/cached future
    if (isStudent) {
      final uid = user?.id;
      if (uid != null && uid.isNotEmpty && uid != _pointsUserId) {
        _pointsUserId = uid;
        _pointsFuture = _fetchUserTotalPoints(uid);
      }
    } else {
      _pointsUserId = null;
      _pointsFuture = null;
    }

    return Material(
      elevation: 0,
      color: Colors.white,
      child: Container(
        decoration: const BoxDecoration(
          border: Border(bottom: BorderSide(color: Color(0xFFE5E7EB))),
          boxShadow: [
            BoxShadow(
              blurRadius: 10,
              offset: Offset(0, 2),
              color: Color(0x14000000),
            )
          ],
        ),
        child: Column(
          children: [
            // Top bar
            SafeArea(
              bottom: false,
              child: Center(
                child: ConstrainedBox(
                  constraints: const BoxConstraints(maxWidth: 1080),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                    child: Row(
                      children: [
                        // Logo + Title (React: logo changes for company)
                        InkWell(
                          onTap: () {
                            _closeMobile();
                            if (isCompany) {
                              context.go(Routes.companyDashboard);
                            } else {
                              context.go(Routes.home);
                            }
                          },
                          child: Row(
                            children: [
                              if (isCompany) ...[
                                const Icon(Icons.apartment, size: 34, color: Color(0xFF6D28D9)),
                                const SizedBox(width: 10),
                                if (isDesktop)
                                  const Text(
                                    'İşletme Paneli',
                                    style: TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.w800,
                                      color: Color(0xFF6D28D9),
                                    ),
                                  ),
                              ] else ...[
                                Image.asset(
                                  'assets/logo.png',
                                  height: 40,
                                  fit: BoxFit.contain,
                                  errorBuilder: (_, __, ___) => const Icon(
                                    Icons.school,
                                    size: 34,
                                    color: Color(0xFF6D28D9),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                if (isDesktop)
                                  const Text(
                                    'Öğrenci İntelligence',
                                    style: TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.w800,
                                      color: Color(0xFF6D28D9),
                                    ),
                                  ),
                              ]
                            ],
                          ),
                        ),

                        const Spacer(),

                        // Desktop menu
                        if (isDesktop) ...[
                          Row(
                            children: [
                              for (final item in menuItems)
                                Padding(
                                  padding: const EdgeInsets.symmetric(horizontal: 8),
                                  child: _NavTextLink(
                                    label: item.label,
                                    onTap: () {
                                      _closeMobile();
                                      context.go(item.path);
                                    },
                                  ),
                                ),
                            ],
                          ),

                          const Spacer(),

                          // Right actions (React-like)
                          if (!isLoggedIn) ...[
                            _PrimaryPill(
                              label: 'İşletme Girişi',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.companyAuth);
                              },
                            ),
                            const SizedBox(width: 10),
                          ],

                          if (isLoading)
                            const SizedBox(width: 90, height: 36, child: _SkeletonPill())
                          else if (isLoggedIn) ...[
                            if (isStudent) ...[
                              _PointsChip(
                                future: _pointsFuture,
                                onTap: () {
                                  _closeMobile();
                                  context.go(Routes.pointsSystem);
                                },
                              ),
                              const SizedBox(width: 12),
                            ],

                            if (isCompany) ...[
                              _PrimaryPill(
                                label: 'Yeni İlan',
                                rounded: 14,
                                onTap: () {
                                  _closeMobile();
                                  context.go(Routes.companyJobsCreate);
                                },
                              ),
                              const SizedBox(width: 12),
                            ],

                            _ProfileDropdown(
                              userName: userName,
                              isCompany: isCompany,
                              items: dropdownItems,
                              onItemTap: (path) {
                                _closeMobile();
                                context.go(path);
                              },
                              // ✅ Use controller signOut (type-safe flow)
                              onLogout: () => _logout(context),
                            ),
                          ] else ...[
                            _PrimaryPill(
                              label: 'Öğrenci Girişi',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.login);
                              },
                            ),
                            const SizedBox(width: 10),
                            _PrimaryPill(
                              label: 'Kayıt Ol',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.register);
                              },
                            ),
                          ],
                        ],

                        // Mobile hamburger
                        if (!isDesktop)
                          IconButton(
                            tooltip: _mobileOpen ? 'Kapat' : 'Menü',
                            onPressed: () => setState(() => _mobileOpen = !_mobileOpen),
                            icon: Icon(_mobileOpen ? Icons.close : Icons.menu),
                          ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // Mobile menu (React slideDown)
            if (!isDesktop)
              AnimatedSize(
                duration: const Duration(milliseconds: 180),
                curve: Curves.easeOut,
                child: _mobileOpen
                    ? Container(
                        width: double.infinity,
                        decoration: const BoxDecoration(
                          border: Border(top: BorderSide(color: Color(0xFFE5E7EB))),
                        ),
                        padding: const EdgeInsets.fromLTRB(16, 10, 16, 16),
                        child: Center(
                          child: ConstrainedBox(
                            constraints: const BoxConstraints(maxWidth: 520),
                            child: Column(
                              children: [
                                for (final item in menuItems)
                                  _MobileTile(
                                    label: item.label,
                                    onTap: () {
                                      _closeMobile();
                                      context.go(item.path);
                                    },
                                  ),

                                const SizedBox(height: 8),

                                if (!isLoggedIn)
                                  _MobilePrimary(
                                    label: 'İşletme Girişi',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.companyAuth);
                                    },
                                  ),

                                if (isLoading) ...[
                                  const SizedBox(height: 12),
                                  const _SkeletonBlock(),
                                ] else if (isLoggedIn) ...[
                                  const SizedBox(height: 10),

                                  if (isStudent)
                                    _MobileTile(
                                      label: 'Puan Sistemi',
                                      leading: const Icon(Icons.emoji_events, size: 18),
                                      onTap: () {
                                        _closeMobile();
                                        context.go(Routes.pointsSystem);
                                      },
                                    ),

                                  if (isCompany) ...[
                                    const SizedBox(height: 6),
                                    _MobilePrimary(
                                      label: 'Yeni İlan',
                                      onTap: () {
                                        _closeMobile();
                                        context.go(Routes.companyJobsCreate);
                                      },
                                    ),
                                  ],

                                  const Divider(height: 22),

                                  _MobileHeader(
                                    title: userName,
                                    badge: isCompany ? 'İşletme' : null,
                                  ),

                                  for (final it in dropdownItems)
                                    _MobileTile(
                                      label: it.label,
                                      onTap: () {
                                        _closeMobile();
                                        context.go(it.path);
                                      },
                                    ),

                                  const SizedBox(height: 8),
                                  _MobileDanger(
                                    label: 'Çıkış Yap',
                                    onTap: () => _logout(context),
                                  ),
                                ] else ...[
                                  const SizedBox(height: 10),
                                  _MobilePrimary(
                                    label: 'Öğrenci Girişi',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.login);
                                    },
                                  ),
                                  const SizedBox(height: 8),
                                  _MobilePrimary(
                                    label: 'Kayıt Ol',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.register);
                                    },
                                  ),
                                ],
                              ],
                            ),
                          ),
                        ),
                      )
                    : const SizedBox.shrink(),
              ),
          ],
        ),
      ),
    );
  }

  void _closeMobile() {
    if (_mobileOpen) setState(() => _mobileOpen = false);
  }

  Future<int> _fetchUserTotalPoints(String userId) async {
    try {
      final data = await SupabaseService.client
          .from('profiles')
          .select('total_points')
          .eq('id', userId)
          .single();

      final v = data['total_points'];
      if (v is int) return v;
      if (v is num) return v.toInt();
      return 0;
    } catch (_) {
      return 0;
    }
  }
}

class _NavItem {
  const _NavItem(this.label, this.path);
  final String label;
  final String path;
}

class _NavTextLink extends StatelessWidget {
  const _NavTextLink({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(10),
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
        child: Text(
          label,
          style: const TextStyle(
            fontWeight: FontWeight.w600,
            fontSize: 13,
            color: Color(0xFF374151),
          ),
        ),
      ),
    );
  }
}

class _PrimaryPill extends StatefulWidget {
  const _PrimaryPill({
    required this.label,
    required this.onTap,
    this.rounded = 10,
  });

  final String label;
  final VoidCallback onTap;
  final double rounded;

  @override
  State<_PrimaryPill> createState() => _PrimaryPillState();
}

class _PrimaryPillState extends State<_PrimaryPill> {
  bool _hover = false;
  static const _purple = Color(0xFF7C3AED);
  static const _purpleHover = Color(0xFF6D28D9);

  @override
  Widget build(BuildContext context) {
    final enableHover = kIsWeb;
    return MouseRegion(
      onEnter: enableHover ? (_) => setState(() => _hover = true) : null,
      onExit: enableHover ? (_) => setState(() => _hover = false) : null,
      child: AnimatedScale(
        duration: const Duration(milliseconds: 140),
        scale: _hover ? 1.05 : 1.0,
        child: InkWell(
          borderRadius: BorderRadius.circular(widget.rounded),
          onTap: widget.onTap,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
            decoration: BoxDecoration(
              color: _hover ? _purpleHover : _purple,
              borderRadius: BorderRadius.circular(widget.rounded),
              boxShadow: const [
                BoxShadow(
                  blurRadius: 10,
                  offset: Offset(0, 6),
                  color: Color(0x14000000),
                )
              ],
            ),
            child: Text(
              widget.label,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w700,
                fontSize: 13,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _PointsChip extends StatelessWidget {
  const _PointsChip({required this.future, required this.onTap});
  final Future<int>? future;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(12),
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
        decoration: BoxDecoration(
          color: const Color(0xFFF3E8FF),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            const Icon(Icons.emoji_events, size: 16, color: Color(0xFF6D28D9)),
            const SizedBox(width: 6),
            FutureBuilder<int>(
              future: future,
              builder: (_, snap) {
                final v = snap.data ?? 0;
                return Text(
                  '$v',
                  style: const TextStyle(
                    color: Color(0xFF6D28D9),
                    fontWeight: FontWeight.w800,
                    fontSize: 13,
                  ),
                );
              },
            ),
          ],
        ),
      ),
    );
  }
}

class _ProfileDropdown extends StatelessWidget {
  const _ProfileDropdown({
    required this.userName,
    required this.isCompany,
    required this.items,
    required this.onItemTap,
    required this.onLogout,
  });

  final String userName;
  final bool isCompany;
  final List<_NavItem> items;
  final void Function(String path) onItemTap;
  final Future<void> Function() onLogout;

  @override
  Widget build(BuildContext context) {
    return PopupMenuButton<_NavItem?>(
      tooltip: 'Profil Menüsü',
      offset: const Offset(0, 12),
      onSelected: (selected) async {
        if (selected == null) {
          await onLogout();
        } else {
          onItemTap(selected.path);
        }
      },
      itemBuilder: (context) => [
        for (final it in items)
          PopupMenuItem<_NavItem?>(
            value: it,
            child: Text(it.label),
          ),
        const PopupMenuDivider(),
        const PopupMenuItem<_NavItem?>(
          value: null,
          child: Text(
            'Çıkış Yap',
            style: TextStyle(color: Colors.red),
          ),
        ),
      ],
      child: Row(
        children: [
          Icon(isCompany ? Icons.apartment : Icons.person, size: 18, color: const Color(0xFF374151)),
          const SizedBox(width: 8),
          Text(
            userName,
            style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 13, color: Color(0xFF374151)),
          ),
          if (isCompany) ...[
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
              decoration: BoxDecoration(
                color: const Color(0xFFF3E8FF),
                borderRadius: BorderRadius.circular(999),
              ),
              child: const Text(
                'İşletme',
                style: TextStyle(color: Color(0xFF6D28D9), fontSize: 11, fontWeight: FontWeight.w700),
              ),
            ),
          ],
          const SizedBox(width: 6),
          const Icon(Icons.expand_more, size: 18, color: Color(0xFF6B7280)),
        ],
      ),
    );
  }
}

// --------------------
// Mobile widgets
// --------------------

class _MobileTile extends StatelessWidget {
  const _MobileTile({required this.label, required this.onTap, this.leading});
  final String label;
  final VoidCallback onTap;
  final Widget? leading;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(12),
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 12),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            if (leading != null) ...[leading!, const SizedBox(width: 8)],
            Text(
              label,
              style: const TextStyle(fontWeight: FontWeight.w600, color: Color(0xFF374151)),
            ),
          ],
        ),
      ),
    );
  }
}

class _MobilePrimary extends StatelessWidget {
  const _MobilePrimary({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return _PrimaryPill(label: label, onTap: onTap, rounded: 14);
  }
}

class _MobileDanger extends StatelessWidget {
  const _MobileDanger({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(14),
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
        decoration: BoxDecoration(
          color: const Color(0xFFEF4444),
          borderRadius: BorderRadius.circular(14),
        ),
        child: Center(
          child: Text(
            label,
            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w800),
          ),
        ),
      ),
    );
  }
}

class _MobileHeader extends StatelessWidget {
  const _MobileHeader({required this.title, this.badge});
  final String title;
  final String? badge;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(title, style: const TextStyle(fontWeight: FontWeight.w800, color: Color(0xFF6D28D9))),
          if (badge != null) ...[
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
              decoration: BoxDecoration(
                color: const Color(0xFFF3E8FF),
                borderRadius: BorderRadius.circular(999),
              ),
              child: Text(
                badge!,
                style: const TextStyle(color: Color(0xFF6D28D9), fontSize: 11, fontWeight: FontWeight.w800),
              ),
            )
          ],
        ],
      ),
    );
  }
}

class _SkeletonPill extends StatelessWidget {
  const _SkeletonPill();

  @override
  Widget build(BuildContext context) {
    return DecoratedBox(
      decoration: BoxDecoration(
        color: const Color(0xFFE5E7EB),
        borderRadius: BorderRadius.circular(12),
      ),
    );
  }
}

class _SkeletonBlock extends StatelessWidget {
  const _SkeletonBlock();

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 48,
      decoration: BoxDecoration(
        color: const Color(0xFFE5E7EB),
        borderRadius: BorderRadius.circular(14),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

D:\Dev\ogrenci_intelligence\lib\src\features\student_dashboard\domain\dashboard_application.dart


class StudentProfile {
  const StudentProfile({
    required this.userId,
    required this.email,
    required this.fullName,
    required this.department,
    required this.year,
    required this.totalPoints,
  });

  final String userId;
  final String email;
  final String fullName;
  final String department;
  final int year;
  final int totalPoints;

  StudentProfile copyWith({
    String? fullName,
    String? department,
    int? year,
    int? totalPoints,
  }) {
    return StudentProfile(
      userId: userId,
      email: email,
      fullName: fullName ?? this.fullName,
      department: department ?? this.department,
      year: year ?? this.year,
      totalPoints: totalPoints ?? this.totalPoints,
    );
  }
}

class EnrolledCourse {
  const EnrolledCourse({
    required this.enrollmentId,
    required this.courseId,
    required this.title,
    required this.description,
    required this.duration,
    required this.level,
    required this.progress, // 0..100
    required this.enrolledAt,
  });

  final String enrollmentId;
  final String courseId;
  final String title;
  final String description;
  final String duration;
  final String level;
  final int progress;
  final DateTime? enrolledAt;
}

class ActivityItem {
  const ActivityItem({
    required this.type,
    required this.description,
    required this.points,
    required this.createdAt,
  });

  final String type;
  final String description;
  final int points;
  final DateTime? createdAt;
}

class StudentDashboardData {
  const StudentDashboardData({
    required this.profile,
    required this.completedCourses,
    required this.activeApplications,
    required this.enrolledCourses,
    required this.recentActivities,
  });

  final StudentProfile profile;
  final int completedCourses;
  final int activeApplications;
  final List<EnrolledCourse> enrolledCourses;
  final List<ActivityItem> recentActivities;
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

D:\Dev\ogrenci_intelligence\lib\src\features\student_dashboard\data\student_dashboard_repository.dart


import 'package:supabase_flutter/supabase_flutter.dart';

import '../domain/student_dashboard_models.dart';

class StudentDashboardRepository {
  StudentDashboardRepository(this._client);

  final SupabaseClient _client;

  Future<StudentDashboardVm> fetchDashboard({required String userId}) async {
    // 1) Profile: name + points (+ department)
    final profileRows = await _client
        .from('profiles')
        .select('id, email, full_name, total_points, department')
        .eq('id', userId)
        .limit(1);

    final profile = profileRows.isNotEmpty ? profileRows.first : <String, dynamic>{};

    final fullName = (profile['full_name'] as String?)?.trim();
    final email = (profile['email'] as String?)?.trim();

    final displayName = (fullName != null && fullName.isNotEmpty)
        ? fullName
        : (email != null && email.contains('@'))
            ? email.split('@').first
            : 'Öğrenci';

    final totalPoints = (profile['total_points'] as int?) ?? 0;

    // 2) Completed courses count
    final completedRows = await _client
        .from('completed_courses')
        .select('id')
        .eq('user_id', userId);

    final coursesCompleted = completedRows.length;

    // 3) Ongoing courses count + list (progress < 100)
    final ongoingEnrollRows = await _client
        .from('course_enrollments')
        .select('course_id, progress, enrolled_at')
        .eq('user_id', userId)
        .lt('progress', 100)
        .order('enrolled_at', ascending: false);

    final ongoingCoursesCount = ongoingEnrollRows.length;

    // take top 3 for the dashboard card
    final ongoingTop = ongoingEnrollRows.take(3).toList();
    final courseIds = ongoingTop
        .map((e) => (e['course_id'] as String?) ?? '')
        .where((id) => id.isNotEmpty)
        .toList();

    Map<String, Map<String, dynamic>> courseById = {};
    if (courseIds.isNotEmpty) {
      final courseRows = await _client
          .from('courses')
          .select('id, title, description, duration, level')
          .inFilter('id', courseIds);

      courseById = {
        for (final r in courseRows)
          (r['id'] as String): (r as Map<String, dynamic>),
      };
    }

    final enrolledCourses = <EnrolledCourse>[
      for (final enr in ongoingTop)
        () {
          final cid = (enr['course_id'] as String?) ?? '';
          final c = courseById[cid] ?? const <String, dynamic>{};

          final title = (c['title'] as String?) ?? 'Kurs';
          final description = (c['description'] as String?) ?? '';
          final duration = (c['duration'] as String?) ?? '';
          final level = (c['level'] as String?) ?? '';

          final progress = (enr['progress'] as int?) ?? 0;

          return EnrolledCourse(
            courseId: cid,
            title: title,
            description: description,
            duration: duration,
            level: level,
            progress: progress.clamp(0, 100),
          );
        }(),
    ];

    // 4) Active applications count (pending)
    final jobPending = await _client
        .from('job_applications')
        .select('id')
        .eq('user_id', userId)
        .eq('status', 'pending');

    final internshipPending = await _client
        .from('internship_applications')
        .select('id')
        .eq('user_id', userId)
        .eq('status', 'pending');

    final activeApplications = jobPending.length + internshipPending.length;

    // 5) Department rank (optional): latest snapshot for user
    int? departmentRank;
    final lb = await _client
        .from('leaderboard_snapshots')
        .select('rank_department, created_at')
        .eq('user_id', userId)
        .order('created_at', ascending: false)
        .limit(1);

    if (lb.isNotEmpty) {
      departmentRank = (lb.first['rank_department'] as int?);
    }

    // 6) Activities (from activity_logs)
    final activityRows = await _client
        .from('activity_logs')
        .select('category, action, points, created_at')
        .eq('user_id', userId)
        .order('created_at', ascending: false)
        .limit(6);

    final activities = <ActivityItem>[
      for (final r in activityRows)
        ActivityItem(
          category: _mapCategory((r['category'] as String?) ?? ''),
          action: (r['action'] as String?) ?? '',
          points: (r['points'] as int?) ?? 0,
          createdAt: DateTime.tryParse((r['created_at'] as String?) ?? '')?.toLocal() ??
              DateTime.now(),
        ),
    ];

    // 7) Today + week points (sum activity_logs.points)
    final now = DateTime.now();
    final startOfDay = DateTime(now.year, now.month, now.day);
    final startOfWeek = startOfDay.subtract(Duration(days: now.weekday - 1)); // Monday

    final todayRows = await _client
        .from('activity_logs')
        .select('points, created_at')
        .eq('user_id', userId)
        .gte('created_at', startOfDay.toUtc().toIso8601String());

    final weekRows = await _client
        .from('activity_logs')
        .select('points, created_at')
        .eq('user_id', userId)
        .gte('created_at', startOfWeek.toUtc().toIso8601String());

    final todayPoints = todayRows.fold<int>(0, (sum, r) => sum + ((r['points'] as int?) ?? 0));
    final weekPoints = weekRows.fold<int>(0, (sum, r) => sum + ((r['points'] as int?) ?? 0));

    final stats = DashboardStats(
      totalPoints: totalPoints,
      coursesCompleted: coursesCompleted,
      activeApplications: activeApplications,
      ongoingCourses: ongoingCoursesCount,
      departmentRank: departmentRank,
    );

    return StudentDashboardVm(
      displayName: displayName,
      stats: stats,
      enrolledCourses: enrolledCourses,
      activities: activities,
      todayPoints: todayPoints,
      weekPoints: weekPoints,
    );
  }

  static ActivityCategory _mapCategory(String raw) {
    switch (raw.trim().toLowerCase()) {
      case 'course':
        return ActivityCategory.course;
      case 'job':
        return ActivityCategory.job;
      case 'internship':
        return ActivityCategory.internship;
      case 'achievement':
        return ActivityCategory.achievement;
      case 'platform':
        return ActivityCategory.platform;
      default:
        return ActivityCategory.platform;
    }
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\features\student_dashboard\presentation\controllers\student_dashboard_controller.dart


import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../auth/presentation/controllers/auth_controller.dart';
import '../../data/student_dashboard_repository.dart';
import '../../domain/student_dashboard_models.dart';

final studentDashboardRepositoryProvider = Provider<StudentDashboardRepository>((ref) {
  return StudentDashboardRepository(Supabase.instance.client);
});

final studentDashboardProvider =
    AutoDisposeAsyncNotifierProvider<StudentDashboardController, StudentDashboardVm>(
  StudentDashboardController.new,
);

class StudentDashboardController extends AutoDisposeAsyncNotifier<StudentDashboardVm> {
  @override
  Future<StudentDashboardVm> build() async {
    final auth = ref.watch(authViewStateProvider).value;
    final userId = auth?.user?.id;

    if (userId == null) {
      throw Exception('Not authenticated (studentDashboardProvider)');
    }

    final repo = ref.watch(studentDashboardRepositoryProvider);
    return repo.fetchDashboard(userId: userId);
  }

  Future<void> refresh() async {
    state = const AsyncLoading();
    state = await AsyncValue.guard(build);
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\features\student_dashboard\presentation\screens\student_dashboard_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../domain/student_dashboard_models.dart';
import '../controllers/student_dashboard_controller.dart';

class StudentDashboardScreen extends ConsumerWidget {
  const StudentDashboardScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashAsync = ref.watch(studentDashboardProvider);

    // NOTE: MainShell already provides Scaffold + Navbar + Footer.
    // So this screen should be BODY content, not another Scaffold.
    return dashAsync.when(
      loading: () => const _DashboardLoading(),
        error: (e, _) => Center(
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Icon(Icons.error_outline, size: 48, color: Color(0xFFEF4444)),
                const SizedBox(height: 12),
                const Text(
                  'Dashboard yüklenemedi',
                  style: TextStyle(fontWeight: FontWeight.w900, fontSize: 16),
                ),
                const SizedBox(height: 8),
                Text(
                  e.toString(),
                  textAlign: TextAlign.center,
                  style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
                ),
                const SizedBox(height: 14),
                SizedBox(
                  height: 44,
                  child: ElevatedButton(
                    onPressed: () => ref.read(studentDashboardProvider.notifier).refresh(),
                    child: const Text('Tekrar dene'),
                  ),
                ),
              ],
            ),
          ),
        ),
              data: (vm) {
        final stats = vm.stats;

        return Container(
          color: const Color(0xFFF9FAFB),
          child: RefreshIndicator(
            onRefresh: () => ref.read(studentDashboardProvider.notifier).refresh(),
            child: SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              child: Center(
                child: ConstrainedBox(
                  constraints: const BoxConstraints(maxWidth: 1120),
                  child: Padding(
                    padding: const EdgeInsets.fromLTRB(16, 22, 16, 28),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Welcome
                        Text(
                          'Hoş Geldin, ${vm.displayName}! 👋',
                          style: const TextStyle(fontSize: 28, fontWeight: FontWeight.w900),
                        ),
                        const SizedBox(height: 6),
                        const Text(
                          'Bugün kariyerine yön verecek yeni fırsatlar seni bekliyor.',
                          style: TextStyle(
                            color: Color(0xFF6B7280),
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                        const SizedBox(height: 18),

                        // Stats cards (4)
                        LayoutBuilder(
                          builder: (_, c) {
                            final w = c.maxWidth;
                            final isWide = w >= 980;

                            final cards = <Widget>[
                              _StatCard(
                                icon: Icons.emoji_events_outlined,
                                iconBg: const Color(0xFFEDE9FE),
                                iconColor: const Color(0xFF7C3AED),
                                title: 'Toplam Puan',
                                value: '${stats.totalPoints}',
                                subtitle: stats.departmentRank != null
                                    ? 'Bölüm sıralaması: ${stats.departmentRank}.'
                                    : null,
                              ),
                              _StatCard(
                                icon: Icons.menu_book_outlined,
                                iconBg: const Color(0xFFDBEAFE),
                                iconColor: const Color(0xFF2563EB),
                                title: 'Tamamlanan Kurs',
                                value: '${stats.coursesCompleted}',
                              ),
                              _StatCard(
                                icon: Icons.work_outline,
                                iconBg: const Color(0xFFDCFCE7),
                                iconColor: const Color(0xFF16A34A),
                                title: 'Aktif Başvuru',
                                value: '${stats.activeApplications}',
                              ),
                              _StatCard(
                                icon: Icons.track_changes_outlined,
                                iconBg: const Color(0xFFFEF3C7),
                                iconColor: const Color(0xFFD97706),
                                title: 'Devam Eden Kurs',
                                value: '${stats.ongoingCourses}',
                              ),
                            ];

                            if (isWide) {
                              return Row(
                                children: [
                                  for (int i = 0; i < cards.length; i++) ...[
                                    Expanded(child: cards[i]),
                                    if (i != cards.length - 1) const SizedBox(width: 14),
                                  ],
                                ],
                              );
                            }

                            // 2x2 wrap on smaller screens
                            final half = (w - 14) / 2;
                            return Wrap(
                              spacing: 14,
                              runSpacing: 14,
                              children: cards.map((e) => SizedBox(width: half, child: e)).toList(),
                            );
                          },
                        ),

                        const SizedBox(height: 16),

                        // Big Points Widget (gradient)
                        _PointsHero(
                          totalPoints: stats.totalPoints,
                          departmentRank: stats.departmentRank,
                          onLeaderboard: () => context.go(Routes.leaderboard),
                          onHowToPoints: () => context.go(Routes.pointsSystem),
                          todayPoints: vm.todayPoints,
                          weekPoints: vm.weekPoints,
                          coursesCompleted: stats.coursesCompleted,
                          nextTarget: _nextTarget(stats.totalPoints),
                        ),

                        const SizedBox(height: 18),

                        // 2-col grid: left = ongoing courses, right = activities
                        LayoutBuilder(
                          builder: (_, c) {
                            final isWide = c.maxWidth >= 1024;

                            final left = _OngoingCoursesCard(
                              enrolledCourses: vm.enrolledCourses,
                              onSeeAll: () => context.go(Routes.courses),
                            );

                            final right = _RecentActivitiesCard(activities: vm.activities);

                            if (!isWide) {
                              return Column(
                                children: [
                                  left,
                                  const SizedBox(height: 14),
                                  right,
                                ],
                              );
                            }

                            return Row(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Expanded(flex: 2, child: left),
                                const SizedBox(width: 16),
                                SizedBox(width: 360, child: right),
                              ],
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  static int _nextTarget(int points) {
    if (points < 100) return 100;
    if (points < 500) return 500;
    if (points < 1000) return 1000;
    if (points < 5000) return 5000;
    return 10000;
  }
}

class _DashboardLoading extends StatelessWidget {
  const _DashboardLoading();

  @override
  Widget build(BuildContext context) {
    return const Center(
      child: Padding(
        padding: EdgeInsets.all(24),
        child: CircularProgressIndicator(),
      ),
    );
  }
}

/* ----------------------------- UI Widgets ----------------------------- */

class _StatCard extends StatelessWidget {
  const _StatCard({
    required this.icon,
    required this.iconBg,
    required this.iconColor,
    required this.title,
    required this.value,
    this.subtitle,
  });

  final IconData icon;
  final Color iconBg;
  final Color iconColor;
  final String title;
  final String value;
  final String? subtitle;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [
          BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8)),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 46,
                height: 46,
                decoration: BoxDecoration(
                  color: iconBg,
                  borderRadius: BorderRadius.circular(14),
                ),
                child: Icon(icon, color: iconColor),
              ),
              const Spacer(),
              const Icon(Icons.trending_up, color: Color(0xFF10B981)),
            ],
          ),
          const SizedBox(height: 12),
          Text(value, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
          const SizedBox(height: 4),
          Text(title, style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700)),
          if (subtitle != null) ...[
            const SizedBox(height: 6),
            Text(subtitle!,
                style: const TextStyle(color: Color(0xFF7C3AED), fontWeight: FontWeight.w800, fontSize: 12)),
          ],
        ],
      ),
    );
  }
}

class _PointsHero extends StatelessWidget {
  const _PointsHero({
    required this.totalPoints,
    required this.departmentRank,
    required this.onLeaderboard,
    required this.onHowToPoints,
    required this.todayPoints,
    required this.weekPoints,
    required this.coursesCompleted,
    required this.nextTarget,
  });

  final int totalPoints;
  final int? departmentRank;

  final VoidCallback onLeaderboard;
  final VoidCallback onHowToPoints;

  final int todayPoints;
  final int weekPoints;
  final int coursesCompleted;
  final int nextTarget;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(18),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        gradient: const LinearGradient(
          colors: [Color(0xFF7C3AED), Color(0xFF4F46E5)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        boxShadow: const [
          BoxShadow(color: Color(0x22000000), blurRadius: 22, offset: Offset(0, 10)),
        ],
      ),
      child: Column(
        children: [
          LayoutBuilder(
            builder: (_, c) {
              final isWide = c.maxWidth >= 860;

              final left = Row(
                children: [
                  const Icon(Icons.emoji_events, size: 56, color: Color(0x88FFFFFF)),
                  const SizedBox(width: 14),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('Puan Durumun',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.w900)),
                      const SizedBox(height: 6),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text('$totalPoints',
                              style: const TextStyle(color: Colors.white, fontSize: 34, fontWeight: FontWeight.w900)),
                          const SizedBox(width: 6),
                          const Padding(
                            padding: EdgeInsets.only(bottom: 5),
                            child: Text('Puan', style: TextStyle(color: Color(0xCCFFFFFF), fontWeight: FontWeight.w800)),
                          ),
                        ],
                      ),
                      if (departmentRank != null) ...[
                        const SizedBox(height: 4),
                        Text(
                          'Bölüm sıralaması: $departmentRank.',
                          style: const TextStyle(color: Color(0xCCFFFFFF), fontWeight: FontWeight.w800),
                        ),
                      ],
                    ],
                  ),
                ],
              );

              final buttons = Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  SizedBox(
                    height: 44,
                    child: ElevatedButton.icon(
                      onPressed: onLeaderboard,
                      icon: const Icon(Icons.workspace_premium_outlined),
                      label: const Text('Sıralamayı Gör', style: TextStyle(fontWeight: FontWeight.w900)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFFFBBF24),
                        foregroundColor: const Color(0xFF111827),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        elevation: 0,
                      ),
                    ),
                  ),
                  SizedBox(
                    height: 44,
                    child: ElevatedButton.icon(
                      onPressed: onHowToPoints,
                      icon: const Icon(Icons.track_changes_outlined),
                      label: const Text('Nasıl Puan Kazanırım?', style: TextStyle(fontWeight: FontWeight.w900)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        foregroundColor: const Color(0xFF6D28D9),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        elevation: 0,
                      ),
                    ),
                  ),
                ],
              );

              if (!isWide) {
                return Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    left,
                    const SizedBox(height: 14),
                    buttons,
                  ],
                );
              }

              return Row(
                children: [
                  Expanded(child: left),
                  const SizedBox(width: 12),
                  buttons,
                ],
              );
            },
          ),

          const SizedBox(height: 16),
          Container(height: 1, color: const Color(0x44FFFFFF)),
          const SizedBox(height: 16),

          LayoutBuilder(
            builder: (_, c) {
              final isWide = c.maxWidth >= 860;
              final items = <Widget>[
                _MiniMetric(title: 'Bugün', value: '+$todayPoints puan'),
                _MiniMetric(title: 'Bu Hafta', value: '+$weekPoints puan'),
                _MiniMetric(title: 'Kurs Tamamlama', value: '$coursesCompleted'),
                _MiniMetric(title: 'Sonraki Hedef', value: '$nextTarget puan'),
              ];

              if (isWide) {
                return Row(
                  children: [
                    for (int i = 0; i < items.length; i++) ...[
                      Expanded(child: items[i]),
                      if (i != items.length - 1) const SizedBox(width: 10),
                    ],
                  ],
                );
              }

              return Wrap(
                spacing: 10,
                runSpacing: 10,
                children: items.map((e) => SizedBox(width: (c.maxWidth - 10) / 2, child: e)).toList(),
              );
            },
          ),
        ],
      ),
    );
  }
}

class _MiniMetric extends StatelessWidget {
  const _MiniMetric({required this.title, required this.value});
  final String title;
  final String value;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 10, horizontal: 10),
      decoration: BoxDecoration(
        color: const Color(0x1AFFFFFF),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: const Color(0x22FFFFFF)),
      ),
      child: Column(
        children: [
          Text(title,
              style: const TextStyle(color: Color(0xCCFFFFFF), fontWeight: FontWeight.w800, fontSize: 12)),
          const SizedBox(height: 6),
          Text(value, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
        ],
      ),
    );
  }
}

class _OngoingCoursesCard extends StatelessWidget {
  const _OngoingCoursesCard({required this.enrolledCourses, required this.onSeeAll});
  final List<EnrolledCourse> enrolledCourses;
  final VoidCallback onSeeAll;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8))],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              const Icon(Icons.menu_book_outlined, color: Color(0xFF2563EB)),
              const SizedBox(width: 8),
              const Expanded(
                child: Text('Devam Eden Kurslarım', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
              ),
              TextButton(onPressed: onSeeAll, child: const Text('Tümünü Gör →')),
            ],
          ),
          const SizedBox(height: 12),

          if (enrolledCourses.isEmpty)
            Center(
              child: Padding(
                padding: const EdgeInsets.symmetric(vertical: 22),
                child: Column(
                  children: [
                    const Icon(Icons.menu_book, size: 46, color: Color(0xFFD1D5DB)),
                    const SizedBox(height: 10),
                    const Text('Henüz kayıtlı kursunuz yok.',
                        style: TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700)),
                    const SizedBox(height: 10),
                    OutlinedButton(onPressed: onSeeAll, child: const Text('Kursları Keşfet →')),
                  ],
                ),
              ),
            )
          else
            Column(
              children: enrolledCourses.map((e) => _EnrolledCourseTile(course: e)).toList(),
            ),
        ],
      ),
    );
  }
}

class _EnrolledCourseTile extends StatelessWidget {
  const _EnrolledCourseTile({required this.course});
  final EnrolledCourse course;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: const Color(0xFFE5E7EB)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Expanded(
                child: Text(course.title, style: const TextStyle(fontWeight: FontWeight.w900)),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                decoration: BoxDecoration(
                  color: const Color(0xFFDBEAFE),
                  borderRadius: BorderRadius.circular(999),
                ),
                child: Text(course.level,
                    style: const TextStyle(color: Color(0xFF1D4ED8), fontWeight: FontWeight.w900, fontSize: 12)),
              ),
            ],
          ),
          const SizedBox(height: 6),
          Text(
            course.description,
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
          ),
          const SizedBox(height: 10),
          Row(
            children: [
              const Icon(Icons.access_time, size: 16, color: Color(0xFF6B7280)),
              const SizedBox(width: 6),
              Text(course.duration,
                  style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700, fontSize: 12)),
              const Spacer(),
              SizedBox(
                width: 150,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(999),
                      child: LinearProgressIndicator(
                        value: course.progress / 100,
                        minHeight: 8,
                        backgroundColor: const Color(0xFFE5E7EB),
                        valueColor: const AlwaysStoppedAnimation(Color(0xFF2563EB)),
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text('%${course.progress} tamamlandı',
                        style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700, fontSize: 12)),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

class _RecentActivitiesCard extends StatelessWidget {
  const _RecentActivitiesCard({required this.activities});
  final List<ActivityItem> activities;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8))],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Row(
            children: [
              Icon(Icons.local_activity_outlined, color: Color(0xFF7C3AED)),
              SizedBox(width: 8),
              Expanded(
                child: Text('Son Aktiviteler', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
              ),
            ],
          ),
          const SizedBox(height: 12),

          if (activities.isEmpty)
            const Padding(
              padding: EdgeInsets.symmetric(vertical: 22),
              child: Center(
                child: Text('Henüz aktivite yok.',
                    style: TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700)),
              ),
            )
          else
            Column(
              children: activities.map((a) => _ActivityRow(activity: a)).toList(),
            ),
        ],
      ),
    );
  }
}

class _ActivityRow extends StatelessWidget {
  const _ActivityRow({required this.activity});
  final ActivityItem activity;

  @override
  Widget build(BuildContext context) {
    final style = _activityStyle(activity.category);

    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: style.bg,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(style.icon, color: style.fg, size: 20),
          ),
          const SizedBox(width: 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(activity.action, style: const TextStyle(fontWeight: FontWeight.w800)),
                const SizedBox(height: 3),
                Row(
                  children: [
                    Text(_dateText(activity.createdAt),
                        style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700, fontSize: 12)),
                    const Spacer(),
                    if (activity.points > 0)
                      Text('+${activity.points} puan',
                          style: const TextStyle(color: Color(0xFF10B981), fontWeight: FontWeight.w900, fontSize: 12)),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  static String _dateText(DateTime dt) {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);
    final d = DateTime(dt.year, dt.month, dt.day);

    final diffDays = today.difference(d).inDays;

    if (diffDays == 0) return 'Bugün';
    if (diffDays == 1) return 'Dün';
    if (diffDays < 7) return '$diffDays gün önce';
    return '${dt.day.toString().padLeft(2, '0')}.${dt.month.toString().padLeft(2, '0')}.${dt.year}';
  }

  static _ActStyle _activityStyle(ActivityCategory c) {
    switch (c) {
      case ActivityCategory.course:
        return const _ActStyle(icon: Icons.menu_book_outlined, fg: Color(0xFF2563EB), bg: Color(0xFFDBEAFE));
      case ActivityCategory.job:
        return const _ActStyle(icon: Icons.work_outline, fg: Color(0xFF7C3AED), bg: Color(0xFFEDE9FE));
      case ActivityCategory.internship:
        return const _ActStyle(icon: Icons.business_center_outlined, fg: Color(0xFF16A34A), bg: Color(0xFFDCFCE7));
      case ActivityCategory.achievement:
        return const _ActStyle(icon: Icons.emoji_events_outlined, fg: Color(0xFFD97706), bg: Color(0xFFFEF3C7));
      case ActivityCategory.platform:
        return const _ActStyle(icon: Icons.bolt_outlined, fg: Color(0xFF4B5563), bg: Color(0xFFF3F4F6));
    }
  }
}

class _ActStyle {
  const _ActStyle({required this.icon, required this.fg, required this.bg});
  final IconData icon;
  final Color fg;
  final Color bg;
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/courses/domain/course_models.dart

import 'package:flutter/foundation.dart';

@immutable
class Course {
  const Course({
    required this.id,
    required this.title,
    this.description,
    this.department,
    this.duration,
    this.level,
    this.instructor,
    this.category,
    this.rating = 0.0,
    this.totalRatings = 0,
    this.enrolledCount = 0,
    this.videoUrl,
    this.pointsEnrollment = 10,
    this.pointsCompletion = 50,
  });

  final String id;
  final String title;

  final String? description;
  final String? department;
  final String? duration;   // e.g. "4 saat"
  final String? level;      // e.g. "Başlangıç"
  final String? instructor; // e.g. "Dr. X"
  final String? category;   // derived/optional (React concept)

  final double rating;      // derived/optional
  final int totalRatings;   // derived/optional
  final int enrolledCount;  // derived/optional

  final String? videoUrl;

  // UI points (match React concept; later compute from DB/config)
  final int pointsEnrollment;
  final int pointsCompletion;

  factory Course.fromMap(Map<String, dynamic> map) {
    return Course(
      id: map['id'] as String,
      title: (map['title'] as String?) ?? '',
      description: map['description'] as String?,
      department: map['department'] as String?,
      videoUrl: map['video_url'] as String?,
      duration: map['duration'] as String?,
      level: map['level'] as String?,
      instructor: map['instructor'] as String?,
      // optional/derived fields (if later you include them in select)
      category: map['category'] as String?,
      rating: (map['rating'] as num?)?.toDouble() ?? 0.0,
      totalRatings: (map['total_ratings'] as int?) ?? 0,
      enrolledCount: (map['enrolled_count'] as int?) ?? 0,
    );
  }
}

@immutable
class CourseEnrollment {
  const CourseEnrollment({
    required this.id,
    required this.userId,
    required this.courseId,
    required this.progress,
    this.enrolledAt,
  });

  final String id;
  final String userId;
  final String courseId;
  final int progress; // 0..100
  final DateTime? enrolledAt;

  factory CourseEnrollment.fromMap(Map<String, dynamic> map) {
    return CourseEnrollment(
      id: map['id'] as String,
      userId: map['user_id'] as String,
      courseId: map['course_id'] as String,
      progress: (map['progress'] as int?) ?? 0,
      enrolledAt: map['enrolled_at'] == null
          ? null
          : DateTime.tryParse(map['enrolled_at'].toString()),
    );
  }
}

@immutable
class EnrolledCourse {
  const EnrolledCourse({
    required this.course,
    required this.enrollment,
  });

  final Course course;
  final CourseEnrollment enrollment;
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/courses/data/courses_repository.dart

import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../core/supabase/supabase_service.dart';
import '../domain/course_models.dart';

class CoursesRepository {
  CoursesRepository({SupabaseClient? client})
      : _client = client ?? SupabaseService.client;

  final SupabaseClient _client;

  Future<List<Course>> listCourses({
    String? search,
    String? department,
    String? level,
  }) async {
    PostgrestFilterBuilder qb = _client
        .from('courses')
        .select('id,title,description,department,video_url,duration,level,instructor');

    final q = (search ?? '').trim();
    if (q.isNotEmpty) {
      qb = qb.ilike('title', '%$q%');
    }
    if (department != null && department.trim().isNotEmpty) {
      qb = qb.eq('department', department.trim());
    }
    if (level != null && level.trim().isNotEmpty) {
      qb = qb.eq('level', level.trim());
    }

    final rows = await qb.order('title', ascending: true) as List<dynamic>;
    return rows
    .map((e) => Course.fromMap(Map<String, dynamic>.from(e as Map)))
    .toList();
  }

  Future<Course> getCourseById(String courseId) async {
    final row = await _client
        .from('courses')
        .select('id,title,description,department,video_url,duration,level,instructor')
        .eq('id', courseId)
        .single();

    return Course.fromMap(row);
  }

  Future<CourseEnrollment?> getMyEnrollment({
    required String userId,
    required String courseId,
  }) async {
    // Using .limit(1) to be version-safe (instead of maybeSingle()).
    final rows = await _client
        .from('course_enrollments')
        .select('id,user_id,course_id,enrolled_at,progress')
        .eq('user_id', userId)
        .eq('course_id', courseId)
        .limit(1) as List<dynamic>;

    if (rows.isEmpty) return null;
    return CourseEnrollment.fromMap(Map<String, dynamic>.from(rows.first as Map));
  }

  Future<List<EnrolledCourse>> listMyEnrolledCourses(String userId) async {
    // FK exists: course_enrollments.course_id -> courses.id
    final rows = await _client
        .from('course_enrollments')
        .select(
          'id,user_id,course_id,enrolled_at,progress,'
          'courses(id,title,description,department,video_url,duration,level,instructor)',
        )
        .eq('user_id', userId)
        .order('enrolled_at', ascending: false) as List<dynamic>;

    return rows.map((r) {
      final map = Map<String, dynamic>.from(r as Map);
      final enrollment = CourseEnrollment.fromMap(map);

      final rawCourse = map['courses'];
final courseMap = rawCourse == null ? null : Map<String, dynamic>.from(rawCourse as Map);
      final course = courseMap == null
          ? Course(
              id: enrollment.courseId,
              title: 'Course',
            )
          : Course.fromMap(courseMap);

      return EnrolledCourse(course: course, enrollment: enrollment);
    }).toList();
  }

  Future<void> enroll({
    required String userId,
    required String courseId,
  }) async {
    await _client.from('course_enrollments').insert({
      'user_id': userId,
      'course_id': courseId,
      'progress': 0,
    });
  }

  Future<void> unenroll({
    required String userId,
    required String courseId,
  }) async {
    await _client
        .from('course_enrollments')
        .delete()
        .eq('user_id', userId)
        .eq('course_id', courseId);
  }

  Future<void> updateProgress({
    required String enrollmentId,
    required int progress,
  }) async {
    final p = progress.clamp(0, 100);
    await _client
        .from('course_enrollments')
        .update({'progress': p})
        .eq('id', enrollmentId);
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/courses/data/fake_courses_repository.dart

import 'dart:math';
import '../domain/course_models.dart';

class FakeCoursesRepository {
  FakeCoursesRepository() : _courses = _seed();

  final List<Course> _courses;

  Future<List<Course>> listCourses({
    String? search,
    String? department,
    String? level,
  }) async {
    await Future<void>.delayed(const Duration(milliseconds: 250));

    Iterable<Course> out = _courses;

    final q = (search ?? '').trim().toLowerCase();
    if (q.isNotEmpty) {
      out = out.where((c) => c.title.toLowerCase().contains(q));
    }

    final dep = (department ?? '').trim();
    if (dep.isNotEmpty) {
      out = out.where((c) => (c.department ?? '') == dep);
    }

    final lev = (level ?? '').trim();
    if (lev.isNotEmpty) {
      out = out.where((c) => (c.level ?? '') == lev);
    }

    return out.toList();
  }

  Future<Course?> getCourseById(String courseId) async {
    await Future<void>.delayed(const Duration(milliseconds: 150));
    try {
      return _courses.firstWhere((c) => c.id == courseId);
    } catch (_) {
      return null;
    }
  }

  static List<Course> _seed() {
    final rng = Random(42);
    // ignore: unused_element
    double r() => (rng.nextInt(17) + 30) / 10.0; // 3.0..4.6
    // using r() is optional; keeping seed constant is fine

    return const [
      Course(
        id: 'c-001',
        title: 'Programlamaya Giriş',
        description: 'Algoritma mantığı, temel veri tipleri, koşullar ve döngüler.',
        department: 'Bilgisayar Mühendisliği',
        duration: '4 saat',
        level: 'Başlangıç',
        instructor: 'Dr. A. Yılmaz',
        category: 'Temel Dersler',
        rating: 4.4,
        totalRatings: 128,
        enrolledCount: 1240,
        videoUrl: 'https://example.com/video1',
      ),
      Course(
        id: 'c-002',
        title: 'Veri Yapıları',
        description: 'Liste, yığın, kuyruk, ağaç ve karmaşıklık analizi.',
        department: 'Bilgisayar Mühendisliği',
        duration: '6 saat',
        level: 'Orta',
        instructor: 'Doç. B. Kaya',
        category: 'Alan Dersleri',
        rating: 4.6,
        totalRatings: 221,
        enrolledCount: 980,
        videoUrl: 'https://example.com/video2',
      ),
      Course(
        id: 'c-003',
        title: 'SQL Temelleri',
        description: 'SELECT, JOIN, indeks mantığı, normalizasyon ve pratik örnekler.',
        department: 'Bilgisayar Mühendisliği',
        duration: '3 saat',
        level: 'Başlangıç',
        instructor: 'M. Demir',
        category: 'Yazılım',
        rating: 4.2,
        totalRatings: 87,
        enrolledCount: 1540,
      ),
      Course(
        id: 'c-004',
        title: 'Staj Başvuru Rehberi',
        description: 'CV, mülakat, portföy ve başvuru stratejileri.',
        department: 'Bilgisayar Mühendisliği',
        duration: '2 saat',
        level: 'Herkes',
        instructor: 'Kariyer Ofisi',
        category: 'Kariyer',
        rating: 4.1,
        totalRatings: 54,
        enrolledCount: 720,
      ),
      Course(
        id: 'c-005',
        title: 'Flutter ile Mobil UI',
        description: 'Widget mantığı, layout, state, komponentleşme ve best practices.',
        department: 'Bilgisayar Mühendisliği',
        duration: '5 saat',
        level: 'Orta',
        instructor: 'Eng. C. Aslan',
        category: 'Yazılım',
        rating: 4.5,
        totalRatings: 199,
        enrolledCount: 610,
      ),
      Course(
        id: 'c-006',
        title: 'Veri Bilimine Giriş',
        description: 'Temel istatistik, veri hazırlama, basit modelleme.',
        department: 'Bilgisayar Mühendisliği',
        duration: '4 saat',
        level: 'Başlangıç',
        instructor: 'Dr. D. Şahin',
        category: 'Veri Bilimi',
        rating: 4.0,
        totalRatings: 73,
        enrolledCount: 430,
      ),
    ];
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/courses/application/courses_providers.dart


import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../data/courses_repository.dart';
import '../data/fake_courses_repository.dart';
import '../presentation/state/courses_controller.dart';

final coursesRepositoryProvider = Provider<CoursesRepository>((ref) {
  return FakeCoursesRepository();
});

final coursesControllerProvider =
    StateNotifierProvider<CoursesController, CoursesState>((ref) {
  final repo = ref.watch(coursesRepositoryProvider);
  return CoursesController(repo)..load();
});

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/courses/presentation/state/courses_controller.dart

import 'package:flutter/foundation.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../data/courses_repository.dart';
import '../../domain/course_models.dart';

@immutable
class CoursesState {
  const CoursesState({
    this.isLoading = false,
    this.error,
    this.query = '',
    this.category = 'Tümü',
    this.courses = const <Course>[],
    this.favorites = const <String>{},
    this.enrolled = const <String>{},
    this.completed = const <String>{},
    this.progressByCourse = const <String, int>{}, // 0..100
    this.earnedPoints = 0,
    this.enrollmentPointsGiven = const <String>{},
    this.completionPointsGiven = const <String>{},
  });

  final bool isLoading;
  final String? error;

  final String query;
  final String category;

  final List<Course> courses;

  final Set<String> favorites;
  final Set<String> enrolled;
  final Set<String> completed;

  final Map<String, int> progressByCourse;

  final int earnedPoints;

  // prevent double-award in UI-first mode
  final Set<String> enrollmentPointsGiven;
  final Set<String> completionPointsGiven;

  CoursesState copyWith({
    bool? isLoading,
    String? error,
    String? query,
    String? category,
    List<Course>? courses,
    Set<String>? favorites,
    Set<String>? enrolled,
    Set<String>? completed,
    Map<String, int>? progressByCourse,
    int? earnedPoints,
    Set<String>? enrollmentPointsGiven,
    Set<String>? completionPointsGiven,
  }) {
    return CoursesState(
      isLoading: isLoading ?? this.isLoading,
      error: error,
      query: query ?? this.query,
      category: category ?? this.category,
      courses: courses ?? this.courses,
      favorites: favorites ?? this.favorites,
      enrolled: enrolled ?? this.enrolled,
      completed: completed ?? this.completed,
      progressByCourse: progressByCourse ?? this.progressByCourse,
      earnedPoints: earnedPoints ?? this.earnedPoints,
      enrollmentPointsGiven: enrollmentPointsGiven ?? this.enrollmentPointsGiven,
      completionPointsGiven: completionPointsGiven ?? this.completionPointsGiven,
    );
  }
}

class CoursesController extends StateNotifier<CoursesState> {
  CoursesController(this._repo) : super(const CoursesState());

  final CoursesRepository _repo;

  static const categories = <String>[
    'Tümü',
    'Temel Dersler',
    'Alan Dersleri',
    'Seçmeli Dersler',
    'Yazılım',
    'Veri Bilimi',
    'Kariyer',
    'Kişisel Gelişim',
  ];

  Future<void> load() async {
    state = state.copyWith(isLoading: true, error: null);

    try {
      // DB fetch (title search supported). Category is UI-only for now.
      final list = await _repo.listCourses(
        search: state.query,
        department: null,
        level: null,
      );

      // If category filter is used, filter locally (since DB has no "category" yet)
      final filtered = (state.category == 'Tümü')
          ? list
          : list.where((c) => (c.category ?? '') == state.category).toList();

      state = state.copyWith(isLoading: false, courses: filtered);
    } catch (e) {
      state = state.copyWith(isLoading: false, error: e.toString());
    }
  }

  void setQuery(String v) {
    state = state.copyWith(query: v);
    // optional: auto reload on query change
    // unawaited(load());
  }

  void setCategory(String v) {
    state = state.copyWith(category: v);
    // optional: auto reload (since we filter locally, no need)
    // state = state.copyWith(courses: ...)
  }

  void toggleFavorite(String courseId) {
    final next = {...state.favorites};
    if (next.contains(courseId)) {
      next.remove(courseId);
    } else {
      next.add(courseId);
    }
    state = state.copyWith(favorites: next);
  }

  void enroll(String courseId) {
    if (state.enrolled.contains(courseId)) return;

    final nextEnrolled = {...state.enrolled, courseId};
    final nextProgress = {...state.progressByCourse, courseId: 0};

    // award enrollment points once
    var earned = state.earnedPoints;
    final given = {...state.enrollmentPointsGiven};

    final course = state.courses.firstWhereOrNull((c) => c.id == courseId);
    if (!given.contains(courseId) && course != null) {
      earned += course.pointsEnrollment;
      given.add(courseId);
    }

    state = state.copyWith(
      enrolled: nextEnrolled,
      progressByCourse: nextProgress,
      earnedPoints: earned,
      enrollmentPointsGiven: given,
    );
  }

  void markModuleComplete(String courseId, int moduleIndex, {int totalModules = 5}) {
    if (!state.enrolled.contains(courseId)) return;

    final target = (((moduleIndex + 1) / totalModules) * 100).round().clamp(0, 100);
    final current = state.progressByCourse[courseId] ?? 0;
    if (target <= current) return;

    final next = {...state.progressByCourse, courseId: target};
    state = state.copyWith(progressByCourse: next);
  }

  void completeCourse(String courseId) {
    if (!state.enrolled.contains(courseId)) return;

    final nextCompleted = {...state.completed, courseId};
    final nextProgress = {...state.progressByCourse, courseId: 100};

    // award completion points once
    var earned = state.earnedPoints;
    final given = {...state.completionPointsGiven};

    final course = state.courses.firstWhereOrNull((c) => c.id == courseId);
    if (!given.contains(courseId) && course != null) {
      earned += course.pointsCompletion;
      given.add(courseId);
    }

    state = state.copyWith(
      completed: nextCompleted,
      progressByCourse: nextProgress,
      earnedPoints: earned,
      completionPointsGiven: given,
    );
  }
}

extension _IterableX<E> on Iterable<E> {
  E? firstWhereOrNull(bool Function(E e) test) {
    for (final e in this) {
      if (test(e)) return e;
    }
    return null;
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\features\user\presentation\screens\courses_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../courses/application/courses_providers.dart';
import '../../../courses/presentation/state/courses_controller.dart';
import '../../../courses/domain/course_models.dart';

class CoursesScreen extends ConsumerWidget {
  const CoursesScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final st = ref.watch(coursesControllerProvider);
    final ctrl = ref.read(coursesControllerProvider.notifier);

    final filtered = _filterCourses(st.courses, st.query, st.category);

    final bg = const Color(0xFFF9FAFB);
    final maxW = MediaQuery.of(context).size.width >= 1100 ? 1080.0 : double.infinity;

    return Scaffold(
      backgroundColor: bg,
      body: SingleChildScrollView(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: maxW),
            child: Padding(
              padding: const EdgeInsets.fromLTRB(16, 18, 16, 28),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const SizedBox(height: 6),
                  const Text(
                    'Kurslar',
                    style: TextStyle(fontSize: 26, fontWeight: FontWeight.w800),
                  ),
                  const SizedBox(height: 6),
                  const Text(
                    'Bölümünüz için özel kurslar ve kaynaklar. Öğren, ilerle, puan kazan.',
                    style: TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
                  ),
                  const SizedBox(height: 16),

                  // Search + Category
                  LayoutBuilder(
                    builder: (context, c) {
                      final isWide = c.maxWidth >= 780;
                      return Flex(
                        direction: isWide ? Axis.horizontal : Axis.vertical,
                        crossAxisAlignment: CrossAxisAlignment.stretch,
                        children: [
                          Expanded(
                            flex: isWide ? 3 : 0,
                            child: TextField(
                              onChanged: ctrl.setQuery,
                              decoration: InputDecoration(
                                hintText: 'Kurs ara...',
                                prefixIcon: const Icon(Icons.search),
                                filled: true,
                                fillColor: Colors.white,
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(14),
                                  borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
                                ),
                                enabledBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(14),
                                  borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
                                ),
                              ),
                            ),
                          ),
                          SizedBox(width: isWide ? 12 : 0, height: isWide ? 0 : 12),
                          Expanded(
                            flex: isWide ? 2 : 0,
                            child: DropdownButtonFormField<String>(
                              value: st.category,
                              items: CoursesController.categories
                                  .map((c) => DropdownMenuItem(value: c, child: Text(c)))
                                  .toList(),
                              onChanged: (v) => ctrl.setCategory(v ?? 'Tümü'),
                              decoration: InputDecoration(
                                filled: true,
                                fillColor: Colors.white,
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(14),
                                  borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
                                ),
                                enabledBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(14),
                                  borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
                                ),
                              ),
                            ),
                          ),
                        ],
                      );
                    },
                  ),

                  const SizedBox(height: 14),

                  // Stats
                  _StatsRow(
                    total: st.courses.length,
                    enrolled: st.enrolled.length,
                    completed: st.completed.length,
                    points: st.earnedPoints,
                  ),

                  const SizedBox(height: 16),

                  if (st.isLoading)
                    const Center(child: Padding(padding: EdgeInsets.all(24), child: CircularProgressIndicator()))
                  else if (st.error != null)
                    _ErrorBox(message: st.error!, onRetry: () => ctrl.load())
                  else if (filtered.isEmpty)
                    const _EmptyBox()
                  else
                    _CoursesGrid(courses: filtered),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  List<Course> _filterCourses(List<Course> all, String query, String category) {
    final q = query.trim().toLowerCase();
    return all.where((c) {
      final matchesQuery = q.isEmpty ||
          c.title.toLowerCase().contains(q) ||
          c.description.toLowerCase().contains(q) ||
          c.instructor.toLowerCase().contains(q);

      final matchesCategory = category == 'Tümü' || c.category == category;

      return matchesQuery && matchesCategory;
    }).toList();
  }
}

class _StatsRow extends ConsumerWidget {
  const _StatsRow({
    required this.total,
    required this.enrolled,
    required this.completed,
    required this.points,
  });

  final int total;
  final int enrolled;
  final int completed;
  final int points;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final w = MediaQuery.of(context).size.width;
    final isWide = w >= 980;

    final items = <Widget>[
      _StatCard(title: 'Toplam Kurs', value: '$total', icon: Icons.menu_book_outlined),
      _StatCard(title: 'Kayıtlı', value: '$enrolled', icon: Icons.school_outlined),
      _StatCard(title: 'Tamamlanan', value: '$completed', icon: Icons.verified_outlined),
      _StatCard(title: 'Kazanılan Puan', value: '$points', icon: Icons.emoji_events_outlined),
    ];

    if (isWide) {
      return Row(children: items.map((w) => Expanded(child: Padding(padding: const EdgeInsets.only(right: 12), child: w))).toList()
        ..removeLast());
    }

    return Wrap(
      runSpacing: 12,
      spacing: 12,
      children: items.map((e) => SizedBox(width: (w - 16 * 2 - 12) / 2, child: e)).toList(),
    );
  }
}

class _StatCard extends StatelessWidget {
  const _StatCard({required this.title, required this.value, required this.icon});

  final String title;
  final String value;
  final IconData icon;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [BoxShadow(color: Color(0x0F000000), blurRadius: 18, offset: Offset(0, 8))],
      ),
      child: Row(
        children: [
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              color: const Color(0xFFF3E8FF),
              borderRadius: BorderRadius.circular(14),
            ),
            child: Icon(icon, color: const Color(0xFF7C3AED)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700)),
                const SizedBox(height: 4),
                Text(value, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _CoursesGrid extends ConsumerWidget {
  const _CoursesGrid({required this.courses});
  final List<Course> courses;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final st = ref.watch(coursesControllerProvider);
    final ctrl = ref.read(coursesControllerProvider.notifier);

    return LayoutBuilder(
      builder: (context, c) {
        final w = c.maxWidth;
        final crossAxisCount = w >= 1024 ? 3 : (w >= 760 ? 2 : 1);

        return GridView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          itemCount: courses.length,
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: crossAxisCount,
            crossAxisSpacing: 14,
            mainAxisSpacing: 14,
            childAspectRatio: crossAxisCount == 1 ? 1.55 : 1.15,
          ),
          itemBuilder: (_, i) {
            final course = courses[i];
            final isFav = st.favorites.contains(course.id);
            final isEnrolled = st.enrolled.contains(course.id);
            final isCompleted = st.completed.contains(course.id);
            final progress = st.progressByCourse[course.id] ?? 0;

            return _CourseCard(
              course: course,
              isFavorite: isFav,
              isEnrolled: isEnrolled,
              isCompleted: isCompleted,
              progress: progress,
              onToggleFavorite: () => ctrl.toggleFavorite(course.id),
              onOpen: () => context.go('/courses/${course.id}'),
            );
          },
        );
      },
    );
  }
}

class _CourseCard extends StatelessWidget {
  const _CourseCard({
    required this.course,
    required this.isFavorite,
    required this.isEnrolled,
    required this.isCompleted,
    required this.progress,
    required this.onToggleFavorite,
    required this.onOpen,
  });

  final Course course;
  final bool isFavorite;
  final bool isEnrolled;
  final bool isCompleted;
  final int progress;

  final VoidCallback onToggleFavorite;
  final VoidCallback onOpen;

  @override
  Widget build(BuildContext context) {
    final badge = isCompleted
        ? ('Tamamlandı', const Color(0xFF10B981), const Color(0xFFD1FAE5))
        : (isEnrolled && progress > 0)
            ? ('Devam Ediyor', const Color(0xFF3B82F6), const Color(0xFFDBEAFE))
            : null;

    return Material(
      color: Colors.white,
      borderRadius: BorderRadius.circular(18),
      child: InkWell(
        onTap: onOpen,
        borderRadius: BorderRadius.circular(18),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(18),
            border: Border.all(color: const Color(0xFFE5E7EB)),
            boxShadow: const [BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8))],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              // Top image/gradient area
              Container(
                height: 120,
                decoration: const BoxDecoration(
                  borderRadius: BorderRadius.vertical(top: Radius.circular(18)),
                  gradient: LinearGradient(
                    colors: [Color(0xFF7C3AED), Color(0xFF4F46E5)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                ),
                child: Stack(
                  children: [
                    const Center(
                      child: Icon(Icons.menu_book_rounded, size: 56, color: Color(0x55FFFFFF)),
                    ),
                    if (badge != null)
                      Positioned(
                        left: 12,
                        top: 12,
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                          decoration: BoxDecoration(
                            color: badge.$3,
                            borderRadius: BorderRadius.circular(999),
                          ),
                          child: Text(
                            badge.$1,
                            style: TextStyle(color: badge.$2, fontWeight: FontWeight.w900, fontSize: 12),
                          ),
                        ),
                      ),
                    Positioned(
                      right: 12,
                      top: 12,
                      child: Material(
                        color: const Color(0x22FFFFFF),
                        borderRadius: BorderRadius.circular(999),
                        child: InkWell(
                          borderRadius: BorderRadius.circular(999),
                          onTap: onToggleFavorite,
                          child: Padding(
                            padding: const EdgeInsets.all(8),
                            child: Icon(
                              isFavorite ? Icons.favorite : Icons.favorite_border,
                              color: Colors.white,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              // Body
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.all(14),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(course.title, style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w900)),
                      const SizedBox(height: 6),
                      Text(
                        course.description,
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                        style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
                      ),
                      const Spacer(),
                      Row(
                        children: [
                          const Icon(Icons.star, size: 18, color: Color(0xFFF59E0B)),
                          const SizedBox(width: 6),
                          Text(
                            course.rating.toStringAsFixed(1),
                            style: const TextStyle(fontWeight: FontWeight.w900),
                          ),
                          const SizedBox(width: 6),
                          Text(
                            '(${course.totalRatings})',
                            style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w700),
                          ),
                          const Spacer(),
                          const Icon(Icons.people_outline, size: 18, color: Color(0xFF6B7280)),
                          const SizedBox(width: 6),
                          Text(
                            '${course.enrolledCount}',
                            style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w800),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Row(
                        children: [
                          const Icon(Icons.person_outline, size: 18, color: Color(0xFF6B7280)),
                          const SizedBox(width: 6),
                          Expanded(
                            child: Text(
                              course.instructor,
                              overflow: TextOverflow.ellipsis,
                              style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w800),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      SizedBox(
                        width: double.infinity,
                        height: 42,
                        child: ElevatedButton.icon(
                          onPressed: onOpen,
                          icon: const Icon(Icons.arrow_forward, size: 18),
                          label: const Text('Kursa Git', style: TextStyle(fontWeight: FontWeight.w900)),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF7C3AED),
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                            elevation: 0,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _EmptyBox extends StatelessWidget {
  const _EmptyBox();

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(22),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFFE5E7EB)),
      ),
      child: const Column(
        children: [
          Icon(Icons.search_off, size: 44, color: Color(0xFF9CA3AF)),
          SizedBox(height: 10),
          Text('Kurs bulunamadı', style: TextStyle(fontWeight: FontWeight.w900)),
          SizedBox(height: 6),
          Text('Aradığınız kriterlere uygun kurs bulunamadı.', style: TextStyle(color: Color(0xFF6B7280))),
        ],
      ),
    );
  }
}

class _ErrorBox extends StatelessWidget {
  const _ErrorBox({required this.message, required this.onRetry});
  final String message;
  final VoidCallback onRetry;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFFFFFBEB),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: const Color(0xFFFDE68A)),
      ),
      child: Row(
        children: [
          const Icon(Icons.warning_amber_rounded, color: Color(0xFFB45309)),
          const SizedBox(width: 10),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: Color(0xFF92400E), fontWeight: FontWeight.w700),
            ),
          ),
          TextButton(onPressed: onRetry, child: const Text('Tekrar dene')),
        ],
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\features\user\presentation\screens\course_detail_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../auth/presentation/controllers/auth_controller.dart';
import '../../application/courses_providers.dart';
import '../../domain/course_models.dart';

class CourseDetailScreen extends ConsumerWidget {
  const CourseDetailScreen({super.key, required this.courseId});

  final String courseId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final courseAsync = ref.watch(courseDetailProvider(courseId));
    final enrollmentAsync = ref.watch(myCourseEnrollmentProvider(courseId));
    final repo = ref.read(coursesRepositoryProvider);

    return Container(
      color: const Color(0xFFF9FAFB),
      child: SingleChildScrollView(
        child: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 1120),
            child: Padding(
              padding: const EdgeInsets.fromLTRB(16, 22, 16, 28),
              child: courseAsync.when(
                loading: () => const Center(
                  child: Padding(
                    padding: EdgeInsets.only(top: 40),
                    child: SizedBox(width: 28, height: 28, child: CircularProgressIndicator(strokeWidth: 2.5)),
                  ),
                ),
                error: (e, _) => _DetailError(e.toString(), onRetry: () {
                  ref.invalidate(courseDetailProvider(courseId));
                  ref.invalidate(myCourseEnrollmentProvider(courseId));
                }),
                data: (course) {
                  return enrollmentAsync.when(
                    loading: () => _CourseDetailBody(
                      course: course,
                      enrollment: null,
                      enrolling: true,
                      onEnroll: null,
                      onUnenroll: null,
                      onUpdateProgress: null,
                    ),
                    error: (e, _) => _CourseDetailBody(
                      course: course,
                      enrollment: null,
                      enrolling: false,
                      onEnroll: null,
                      onUnenroll: null,
                      onUpdateProgress: null,
                      warning: 'Enrollment yüklenemedi: $e',
                    ),
                    data: (enrollment) {
                      Future<void> doEnroll() async {
                        final auth = ref.read(authViewStateProvider).value;
                        final uid = auth?.user?.id;
                        if (uid == null || uid.isEmpty) return;

                        await repo.enroll(userId: uid, courseId: courseId);

                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      Future<void> doUnenroll() async {
                        final auth = ref.read(authViewStateProvider).value;
                        final uid = auth?.user?.id;
                        if (uid == null || uid.isEmpty) return;

                        await repo.unenroll(userId: uid, courseId: courseId);

                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      Future<void> doUpdateProgress(int p) async {
                        if (enrollment == null) return;
                        await repo.updateProgress(enrollmentId: enrollment.id, progress: p);
                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      return _CourseDetailBody(
                        course: course,
                        enrollment: enrollment,
                        enrolling: false,
                        onEnroll: doEnroll,
                        onUnenroll: enrollment == null ? null : doUnenroll,
                        onUpdateProgress: enrollment == null ? null : doUpdateProgress,
                      );
                    },
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _CourseDetailBody extends StatelessWidget {
  const _CourseDetailBody({
    required this.course,
    required this.enrollment,
    required this.enrolling,
    required this.onEnroll,
    required this.onUnenroll,
    required this.onUpdateProgress,
    this.warning,
  });

  final Course course;
  final CourseEnrollment? enrollment;
  final bool enrolling;

  final Future<void> Function()? onEnroll;
  final Future<void> Function()? onUnenroll;
  final Future<void> Function(int p)? onUpdateProgress;

  final String? warning;

  @override
  Widget build(BuildContext context) {
    final enrolled = enrollment != null;
    final progress = (enrollment?.progress ?? 0).clamp(0, 100);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Simple back row (Navbar exists already, but this helps mobile)
        Row(
          children: [
            IconButton(
              onPressed: () => Navigator.of(context).maybePop(),
              icon: const Icon(Icons.arrow_back),
              tooltip: 'Geri',
            ),
            const SizedBox(width: 6),
            const Text('Kurs Detayı', style: TextStyle(fontWeight: FontWeight.w900, fontSize: 18)),
          ],
        ),
        const SizedBox(height: 10),

        if (warning != null) ...[
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.withOpacity(0.10),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.orange.withOpacity(0.25)),
            ),
            child: Text(warning!, style: const TextStyle(color: Colors.orange)),
          ),
          const SizedBox(height: 12),
        ],

        Container(
          padding: const EdgeInsets.all(18),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(18),
            border: Border.all(color: const Color(0xFFE5E7EB)),
            boxShadow: const [BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8))],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(course.title, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
              const SizedBox(height: 10),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: [
                  _Meta(Icons.school_outlined, course.department ?? '—'),
                  _Meta(Icons.bar_chart_outlined, course.level ?? '—'),
                  _Meta(Icons.access_time, course.duration ?? '—'),
                  _Meta(Icons.person_outline, course.instructor ?? '—'),
                ],
              ),
              const SizedBox(height: 12),
              Text(
                course.description ?? 'Açıklama yok.',
                style: const TextStyle(color: Color(0xFF374151), fontWeight: FontWeight.w600, height: 1.45),
              ),
              const SizedBox(height: 14),

              if (course.videoUrl != null && course.videoUrl!.trim().isNotEmpty) ...[
                const Text('Video URL', style: TextStyle(fontWeight: FontWeight.w900)),
                const SizedBox(height: 6),
                SelectableText(course.videoUrl!, style: const TextStyle(color: Color(0xFF6D28D9))),
                const SizedBox(height: 12),
              ],

              Container(height: 1, color: const Color(0xFFE5E7EB)),
              const SizedBox(height: 12),

              if (!enrolled) ...[
                SizedBox(
                  height: 44,
                  child: ElevatedButton.icon(
                    onPressed: (enrolling || onEnroll == null) ? null : () async => onEnroll!(),
                    icon: const Icon(Icons.add),
                    label: Text(enrolling ? 'Yükleniyor...' : 'Kursa Kayıt Ol', style: const TextStyle(fontWeight: FontWeight.w900)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF6D28D9),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      elevation: 0,
                    ),
                  ),
                ),
              ] else ...[
                Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text('İlerleme', style: TextStyle(fontWeight: FontWeight.w900)),
                          const SizedBox(height: 6),
                          ClipRRect(
                            borderRadius: BorderRadius.circular(999),
                            child: LinearProgressIndicator(
                              value: progress / 100,
                              minHeight: 10,
                              backgroundColor: const Color(0xFFE5E7EB),
                              valueColor: const AlwaysStoppedAnimation(Color(0xFF2563EB)),
                            ),
                          ),
                          const SizedBox(height: 6),
                          Text('%$progress tamamlandı', style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w800)),
                        ],
                      ),
                    ),
                    const SizedBox(width: 12),
                    if (onUnenroll != null)
                      OutlinedButton(
                        onPressed: () async => onUnenroll!(),
                        child: const Text('Kayıt İptal'),
                      ),
                  ],
                ),
                const SizedBox(height: 10),
                if (onUpdateProgress != null)
                  Wrap(
                    spacing: 10,
                    children: [
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(progress + 10),
                        child: const Text('+10%'),
                      ),
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(progress + 25),
                        child: const Text('+25%'),
                      ),
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(100),
                        child: const Text('Tamamlandı'),
                      ),
                    ],
                  ),
              ],
            ],
          ),
        ),
      ],
    );
  }
}

class _Meta extends StatelessWidget {
  const _Meta(this.icon, this.text);
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
      decoration: BoxDecoration(
        color: const Color(0xFFF3F4F6),
        borderRadius: BorderRadius.circular(999),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: const Color(0xFF4B5563)),
          const SizedBox(width: 6),
          Text(text, style: const TextStyle(fontWeight: FontWeight.w800, fontSize: 12, color: Color(0xFF374151))),
        ],
      ),
    );
  }
}

class _DetailError extends StatelessWidget {
  const _DetailError(this.message, {required this.onRetry});
  final String message;
  final VoidCallback onRetry;

  @override
  Widget build(BuildContext context) {
    return Center(
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 620),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(Icons.error_outline, size: 54),
            const SizedBox(height: 10),
            const Text('Course yüklenemedi', style: TextStyle(fontWeight: FontWeight.w900)),
            const SizedBox(height: 8),
            Text(message, textAlign: TextAlign.center, style: const TextStyle(color: Color(0xFF6B7280))),
            const SizedBox(height: 10),
            ElevatedButton(onPressed: onRetry, child: const Text('Retry')),
          ],
        ),
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/student_dashboard/domain/student_dashboard_models.dart


import 'package:flutter/foundation.dart';

@immutable
class DashboardStats {
  const DashboardStats({
    required this.totalPoints,
    required this.coursesCompleted,
    required this.activeApplications,
    required this.ongoingCourses,
    this.departmentRank,
  });

  final int totalPoints;
  final int coursesCompleted;
  final int activeApplications;
  final int ongoingCourses;
  final int? departmentRank;
}

@immutable
class EnrolledCourse {
  const EnrolledCourse({
    required this.courseId,
    required this.title,
    required this.description,
    required this.duration,
    required this.level,
    required this.progress,
  });

  final String courseId;
  final String title;
  final String description;
  final String duration;
  final String level;
  final int progress; // 0..100
}

enum ActivityCategory { course, job, internship, achievement, platform }

@immutable
class ActivityItem {
  const ActivityItem({
    required this.category,
    required this.action,
    required this.points,
    required this.createdAt,
  });

  final ActivityCategory category;
  final String action;
  final int points;
  final DateTime createdAt;
}

@immutable
class StudentDashboardVm {
  const StudentDashboardVm({
    required this.displayName,
    required this.stats,
    required this.enrolledCourses,
    required this.activities,
    required this.todayPoints,
    required this.weekPoints,
  });

  final String displayName;
  final DashboardStats stats;
  final List<EnrolledCourse> enrolledCourses;
  final List<ActivityItem> activities;

  final int todayPoints;
  final int weekPoints;
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/student_dashboard/presentation/controllers/student_dashboard_providers.dart


import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../auth/presentation/controllers/auth_controller.dart';
import '../../data/student_dashboard_repository.dart';
import '../../domain/student_dashboard_models.dart';
import '../../../../core/supabase/supabase_service.dart';

final supabaseClientProvider = Provider<SupabaseClient>((ref) {
  return SupabaseService.client;
});

final studentDashboardRepositoryProvider =
    Provider<StudentDashboardRepository>((ref) {
  final client = ref.watch(supabaseClientProvider);
  return StudentDashboardRepository(client);
});

final studentDashboardProvider =
    FutureProvider.autoDispose<StudentDashboardVm>((ref) async {
  final authAsync = ref.watch(authViewStateProvider);
  final auth = authAsync.value;

  final userId = auth?.user?.id;
  if (userId == null || userId.isEmpty) {
    throw StateError('No authenticated user');
  }

  final repo = ref.watch(studentDashboardRepositoryProvider);
  return repo.fetchDashboard(userId: userId);
});

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\features\courses\presentation\screens\course_detail_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../application/courses_providers.dart';
import '../../domain/course_models.dart';

class CourseDetailScreen extends ConsumerWidget {
  const CourseDetailScreen({super.key, required this.courseId});

  final String courseId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final courseAsync = ref.watch(courseDetailProvider(courseId));
    final enrollmentAsync = ref.watch(myCourseEnrollmentProvider(courseId));
    final repo = ref.read(coursesRepositoryProvider);

    return Container(
      color: const Color(0xFFF9FAFB),
      child: SingleChildScrollView(
        child: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 1120),
            child: Padding(
              padding: const EdgeInsets.fromLTRB(16, 22, 16, 28),
              child: courseAsync.when(
                loading: () => const Center(
                  child: Padding(
                    padding: EdgeInsets.only(top: 40),
                    child: SizedBox(width: 28, height: 28, child: CircularProgressIndicator(strokeWidth: 2.5)),
                  ),
                ),
                error: (e, _) => _DetailError(e.toString(), onRetry: () {
                  ref.invalidate(courseDetailProvider(courseId));
                  ref.invalidate(myCourseEnrollmentProvider(courseId));
                }),
                data: (course) {
                  return enrollmentAsync.when(
                    loading: () => _CourseDetailBody(
                      course: course,
                      enrollment: null,
                      enrolling: true,
                      onEnroll: null,
                      onUnenroll: null,
                      onUpdateProgress: null,
                    ),
                    error: (e, _) => _CourseDetailBody(
                      course: course,
                      enrollment: null,
                      enrolling: false,
                      onEnroll: null,
                      onUnenroll: null,
                      onUpdateProgress: null,
                      warning: 'Enrollment yüklenemedi: $e',
                    ),
                    data: (enrollment) {
                      Future<void> doEnroll() async {
                        final auth = ref.read(authViewStateProvider).value;
                        final uid = auth?.user?.id;
                        if (uid == null || uid.isEmpty) return;

                        await repo.enroll(userId: uid, courseId: courseId);

                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      Future<void> doUnenroll() async {
                        final auth = ref.read(authViewStateProvider).value;
                        final uid = auth?.user?.id;
                        if (uid == null || uid.isEmpty) return;

                        await repo.unenroll(userId: uid, courseId: courseId);

                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      Future<void> doUpdateProgress(int p) async {
                        if (enrollment == null) return;
                        await repo.updateProgress(enrollmentId: enrollment.id, progress: p);
                        ref.invalidate(myEnrolledCoursesProvider);
                        ref.invalidate(myCourseEnrollmentProvider(courseId));
                      }

                      return _CourseDetailBody(
                        course: course,
                        enrollment: enrollment,
                        enrolling: false,
                        onEnroll: doEnroll,
                        onUnenroll: enrollment == null ? null : doUnenroll,
                        onUpdateProgress: enrollment == null ? null : doUpdateProgress,
                      );
                    },
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _CourseDetailBody extends StatelessWidget {
  const _CourseDetailBody({
    required this.course,
    required this.enrollment,
    required this.enrolling,
    required this.onEnroll,
    required this.onUnenroll,
    required this.onUpdateProgress,
    this.warning,
  });

  final Course course;
  final CourseEnrollment? enrollment;
  final bool enrolling;

  final Future<void> Function()? onEnroll;
  final Future<void> Function()? onUnenroll;
  final Future<void> Function(int p)? onUpdateProgress;

  final String? warning;

  @override
  Widget build(BuildContext context) {
    final enrolled = enrollment != null;
    final progress = (enrollment?.progress ?? 0).clamp(0, 100);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Simple back row (Navbar exists already, but this helps mobile)
        Row(
          children: [
            IconButton(
              onPressed: () => Navigator.of(context).maybePop(),
              icon: const Icon(Icons.arrow_back),
              tooltip: 'Geri',
            ),
            const SizedBox(width: 6),
            const Text('Kurs Detayı', style: TextStyle(fontWeight: FontWeight.w900, fontSize: 18)),
          ],
        ),
        const SizedBox(height: 10),

        if (warning != null) ...[
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.withOpacity(0.10),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.orange.withOpacity(0.25)),
            ),
            child: Text(warning!, style: const TextStyle(color: Colors.orange)),
          ),
          const SizedBox(height: 12),
        ],

        Container(
          padding: const EdgeInsets.all(18),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(18),
            border: Border.all(color: const Color(0xFFE5E7EB)),
            boxShadow: const [BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8))],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(course.title, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
              const SizedBox(height: 10),
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: [
                  _Meta(Icons.school_outlined, course.department ?? '—'),
                  _Meta(Icons.bar_chart_outlined, course.level ?? '—'),
                  _Meta(Icons.access_time, course.duration ?? '—'),
                  _Meta(Icons.person_outline, course.instructor ?? '—'),
                ],
              ),
              const SizedBox(height: 12),
              Text(
                course.description ?? 'Açıklama yok.',
                style: const TextStyle(color: Color(0xFF374151), fontWeight: FontWeight.w600, height: 1.45),
              ),
              const SizedBox(height: 14),

              if (course.videoUrl != null && course.videoUrl!.trim().isNotEmpty) ...[
                const Text('Video URL', style: TextStyle(fontWeight: FontWeight.w900)),
                const SizedBox(height: 6),
                SelectableText(course.videoUrl!, style: const TextStyle(color: Color(0xFF6D28D9))),
                const SizedBox(height: 12),
              ],

              Container(height: 1, color: const Color(0xFFE5E7EB)),
              const SizedBox(height: 12),

              if (!enrolled) ...[
                SizedBox(
                  height: 44,
                  child: ElevatedButton.icon(
                    onPressed: (enrolling || onEnroll == null) ? null : () async => onEnroll!(),
                    icon: const Icon(Icons.add),
                    label: Text(enrolling ? 'Yükleniyor...' : 'Kursa Kayıt Ol', style: const TextStyle(fontWeight: FontWeight.w900)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF6D28D9),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      elevation: 0,
                    ),
                  ),
                ),
              ] else ...[
                Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text('İlerleme', style: TextStyle(fontWeight: FontWeight.w900)),
                          const SizedBox(height: 6),
                          ClipRRect(
                            borderRadius: BorderRadius.circular(999),
                            child: LinearProgressIndicator(
                              value: progress / 100,
                              minHeight: 10,
                              backgroundColor: const Color(0xFFE5E7EB),
                              valueColor: const AlwaysStoppedAnimation(Color(0xFF2563EB)),
                            ),
                          ),
                          const SizedBox(height: 6),
                          Text('%$progress tamamlandı', style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w800)),
                        ],
                      ),
                    ),
                    const SizedBox(width: 12),
                    if (onUnenroll != null)
                      OutlinedButton(
                        onPressed: () async => onUnenroll!(),
                        child: const Text('Kayıt İptal'),
                      ),
                  ],
                ),
                const SizedBox(height: 10),
                if (onUpdateProgress != null)
                  Wrap(
                    spacing: 10,
                    children: [
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(progress + 10),
                        child: const Text('+10%'),
                      ),
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(progress + 25),
                        child: const Text('+25%'),
                      ),
                      OutlinedButton(
                        onPressed: () async => onUpdateProgress!(100),
                        child: const Text('Tamamlandı'),
                      ),
                    ],
                  ),
              ],
            ],
          ),
        ),
      ],
    );
  }
}

class _Meta extends StatelessWidget {
  const _Meta(this.icon, this.text);
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
      decoration: BoxDecoration(
        color: const Color(0xFFF3F4F6),
        borderRadius: BorderRadius.circular(999),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: const Color(0xFF4B5563)),
          const SizedBox(width: 6),
          Text(text, style: const TextStyle(fontWeight: FontWeight.w800, fontSize: 12, color: Color(0xFF374151))),
        ],
      ),
    );
  }
}

class _DetailError extends StatelessWidget {
  const _DetailError(this.message, {required this.onRetry});
  final String message;
  final VoidCallback onRetry;

  @override
  Widget build(BuildContext context) {
    return Center(
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 620),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(Icons.error_outline, size: 54),
            const SizedBox(height: 10),
            const Text('Course yüklenemedi', style: TextStyle(fontWeight: FontWeight.w900)),
            const SizedBox(height: 8),
            Text(message, textAlign: TextAlign.center, style: const TextStyle(color: Color(0xFF6B7280))),
            const SizedBox(height: 10),
            ElevatedButton(onPressed: onRetry, child: const Text('Retry')),
          ],
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\features\courses\presentation\screens\courses_screen.dart


import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../application/courses_providers.dart';
import '../../domain/course_models.dart';

class CoursesScreen extends ConsumerStatefulWidget {
  const CoursesScreen({super.key});

  @override
  ConsumerState<CoursesScreen> createState() => _CoursesScreenState();
}

class _CoursesScreenState extends ConsumerState<CoursesScreen>
    with SingleTickerProviderStateMixin {
  late final TabController _tabs;
  final _search = TextEditingController();
  Timer? _debounce;

  @override
  void initState() {
    super.initState();
    _tabs = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _debounce?.cancel();
    _search.dispose();
    _tabs.dispose();
    super.dispose();
  }

  void _onSearchChanged(String v) {
    _debounce?.cancel();
    _debounce = Timer(const Duration(milliseconds: 250), () {
      ref.read(coursesSearchProvider.notifier).state = v;
    });
  }

  @override
  Widget build(BuildContext context) {
    final allCoursesAsync = ref.watch(coursesListProvider);
    final myCoursesAsync = ref.watch(myEnrolledCoursesProvider);

    // For "Enrolled" badges in ALL tab
    final enrolledIds = myCoursesAsync.maybeWhen(
      data: (list) => list.map((e) => e.course.id).toSet(),
      orElse: () => <String>{},
    );

    return Container(
      color: const Color(0xFFF9FAFB),
      child: SingleChildScrollView(
        child: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 1120),
            child: Padding(
              padding: const EdgeInsets.fromLTRB(16, 22, 16, 28),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Kurslar',
                    style: TextStyle(fontSize: 28, fontWeight: FontWeight.w900),
                  ),
                  const SizedBox(height: 6),
                  const Text(
                    'Kurslara göz at, kaydol ve puan kazan.',
                    style: TextStyle(
                      color: Color(0xFF6B7280),
                      fontWeight: FontWeight.w700,
                    ),
                  ),
                  const SizedBox(height: 14),

                  // Search + filters container
                  _FiltersCard(
                    searchController: _search,
                    onSearchChanged: _onSearchChanged,
                    onClear: () {
                      _search.clear();
                      ref.read(coursesSearchProvider.notifier).state = '';
                      ref.read(coursesDepartmentProvider.notifier).state = null;
                      ref.read(coursesLevelProvider.notifier).state = null;
                      ref.invalidate(coursesListProvider);
                    },
                  ),

                  const SizedBox(height: 14),

                  // Tabs
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(14),
                      border: Border.all(color: const Color(0xFFE5E7EB)),
                    ),
                    child: TabBar(
                      controller: _tabs,
                      labelColor: const Color(0xFF111827),
                      unselectedLabelColor: const Color(0xFF6B7280),
                      labelStyle: const TextStyle(fontWeight: FontWeight.w900),
                      indicatorColor: const Color(0xFF6D28D9),
                      tabs: const [
                        Tab(text: 'Tümü'),
                        Tab(text: 'Kayıtlılarım'),
                      ],
                    ),
                  ),

                  const SizedBox(height: 14),

                  SizedBox(
                    height: 720, // keeps layout stable inside SingleChildScrollView
                    child: TabBarView(
                      controller: _tabs,
                      children: [
                        // ALL COURSES
                        allCoursesAsync.when(
                          loading: () => const _LoadingBlock(),
                          error: (e, _) => _ErrorBlock(
                            title: 'Kurslar yüklenemedi',
                            message: e.toString(),
                            onRetry: () => ref.invalidate(coursesListProvider),
                          ),
                          data: (courses) {
                            if (courses.isEmpty) {
                              return const _EmptyBlock(
                                icon: Icons.menu_book_outlined,
                                title: 'Kurs bulunamadı',
                                message: 'Filtreleri temizleyip tekrar deneyin.',
                              );
                            }

                            // Build dynamic filter chips (departments + levels) from dataset
                            final departments = courses
                                .map((c) => (c.department ?? '').trim())
                                .where((d) => d.isNotEmpty)
                                .toSet()
                                .toList()
                              ..sort();

                            final levels = courses
                                .map((c) => (c.level ?? '').trim())
                                .where((d) => d.isNotEmpty)
                                .toSet()
                                .toList()
                              ..sort();

                            return Column(
                              children: [
                                _QuickChipsRow(
                                  departments: departments,
                                  levels: levels,
                                ),
                                const SizedBox(height: 10),
                                Expanded(
                                  child: ListView.builder(
                                    itemCount: courses.length,
                                    itemBuilder: (_, i) {
                                      final c = courses[i];
                                      final isEnrolled = enrolledIds.contains(c.id);

                                      return _CourseCard(
                                        course: c,
                                        enrolled: isEnrolled,
                                        onOpen: () => context.push('/courses/${c.id}'),
                                      );
                                    },
                                  ),
                                ),
                              ],
                            );
                          },
                        ),

                        // MY ENROLLED COURSES
                        myCoursesAsync.when(
                          loading: () => const _LoadingBlock(),
                          error: (e, _) => _ErrorBlock(
                            title: 'Kayıtlı kurslar yüklenemedi',
                            message: e.toString(),
                            onRetry: () => ref.invalidate(myEnrolledCoursesProvider),
                          ),
                          data: (myCourses) {
                            if (myCourses.isEmpty) {
                              return _EmptyBlock(
                                icon: Icons.school_outlined,
                                title: 'Henüz kayıtlı kurs yok',
                                message: '“Tümü” sekmesinden bir kursa kayıt olabilirsin.',
                                actionLabel: 'Kursları Keşfet',
                                onAction: () => _tabs.animateTo(0),
                              );
                            }

                            return ListView.builder(
                              itemCount: myCourses.length,
                              itemBuilder: (_, i) {
                                final item = myCourses[i];
                                return _EnrolledCourseCard(
                                  item: item,
                                  onOpen: () => context.push('/courses/${item.course.id}'),
                                );
                              },
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

/* ---------------------------- Widgets ---------------------------- */

class _FiltersCard extends ConsumerWidget {
  const _FiltersCard({
    required this.searchController,
    required this.onSearchChanged,
    required this.onClear,
  });

  final TextEditingController searchController;
  final ValueChanged<String> onSearchChanged;
  final VoidCallback onClear;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dept = ref.watch(coursesDepartmentProvider);
    final level = ref.watch(coursesLevelProvider);

    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [
          BoxShadow(color: Color(0x0A000000), blurRadius: 18, offset: Offset(0, 8)),
        ],
      ),
      child: Column(
        children: [
          TextField(
            controller: searchController,
            onChanged: onSearchChanged,
            decoration: InputDecoration(
              prefixIcon: const Icon(Icons.search),
              hintText: 'Kurs ara (örn: SQL, Flutter, Veri...)',
              filled: true,
              fillColor: const Color(0xFFF9FAFB),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(14),
                borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(14),
                borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
              ),
              suffixIcon: (searchController.text.isNotEmpty || dept != null || level != null)
                  ? IconButton(
                      onPressed: onClear,
                      icon: const Icon(Icons.close),
                      tooltip: 'Temizle',
                    )
                  : null,
            ),
          ),
          const SizedBox(height: 10),
          Row(
            children: [
              _SmallPill(
                icon: Icons.filter_alt_outlined,
                text: dept == null ? 'Bölüm: Hepsi' : 'Bölüm: $dept',
              ),
              const SizedBox(width: 8),
              _SmallPill(
                icon: Icons.bar_chart_outlined,
                text: level == null ? 'Seviye: Hepsi' : 'Seviye: $level',
              ),
              const Spacer(),
              TextButton.icon(
                onPressed: () => context.go(Routes.pointsSystem),
                icon: const Icon(Icons.track_changes_outlined),
                label: const Text('Puan Sistemi'),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

class _QuickChipsRow extends ConsumerWidget {
  const _QuickChipsRow({
    required this.departments,
    required this.levels,
  });

  final List<String> departments;
  final List<String> levels;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedDept = ref.watch(coursesDepartmentProvider);
    final selectedLevel = ref.watch(coursesLevelProvider);

    return Wrap(
      spacing: 8,
      runSpacing: 8,
      children: [
        const Text('Hızlı Filtre:', style: TextStyle(fontWeight: FontWeight.w900)),
        const SizedBox(width: 6),

        // Departments
        ...departments.take(6).map((d) {
          final selected = selectedDept == d;
          return FilterChip(
            selected: selected,
            label: Text(d),
            onSelected: (_) {
              ref.read(coursesDepartmentProvider.notifier).state = selected ? null : d;
              ref.invalidate(coursesListProvider);
            },
          );
        }),

        // Levels
        ...levels.take(4).map((l) {
          final selected = selectedLevel == l;
          return FilterChip(
            selected: selected,
            label: Text(l),
            onSelected: (_) {
              ref.read(coursesLevelProvider.notifier).state = selected ? null : l;
              ref.invalidate(coursesListProvider);
            },
          );
        }),
      ],
    );
  }
}

class _CourseCard extends StatelessWidget {
  const _CourseCard({
    required this.course,
    required this.enrolled,
    required this.onOpen,
  });

  final Course course;
  final bool enrolled;
  final VoidCallback onOpen;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
        boxShadow: const [BoxShadow(color: Color(0x08000000), blurRadius: 14, offset: Offset(0, 8))],
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 56,
            height: 56,
            decoration: BoxDecoration(
              color: const Color(0xFFEDE9FE),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Icon(Icons.menu_book_outlined, color: Color(0xFF6D28D9)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        course.title,
                        style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 16),
                      ),
                    ),
                    if (enrolled)
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                        decoration: BoxDecoration(
                          color: const Color(0xFFDCFCE7),
                          borderRadius: BorderRadius.circular(999),
                        ),
                        child: const Text(
                          'Kayıtlı',
                          style: TextStyle(color: Color(0xFF16A34A), fontWeight: FontWeight.w900, fontSize: 12),
                        ),
                      ),
                  ],
                ),
                const SizedBox(height: 6),
                Text(
                  (course.description ?? 'Açıklama yok.'),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
                ),
                const SizedBox(height: 10),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: [
                    _MetaChip(icon: Icons.school_outlined, text: course.department ?? '—'),
                    _MetaChip(icon: Icons.bar_chart_outlined, text: course.level ?? '—'),
                    _MetaChip(icon: Icons.access_time, text: course.duration ?? '—'),
                  ],
                ),
              ],
            ),
          ),
          const SizedBox(width: 10),
          ElevatedButton(
            onPressed: onOpen,
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF6D28D9),
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
              elevation: 0,
            ),
            child: const Text('Detay →', style: TextStyle(fontWeight: FontWeight.w900)),
          ),
        ],
      ),
    );
  }
}

class _EnrolledCourseCard extends StatelessWidget {
  const _EnrolledCourseCard({required this.item, required this.onOpen});

  final EnrolledCourse item;
  final VoidCallback onOpen;

  @override
  Widget build(BuildContext context) {
    final c = item.course;
    final p = item.enrollment.progress.clamp(0, 100);

    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFFE5E7EB)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Expanded(
                child: Text(c.title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 16)),
              ),
              TextButton(onPressed: onOpen, child: const Text('Aç →')),
            ],
          ),
          const SizedBox(height: 6),
          Text(
            c.description ?? 'Açıklama yok.',
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600),
          ),
          const SizedBox(height: 10),
          ClipRRect(
            borderRadius: BorderRadius.circular(999),
            child: LinearProgressIndicator(
              value: p / 100,
              minHeight: 10,
              backgroundColor: const Color(0xFFE5E7EB),
              valueColor: const AlwaysStoppedAnimation(Color(0xFF2563EB)),
            ),
          ),
          const SizedBox(height: 6),
          Text('%$p tamamlandı', style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w800, fontSize: 12)),
        ],
      ),
    );
  }
}

class _MetaChip extends StatelessWidget {
  const _MetaChip({required this.icon, required this.text});
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
      decoration: BoxDecoration(
        color: const Color(0xFFF3F4F6),
        borderRadius: BorderRadius.circular(999),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: const Color(0xFF4B5563)),
          const SizedBox(width: 6),
          Text(
            text,
            style: const TextStyle(fontWeight: FontWeight.w800, fontSize: 12, color: Color(0xFF374151)),
          ),
        ],
      ),
    );
  }
}

class _SmallPill extends StatelessWidget {
  const _SmallPill({required this.icon, required this.text});
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      decoration: BoxDecoration(
        color: const Color(0xFFF3F4F6),
        borderRadius: BorderRadius.circular(999),
        border: Border.all(color: const Color(0xFFE5E7EB)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: const Color(0xFF4B5563)),
          const SizedBox(width: 6),
          Text(text, style: const TextStyle(fontWeight: FontWeight.w800, fontSize: 12)),
        ],
      ),
    );
  }
}

class _LoadingBlock extends StatelessWidget {
  const _LoadingBlock();

  @override
  Widget build(BuildContext context) {
    return const Center(
      child: SizedBox(
        width: 28,
        height: 28,
        child: CircularProgressIndicator(strokeWidth: 2.5),
      ),
    );
  }
}

class _EmptyBlock extends StatelessWidget {
  const _EmptyBlock({
    required this.icon,
    required this.title,
    required this.message,
    this.actionLabel,
    this.onAction,
  });

  final IconData icon;
  final String title;
  final String message;
  final String? actionLabel;
  final VoidCallback? onAction;

  @override
  Widget build(BuildContext context) {
    return Center(
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 520),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(icon, size: 56, color: const Color(0xFFD1D5DB)),
              const SizedBox(height: 10),
              Text(title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 16)),
              const SizedBox(height: 6),
              Text(message, textAlign: TextAlign.center, style: const TextStyle(color: Color(0xFF6B7280), fontWeight: FontWeight.w600)),
              if (actionLabel != null && onAction != null) ...[
                const SizedBox(height: 10),
                OutlinedButton(onPressed: onAction, child: Text('$actionLabel →')),
              ],
            ],
          ),
        ),
      ),
    );
  }
}

class _ErrorBlock extends StatelessWidget {
  const _ErrorBlock({
    required this.title,
    required this.message,
    required this.onRetry,
  });

  final String title;
  final String message;
  final VoidCallback onRetry;

  @override
  Widget build(BuildContext context) {
    return Center(
      child: ConstrainedBox(
        constraints: const BoxConstraints(maxWidth: 620),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.error_outline, size: 54),
              const SizedBox(height: 10),
              Text(title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 16)),
              const SizedBox(height: 6),
              Text(message, textAlign: TextAlign.center, style: const TextStyle(color: Color(0xFF6B7280))),
              const SizedBox(height: 10),
              ElevatedButton(onPressed: onRetry, child: const Text('Retry')),
            ],
          ),
        ),
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

