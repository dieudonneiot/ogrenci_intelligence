flutter create ogrenci_intelligence_app --org com.ogrenciintelligence
cd ogrenci_intelligence_app

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
ogrenci_intelligence/


# --------- FOLDERS ----------
$dirs = @(
"lib/src/app",
"lib/src/core/config",
"lib/src/core/constants",
"lib/src/core/error",
"lib/src/core/logging",
"lib/src/core/routing",
"lib/src/core/supabase",
"lib/src/core/theme",
"lib/src/shared/utils",
"lib/src/shared/widgets",
"lib/src/features/auth/data",
"lib/src/features/auth/domain",
"lib/src/features/auth/presentation/controllers",
"lib/src/features/auth/presentation/screens",
"lib/src/features/user/data",
"lib/src/features/user/domain",
"lib/src/features/user/presentation/controllers",
"lib/src/features/user/presentation/screens",
"lib/src/features/company/data",
"lib/src/features/company/domain",
"lib/src/features/company/presentation/controllers",
"lib/src/features/company/presentation/screens",
"lib/src/features/admin/data",
"lib/src/features/admin/domain",
"lib/src/features/admin/presentation/controllers",
"lib/src/features/admin/presentation/screens",
".github/workflows",
"docs"
)

$dirs | ForEach-Object { New-Item -ItemType Directory -Force -Path $_ | Out-Null }

# --------- FILES ----------
$files = @(
"lib/src/app/app.dart",
"lib/src/app/bootstrap.dart",
"lib/src/core/config/env.dart",
"lib/src/core/constants/app_constants.dart",
"lib/src/core/error/app_exception.dart",
"lib/src/core/error/failure.dart",
"lib/src/core/logging/logger.dart",
"lib/src/core/routing/app_router.dart",
"lib/src/core/routing/routes.dart",
"lib/src/core/routing/route_guards.dart",
"lib/src/core/supabase/supabase_service.dart",
"lib/src/core/theme/app_theme.dart",
"lib/src/core/theme/app_colors.dart",
"lib/src/core/theme/app_typography.dart",
"lib/src/shared/utils/validators.dart",
"lib/src/shared/utils/formatters.dart",
"lib/src/shared/widgets/app_button.dart",
"lib/src/shared/widgets/app_text_field.dart",
"lib/src/shared/widgets/loading_view.dart",
"lib/src/shared/widgets/empty_state.dart",

"lib/src/features/auth/data/auth_repository.dart",
"lib/src/features/auth/domain/auth_models.dart",
"lib/src/features/auth/presentation/controllers/auth_controller.dart",
"lib/src/features/auth/presentation/screens/login_screen.dart",
"lib/src/features/auth/presentation/screens/register_screen.dart",
"lib/src/features/auth/presentation/screens/forgot_password_screen.dart",
"lib/src/features/auth/presentation/screens/email_verification_screen.dart",

"lib/src/features/user/data/user_repository.dart",
"lib/src/features/user/domain/user_models.dart",
"lib/src/features/user/presentation/controllers/user_controller.dart",
"lib/src/features/user/presentation/screens/user_dashboard_screen.dart",
"lib/src/features/user/presentation/screens/user_profile_screen.dart",
"lib/src/features/user/presentation/screens/user_settings_screen.dart",

"lib/src/features/company/data/company_repository.dart",
"lib/src/features/company/domain/company_models.dart",
"lib/src/features/company/presentation/controllers/company_controller.dart",
"lib/src/features/company/presentation/screens/company_auth_screen.dart",
"lib/src/features/company/presentation/screens/company_dashboard_screen.dart",

"lib/src/features/admin/data/admin_repository.dart",
"lib/src/features/admin/domain/admin_models.dart",
"lib/src/features/admin/presentation/controllers/admin_controller.dart",
"lib/src/features/admin/presentation/screens/admin_login_screen.dart",
"lib/src/features/admin/presentation/screens/admin_dashboard_screen.dart",

".github/workflows/flutter-ci.yml",
"docs/architecture.md",
"docs/api-contracts.md",
".env.example",
"README.md"
)

$files | ForEach-Object { New-Item -ItemType File -Force -Path $_ | Out-Null }

Write-Host "Scaffold created."

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

git init
git add .
git commit -m "Initial Flutter scaffold"

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

echo "" >> .gitignore
echo "# Local environment files" >> .gitignore
echo ".env" >> .gitignore
echo "*.keystore" >> .gitignore

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

git branch -M main
git remote add origin https://github.com/<YOUR_USERNAME>/ogrenci_intelligence.git
git push -u origin main

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
.github/workflows/flutter-ci.yml

name: Flutter CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Static analysis
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
          if-no-files-found: ignore

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

.github/dependabot.yml

version: 2
enable-beta-ecosystems: true

updates:
  - package-ecosystem: "pub"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5
    groups:
      pub-deps:
        patterns:
          - "*"

  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "monthly"
    groups:
      gha:
        patterns:
          - "*"

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

.github/pull_request_template.md

## Summary
- What does this PR change?

## Screenshots / Video (if UI)
- Attach evidence for UI changes

## Checklist
- [ ] I ran `flutter analyze`
- [ ] I ran `flutter test`
- [ ] I ran `dart format .`
- [ ] No secrets committed (.env, keys, credentials)
- [ ] Relevant docs updated (README / docs/)

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

SECURITY.md

# Security Policy

## Supported Versions
We support the latest version on the `main` branch.

## Reporting a Vulnerability
Please do not open a public issue.
Instead, email the maintainer with:
- vulnerability description
- reproduction steps
- impact assessment
- suggested fix (if available)

We will respond as soon as possible and coordinate a responsible disclosure.

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\pubspec.yaml

name: ogrenci_intelligence
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ">=3.10.0 <4.0.0"
  flutter: 3.38.5

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  # UI/Icons
  cupertino_icons: ^1.0.8

  # Core packages (MOVED HERE from the 'flutter:' section)
  go_router: ^16.0.0
  flutter_riverpod: ^2.6.1
  supabase_flutter: ^2.9.0
  flutter_dotenv: ^5.2.0

  # UI/UX helpers
  flutter_svg: ^2.0.10+1
  cached_network_image: ^3.4.1
  intl: ^0.20.0

  # Logging
  logger: ^2.6.0

dev_dependencies:
  flutter_test:
    sdk: flutter

  # Code generation & development tools (MOVED HERE)
  build_runner: ^2.4.12
  freezed: ^3.2.0
  freezed_annotation: ^3.1.0
  json_serializable: ^6.8.0
  json_annotation: ^4.9.0

  # Linting (Note: 'flutter_lints' is a DEV dependency)
  flutter_lints: ^6.0.0

flutter:
  # Only Flutter-specific configurations belong here:
  uses-material-design: true
  assets:
    - .env

  # assets:
  #   - images/
  # fonts:
  #   - family: ...
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

D:\Dev\ogrenci_intelligence\analysis_options.yaml

# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

analyzer:
  errors:
    invalid_annotation_target: ignore
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
# Safety / correctness
    always_declare_return_types: true
    avoid_dynamic_calls: true
    avoid_print: true
    cancel_subscriptions: true
    close_sinks: true
    prefer_final_locals: true
    require_trailing_commas: true
    unawaited_futures: true

    # Style / maintainability
    directives_ordering: true
    sort_pub_dependencies: false

    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

lib/main.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'src/app/bootstrap.dart';
import 'src/app/app.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await bootstrap(); // loads env + initializes Supabase

  runApp(const ProviderScope(child: App()));
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/app/bootstrap.dart

import '../core/config/env.dart';
import '../core/supabase/supabase_service.dart';

Future<void> bootstrap() async {
  await Env.load();

  await SupabaseService.initialize(
    supabaseUrl: Env.supabaseUrl,
    supabaseAnonKey: Env.supabaseAnonKey,
  );
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

lib/src/core/config/env.dart

// lib/src/core/config/env.dart
import 'package:flutter_dotenv/flutter_dotenv.dart';

class Env {
  static Future<void> load() async {
    await dotenv.load(fileName: '.env');
  }

  static String _must(String key) {
    final v = dotenv.env[key];
    if (v == null || v.trim().isEmpty) {
      throw StateError('Missing env var: $key');
    }
    return v.trim();
  }

  static String get supabaseUrl => _must('SUPABASE_URL');
  static String get supabaseAnonKey => _must('SUPABASE_ANON_KEY');

  static String get deepLinkScheme =>
      (dotenv.env['DEEPLINK_SCHEME'] ?? 'com.ogrenciintelligence').trim();

  static Uri get deepLinkCallback => Uri.parse(
        (dotenv.env['DEEPLINK_CALLBACK'] ?? '$deepLinkScheme://login-callback')
            .trim(),
      );

  static Uri get deepLinkResetPassword => Uri.parse(
        (dotenv.env['DEEPLINK_RESET_PASSWORD'] ??
                '$deepLinkScheme://reset-password')
            .trim(),
      );
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/supabase/supabase_service.dart


import 'package:supabase_flutter/supabase_flutter.dart';

class SupabaseService {
  static Future<void> initialize({
    required String supabaseUrl,
    required String supabaseAnonKey,
  }) async {
    if (supabaseUrl.isEmpty || supabaseAnonKey.isEmpty) {
      throw Exception('Missing SUPABASE_URL or SUPABASE_ANON_KEY in .env');
    }

    await Supabase.initialize(
      url: supabaseUrl,
      anonKey: supabaseAnonKey,
      authOptions: const FlutterAuthClientOptions(
        authFlowType: AuthFlowType.pkce,
      ),
    );
  }

  static SupabaseClient get client => Supabase.instance.client;
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/routes.dart


class Routes {
  // Public
  static const home = '/';
  static const login = '/login';
  static const register = '/register';
  static const forgotPassword = '/forgot-password';
  static const emailVerification = '/email-verification';
  static const resetPassword = '/reset-password';

  static const companyAuth = '/company/auth';

  static const adminLogin = '/admin/login';
  static const adminSetup = '/admin/setup';

  // Student (protected)
  static const dashboard = '/dashboard';
  static const profile = '/profile';
  static const settings = '/settings';
  static const courses = '/courses';
  static const courseDetail = '/courses/:id';
  static const jobs = '/jobs';
  static const jobDetail = '/jobs/:id';
  static const internships = '/internships';
  static const internshipDetail = '/internships/:id';
  static const applications = '/applications';
  static const favorites = '/favorites';
  static const notifications = '/notifications';
  static const leaderboard = '/leaderboard';
  static const pointsSystem = '/points-system';
  static const debug = '/debug';

  // Footer pages (public)
  static const howItWorks = '/how-it-works';
  static const about = '/about';
  static const contact = '/contact';
  static const privacy = '/privacy-policy';
  static const terms = '/terms-of-service';

  // Company (protected)
  static const companyDashboard = '/company/dashboard';
  static const companyRegister = '/company/register';
  static const companyJobs = '/company/jobs';
  static const companyJobsCreate = '/company/jobs/create';
  static const companyJobsEdit = '/company/jobs/:id/edit';
  static const companyJobApplications = '/company/jobs/:id/applications';

  static const companyInternships = '/company/internships';
  static const companyInternshipsCreate = '/company/internships/create';
  static const companyInternshipsEdit = '/company/internships/:id/edit';
  static const companyInternshipApplications = '/company/internships/:id/applications';

  static const companyProfile = '/company/profile';
  static const companyReports = '/company/reports';
  static const companyApplications = '/company/applications';
  static const companyPricing = '/company/pricing';

  // Admin (protected)
  static const adminDashboard = '/admin/dashboard';
  static const adminCompanies = '/admin/companies';
  static const adminUsers = '/admin/users';
  static const adminJobs = '/admin/jobs';
  static const adminSubscriptions = '/admin/subscriptions';
  static const adminReports = '/admin/reports';
  static const adminSettings = '/admin/settings';
  static const adminLogs = '/admin/logs';
  static const adminProfile = '/admin/profile';
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/route_guards.dart


import '../../features/auth/domain/auth_models.dart';
import 'routes.dart';

class RouteGuards {
  // Mirrors React's studentOnlyPaths (including detail pages)
  static const List<String> _studentRoots = [
    Routes.courses,
    Routes.jobs,
    Routes.internships,
    Routes.applications,
    Routes.favorites,
    Routes.notifications,
    Routes.leaderboard,
    Routes.profile,
    Routes.dashboard,
    Routes.settings,
    Routes.debug,
  ];

  static bool isStudentPath(String location) {
    return _studentRoots.any(
      (root) => location == root || location.startsWith('$root/'),
    );
  }

  /// Treat everything under /company as company area.
  static bool isCompanyPath(String location) =>
      location == '/company' || location.startsWith('/company/');

  /// Treat everything under /admin as admin area (safer than enumerating).
  static bool isAdminPath(String location) =>
      location == '/admin' || location.startsWith('/admin/');

  static bool isPublicPath(String location) {
    const publicExact = <String>{
      Routes.home,
      Routes.login,
      Routes.register,
      Routes.forgotPassword,
      Routes.emailVerification,
      Routes.resetPassword, // ✅ deep link recovery must be public

      Routes.companyAuth,

      Routes.adminLogin,
      Routes.adminSetup,

      Routes.howItWorks,
      Routes.about,
      Routes.contact,
      Routes.privacy,
      Routes.terms,

      // React: public
      Routes.pointsSystem,
    };
    return publicExact.contains(location);
  }

  /// Role-based redirects (mirrors GlobalRouteControl + ProtectedRoute behavior)
  static String? redirectForRole({
    required UserType userType,
    required String location,
  }) {
    // Never role-redirect public pages (router handles auth pages separately)
    if (isPublicPath(location)) return null;

    // Admin can access ONLY admin area (recommended)
    if (userType == UserType.admin) {
      if (!isAdminPath(location)) return Routes.adminDashboard;
      return null;
    }

    // Company can access company area, not student/admin
    if (userType == UserType.company) {
      if (isAdminPath(location)) return Routes.companyDashboard;
      if (isStudentPath(location)) return Routes.companyDashboard;
      return null;
    }

    // Student can access student area, not company/admin
    if (userType == UserType.student) {
      if (isAdminPath(location)) return Routes.dashboard;
      if (isCompanyPath(location)) return Routes.dashboard;
      return null;
    }

    // Guest handling is done by router "not authorized" block
    return null;
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/app/app.dart


import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../core/deeplink/deep_link_service.dart';
import '../core/routing/app_router.dart';
import '../core/supabase/supabase_service.dart';

class App extends ConsumerStatefulWidget {
  const App({super.key});

  @override
  ConsumerState<App> createState() => _AppState();
}

class _AppState extends ConsumerState<App> {
  DeepLinkService? _deepLinks;

  @override
  void initState() {
    super.initState();

    final router = ref.read(goRouterProvider);

    _deepLinks = DeepLinkService(
      client: SupabaseService.client,
      router: router,
    );

    unawaited(_deepLinks!.start());
  }

  @override
  void dispose() {
    unawaited(_deepLinks?.stop() ?? Future.value());
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final router = ref.watch(goRouterProvider);

    return MaterialApp.router(
      debugShowCheckedModeBanner: false,
      title: 'Öğrenci Intelligence',
      routerConfig: router,
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/shared/widgets/empty_state.dart


import 'package:flutter/material.dart';

class PlaceholderScreen extends StatelessWidget {
  const PlaceholderScreen({super.key, required this.title, this.subtitle});

  final String title;
  final String? subtitle;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(title, style: Theme.of(context).textTheme.headlineSmall),
                if (subtitle != null) ...[
                  const SizedBox(height: 8),
                  Text(
                    subtitle!,
                    textAlign: TextAlign.center,
                    style: Theme.of(context).textTheme.bodyMedium,
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/domain/auth_models.dart


class CompanyMembership {
  const CompanyMembership({
    required this.companyId,
    required this.role,
  });

  final String companyId;
  final String role;

  factory CompanyMembership.fromJson(Map<String, dynamic> json) {
    return CompanyMembership(
      companyId: json['company_id'].toString(),
      role: (json['role'] ?? '').toString(),
    );
  }
}

enum AppRole { guest, student, company, admin }

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/data/auth_repository.dart


// lib/features/auth/data/auth_repository.dart
import 'package:supabase_flutter/supabase_flutter.dart';
import '../domain/auth_models.dart';

class AuthRepository {
  AuthRepository(this._client);

  final SupabaseClient _client;

  User? get currentUser => _client.auth.currentUser;
  Session? get currentSession => _client.auth.currentSession;

  Stream<AuthState> authStateChanges() => _client.auth.onAuthStateChange;

  Future<User> signIn({
    required String email,
    required String password,
  }) async {
    final res = await _client.auth.signInWithPassword(
      email: email,
      password: password,
    );

    final user = res.user;
    if (user == null) {
      throw const AuthException('Sign-in failed: user is null.');
    }

    // Block if email not confirmed (same as React)
    if (user.emailConfirmedAt == null) {
      await _client.auth.signOut();
      throw const AuthException('Please verify your email address.');
    }

    return user;
  }

  Future<User> signUp({
    required String email,
    required String password,
    required String fullName,
  }) async {
    final res = await _client.auth.signUp(
      email: email,
      password: password,
      data: {'full_name': fullName},
    );

    final user = res.user;
    if (user == null) {
      throw const AuthException('Sign-up failed: user is null.');
    }
    return user;
  }

  Future<void> signOut() => _client.auth.signOut();

  Future<void> resetPassword({
    required String email,
    String? redirectTo,
  }) async {
    await _client.auth.resetPasswordForEmail(email, redirectTo: redirectTo);
  }

  Future<void> updatePassword(String newPassword) async {
    await _client.auth.updateUser(UserAttributes(password: newPassword));
  }

  Future<void> updateProfile(Map<String, dynamic> updates) async {
    await _client.auth.updateUser(UserAttributes(data: updates));
  }

  Future<Session?> refreshSession() async {
    final res = await _client.auth.refreshSession();
    return res.session;
  }

  Future<void> resendSignupOtp({required String email}) async {
    await _client.auth.resend(
      type: OtpType.signup,
      email: email,
    );
  }

  Future<void> upsertStudentProfile({
    required String userId,
    required String email,
    required String fullName,
    required String department,
    required int year,
  }) async {
    await _client.from('profiles').upsert({
      'id': userId,
      'email': email,
      'full_name': fullName,
      'department': department,
      'year': year,
      'updated_at': DateTime.now().toUtc().toIso8601String(),
    });
  }

  Future<CompanyMembership?> fetchCompanyMembership(String userId) async {
    final row = await _client
        .from('company_users')
        .select('company_id, role')
        .eq('user_id', userId)
        .maybeSingle();

    if (row == null) return null;
    return CompanyMembership.fromJson(row);
  }

  Future<User?> getFreshUser() async {
  final res = await _client.auth.getUser();
  return res.user;
}

Future<void> resendSignupVerificationEmail(String email) async {
  await _client.auth.resend(type: OtpType.signup, email: email);
}

}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/controllers/auth_controller.dart


import 'dart:async';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../..//core/supabase/supabase_service.dart';
import '../../data/auth_repository.dart';
import '../../domain/auth_models.dart';

final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository(SupabaseService.client);
});

/// Session stream (source of truth)
final sessionProvider = StreamProvider<Session?>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  final controller = StreamController<Session?>();

  controller.add(repo.currentSession);

  final sub = repo.authStateChanges().listen((evt) {
    controller.add(evt.session);
  });

ref.onDispose(() async {
  await sub.cancel();
  await controller.close();
});

  return controller.stream;
});

final currentUserProvider = Provider<User?>((ref) {
  final session = ref.watch(sessionProvider).value;
  return session?.user;
});

/// Company membership (company_id + role) like in AuthContext.jsx
final companyMembershipProvider = FutureProvider<CompanyMembership?>((ref) async {
  final user = ref.watch(currentUserProvider);
  if (user == null) return null;

  final repo = ref.watch(authRepositoryProvider);
  return repo.fetchCompanyMembership(user.id);
});

/// App role (admin > company > student)
final appRoleProvider = FutureProvider<AppRole>((ref) async {
  final user = ref.watch(currentUserProvider);
  if (user == null) return AppRole.guest;

  // Email verification gate (same philosophy as ProtectedRoute + signIn)
  if (user.emailConfirmedAt == null) return AppRole.guest;

  final repo = ref.watch(authRepositoryProvider);

  if (await repo.isAdmin(user)) return AppRole.admin;

  final membership = await ref.watch(companyMembershipProvider.future);
  if (membership != null) return AppRole.company;

  return AppRole.student;
});

/// Simple controller for auth actions + loading flag
final authControllerProvider =
    StateNotifierProvider<AuthController, bool>((ref) {
  return AuthController(ref.watch(authRepositoryProvider));
});

class AuthController extends StateNotifier<bool> {
  AuthController(this._repo) : super(false);

  final AuthRepository _repo;

  Future<String?> signIn(String email, String password) async {
    try {
      state = true;
      await _repo.signIn(email: email, password: password);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signUp(String email, String password, String fullName) async {
    try {
      state = true;
      await _repo.signUp(email: email, password: password, fullName: fullName);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signOut() async {
    try {
      state = true;
      await _repo.signOut();
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> resetPassword(String email, {String? redirectTo}) async {
    try {
      state = true;
      await _repo.resetPassword(email: email, redirectTo: redirectTo);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> updatePassword(String newPassword) async {
    try {
      state = true;
      await _repo.updatePassword(newPassword);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> updateProfile(Map<String, dynamic> updates) async {
    try {
      state = true;
      await _repo.updateProfile(updates);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> refreshSession() async {
    try {
      await _repo.refreshSession();
      return null;
    } catch (e) {
      return e.toString();
    }
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
android/app/src/main/AndroidManifest.xml

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:label="ogrenci_intelligence"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
            
            <intent-filter android:autoVerify="false">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />

                <data
                    android:scheme="com.ogrenciintelligence"
                    android:host="login-callback" />
                <data 
                    android:scheme="com.ogrenciintelligence" 
                    android:host="reset-password" />
            </intent-filter>

        </activity>
        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
</manifest>
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
ios/Runner/Info.plist

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>CFBundleDevelopmentRegion</key>
	<string>$(DEVELOPMENT_LANGUAGE)</string>
	<key>CFBundleDisplayName</key>
	<string>Ogrenci Intelligence</string>
	<key>CFBundleExecutable</key>
	<string>$(EXECUTABLE_NAME)</string>
	<key>CFBundleIdentifier</key>
	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
	<key>CFBundleInfoDictionaryVersion</key>
	<string>6.0</string>
	<key>CFBundleName</key>
	<string>ogrenci_intelligence</string>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleShortVersionString</key>
	<string>$(FLUTTER_BUILD_NAME)</string>
	<key>CFBundleSignature</key>
	<string>????</string>
	<key>CFBundleVersion</key>
	<string>$(FLUTTER_BUILD_NUMBER)</string>
	<key>LSRequiresIPhoneOS</key>
	<true/>
	<key>UILaunchStoryboardName</key>
	<string>LaunchScreen</string>
	<key>UIMainStoryboardFile</key>
	<string>Main</string>
	<key>UISupportedInterfaceOrientations</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
	<key>UISupportedInterfaceOrientations~ipad</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationPortraitUpsideDown</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
	<key>CADisableMinimumFrameDurationOnPhone</key>
	<true/>
	<key>UIApplicationSupportsIndirectInputEvents</key>
	<true/>
	<key>CFBundleURLTypes</key>
	<array>
	<dict>
		<key>CFBundleURLSchemes</key>
		<array>
		<string>com.ogrenciintelligence</string>
		</array>
	</dict>
	</array>
</dict>
</plist>

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/data/admin_repository.dart


import 'package:supabase_flutter/supabase_flutter.dart';
import '../domain/admin_models.dart';

class AdminRepository {
  AdminRepository(this._client);

  final SupabaseClient _client;

  Future<AdminData?> getActiveAdminByUserId(String userId) async {
    final row = await _client
        .from('admins')
        .select('*')
        .eq('user_id', userId)
        .eq('is_active', true)
        .maybeSingle();

    if (row == null) return null;
    return AdminData.fromJson(row);
  }

  Future<void> logAdminAction({
    required String adminId,
    required String actionType,
    required String targetType,
    String? targetId,
    Map<String, dynamic> details = const {},
  }) async {
    await _client.from('admin_logs').insert({
      'admin_id': adminId,
      'action_type': actionType,
      'target_type': targetType,
      'target_id': targetId,
      'details': details,
      // On mobile, don't pretend we have the public IP.
      'ip_address': null,
    });
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
import 'dart:async';

import 'package:app_links/app_links.dart';
import 'package:flutter/foundation.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class DeepLinkService {
  DeepLinkService(this._client);

  final SupabaseClient _client;
  final AppLinks _appLinks = AppLinks();
  StreamSubscription<Uri>? _sub;

  Future<void> start() async {
    final initial = await _appLinks.getInitialLink(); // app_links 6.x
    if (initial != null) {
      await _handle(initial);
    }

    _sub = _appLinks.uriLinkStream.listen((uri) {
      unawaited(_handle(uri));
    }, onError: (e) {
      if (kDebugMode) {
        // print('Deep link stream error: $e');
      }
    });
  }

  Future<void> stop() async {
    await _sub?.cancel();
    _sub = null;
  }

  Future<void> _handle(Uri uri) async {
    try {
      final s = uri.toString();

      // Only process auth-related links
      final looksAuth = s.contains('access_token=') ||
          s.contains('refresh_token=') ||
          s.contains('type=recovery') ||
          s.contains('code=');

      if (!looksAuth) return;

      await _client.auth.getSessionFromUrl(uri);
    } catch (e) {
      if (kDebugMode) {
        // print('Deep link parse failed: $e');
      }
    }
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/domain/admin_models.dart


class AdminData {
  const AdminData({
    required this.id,
    required this.userId,
    required this.role,
    required this.isActive,
    required this.permissions,
    required this.raw,
  });

  final String id;
  final String userId;
  final String role;
  final bool isActive;
  final Map<String, dynamic> permissions;
  final Map<String, dynamic> raw;

  bool get isSuperAdmin => role == 'super_admin';

  factory AdminData.fromJson(Map<String, dynamic> json) {
    return AdminData(
      id: (json['id'] ?? '').toString(),
      userId: (json['user_id'] ?? '').toString(),
      role: (json['role'] ?? '').toString(),
      isActive: json['is_active'] == true,
      permissions: (json['permissions'] as Map?)?.cast<String, dynamic>() ?? const {},
      raw: json,
    );
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/admin/presentation/controllers/admin_controller.dart


import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/supabase/supabase_service.dart';
import '../../data/admin_repository.dart';
import '../../domain/admin_models.dart';

final adminRepositoryProvider = Provider<AdminRepository>((ref) {
  return AdminRepository(SupabaseService.client);
});

final activeAdminProvider = FutureProvider<AdminData?>((ref) async {
  final User? user = SupabaseService.client.auth.currentUser;
  if (user == null) return null;
  final repo = ref.watch(adminRepositoryProvider);
  return repo.getActiveAdminByUserId(user.id);
});

final isAdminProvider = Provider<bool>((ref) {
  return ref.watch(activeAdminProvider).valueOrNull != null;
});

final isSuperAdminProvider = Provider<bool>((ref) {
  final admin = ref.watch(activeAdminProvider).valueOrNull;
  return admin?.isSuperAdmin ?? false;
});

final adminActionControllerProvider =
    StateNotifierProvider<AdminActionController, bool>((ref) {
  return AdminActionController(ref.watch(adminRepositoryProvider), ref);
});

class AdminActionController extends StateNotifier<bool> {
  AdminActionController(this._repo, this._ref) : super(false);

  final AdminRepository _repo;
  final Ref _ref;

  Future<String?> logAction({
  required String actionType,
  required String targetType,
  String? targetId,
  Map<String, dynamic> details = const {},
}) async {
  try {
    state = true;

    final admin = await _ref.read(activeAdminProvider.future);
    if (admin == null) return 'Not an admin';

    await _repo.logAdminAction(
      adminId: admin.id,
      actionType: actionType,
      targetType: targetType,
      targetId: targetId,
      details: details,
    );
    return null;
  } catch (e) {
    return e.toString();
  } finally {
    state = false;
  }
}
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/domain/auth_models.dart


enum UserType { guest, student, company, admin }

class CompanyMembership {
  const CompanyMembership({
    required this.companyId,
    required this.role,
  });

  final String companyId;
  final String role;

  factory CompanyMembership.fromJson(Map<String, dynamic> json) {
    return CompanyMembership(
      companyId: json['company_id'].toString(),
      role: (json['role'] ?? '').toString(),
    );
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/controllers/auth_controller.dart


// lib/features/auth/presentation/controllers/auth_controller.dart
import 'dart:async';
import 'package:flutter/foundation.dart'; // ✅ for unawaited
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/config/env.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../../../admin/presentation/controllers/admin_controller.dart';
import '../../data/auth_repository.dart';
import '../../domain/auth_models.dart';

class AuthViewState {
  const AuthViewState({
    required this.user,
    required this.session,
    required this.loading,
    required this.userType,
    this.companyId,
    this.companyRole,
  });

  final User? user;
  final Session? session;
  final bool loading;

  final UserType userType;
  final String? companyId;
  final String? companyRole;

  bool get isAuthenticated => user != null; // has session/user
bool get isEmailVerified => user?.emailConfirmedAt != null;
}

final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository(SupabaseService.client);
});

final authViewStateProvider = StreamProvider<AuthViewState>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  final controller = StreamController<AuthViewState>.broadcast();

  Future<void> emit(Session? session, {required bool loading}) async {
    final user = session?.user;

    UserType userType = UserType.guest;
    String? companyId;
    String? companyRole;

    if (user != null && user.emailConfirmedAt != null) {
      // Admin has priority
      final admin = await ref.read(activeAdminProvider.future);
      if (admin != null) {
        userType = UserType.admin;
      } else {
        final membership = await repo.fetchCompanyMembership(user.id);
        if (membership != null) {
          userType = UserType.company;
          companyId = membership.companyId;
          companyRole = membership.role;
        } else {
          userType = UserType.student;
        }
      }
    }

    controller.add(
      AuthViewState(
        user: user,
        session: session,
        loading: loading,
        userType: userType,
        companyId: companyId,
        companyRole: companyRole,
      ),
    );
  }

  // initial
  controller.add(const AuthViewState(
    user: null,
    session: null,
    loading: true,
    userType: UserType.guest,
  ));

  unawaited(() async {
    await emit(repo.currentSession, loading: false);
  }());

  final sub = repo.authStateChanges().listen((evt) async {
    ref.invalidate(activeAdminProvider);
    await emit(evt.session, loading: false);
  });

  ref.onDispose(() {
    unawaited(sub.cancel());
    unawaited(controller.close());
  });

  return controller.stream;
});

final authActionLoadingProvider =
    StateNotifierProvider<AuthActionController, bool>((ref) {
  return AuthActionController(ref.watch(authRepositoryProvider));
});

class AuthActionController extends StateNotifier<bool> {
  AuthActionController(this._repo) : super(false);
  final AuthRepository _repo;

  Future<String?> signIn(String email, String password) async {
    try {
      state = true;
      await _repo.signIn(email: email, password: password);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signUp(String email, String password, String fullName) async {
    try {
      state = true;
      await _repo.signUp(email: email, password: password, fullName: fullName);
      return null;
    } on AuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> signOut() async {
    try {
      state = true;
      await _repo.signOut();
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> resetPassword(String email) async {
    try {
      state = true;
      await _repo.resetPassword(
        email: email,
        redirectTo: Env.deepLinkResetPassword.toString(),
      );
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }

  Future<String?> updatePassword(String newPassword) async {
    try {
      state = true;
      await _repo.updatePassword(newPassword);
      return null;
    } catch (e) {
      return e.toString();
    } finally {
      state = false;
    }
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/reset_password_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../controllers/auth_controller.dart';

class ResetPasswordScreen extends ConsumerStatefulWidget {
  const ResetPasswordScreen({super.key});

  @override
  ConsumerState<ResetPasswordScreen> createState() => _ResetPasswordScreenState();
}

class _ResetPasswordScreenState extends ConsumerState<ResetPasswordScreen> {
  final _password = TextEditingController();

  @override
  void dispose() {
    _password.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Reset Password')),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _password,
              obscureText: true,
              decoration: const InputDecoration(
                labelText: 'New password',
              ),
            ),
            const SizedBox(height: 12),
            ElevatedButton(
              onPressed: busy
                  ? null
                  : () async {
                      final err = await ref
                          .read(authActionLoadingProvider.notifier)
                          .updatePassword(_password.text.trim());
                      if (!context.mounted) return;

                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(content: Text(err ?? 'Password updated')),
                      );
                    },
              child: busy
                  ? const SizedBox(
                      height: 18,
                      width: 18,
                      child: CircularProgressIndicator(strokeWidth: 2),
                    )
                  : const Text('Update'),
            ),
          ],
        ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/company/data/company_repository.dart


import 'package:supabase_flutter/supabase_flutter.dart';

class CompanyRepository {
  CompanyRepository(this._client);

  final SupabaseClient _client;

  /// Returns membership if the current user belongs to a company.
  /// Mirrors React: supabase.from("company_users").select("company_id, role").eq("user_id", user.id).maybeSingle()
  Future<({String companyId, String role})?> getMembershipByUserId(String userId) async {
    final row = await _client
        .from('company_users')
        .select('company_id, role')
        .eq('user_id', userId)
        .maybeSingle();

    if (row == null) return null;

    return (
      companyId: row['company_id'].toString(),
      role: (row['role'] ?? '').toString(),
    );
  }

  /// Optional: get company basic profile (we'll expand later based on your DB schema).
  Future<Map<String, dynamic>?> getCompanyById(String companyId) async {
    final row = await _client
        .from('companies')
        .select('*')
        .eq('id', companyId)
        .maybeSingle();
    return row;
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/login_screen.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../controllers/auth_controller.dart';

class LoginScreen extends ConsumerStatefulWidget {
  const LoginScreen({super.key, this.from});

  final String? from;

  @override
  ConsumerState<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends ConsumerState<LoginScreen> {
  final _email = TextEditingController();
  final _password = TextEditingController();
  bool _showPassword = false;
  bool _rememberMe = false;
  String? _error;

  @override
  void dispose() {
    _email.dispose();
    _password.dispose();
    super.dispose();
  }

  /// React-parity:
  /// - If redirected to /login?from=..., after login go back to that exact location.
  /// - If missing/invalid, go to student default: /dashboard
  /// - Prevent external redirects + auth-page loops
  String _resolveFromTarget() {
    final raw = widget.from?.trim();
    if (raw == null || raw.isEmpty) return Routes.dashboard;

    String decoded;
    try {
      decoded = Uri.decodeComponent(raw);
    } catch (_) {
      return Routes.dashboard;
    }

    // Must be an internal absolute path.
    if (!decoded.startsWith('/')) return Routes.dashboard;

    final uri = Uri.tryParse(decoded);
    if (uri == null) return Routes.dashboard;

    // Block external redirects
    if (uri.hasScheme || uri.hasAuthority) return Routes.dashboard;

    // Avoid loops back into auth pages
    const blocked = <String>{
      Routes.login,
      Routes.register,
      Routes.forgotPassword,
      Routes.emailVerification,
      Routes.companyAuth,
      Routes.companyRegister,
      Routes.adminLogin,
      Routes.adminSetup,
    };

    if (blocked.contains(uri.path)) return Routes.dashboard;

    // Preserve path + query exactly
    return uri.toString();
  }

  Future<void> _submit() async {
    setState(() => _error = null);

    final email = _email.text.trim();
    final pass = _password.text;

    if (email.isEmpty || pass.isEmpty) {
      setState(() => _error = 'Please fill in all fields.');
      return;
    }

    final err = await ref
        .read(authActionLoadingProvider.notifier)
        .signIn(email, pass);

    if (!mounted) return;

    if (err != null) {
      setState(() => _error = err);
      return;
    }
    final user = ref.read(authViewStateProvider).value?.user;
    if (user != null && user.emailConfirmedAt == null) {
      final uri = Uri(
        path: Routes.emailVerification,
        queryParameters: {'email': email},
      ).toString();
      context.go(uri);
      return;
    }
    // React behavior: go to `from` if present; otherwise dashboard.
    // Router will still enforce role redirects (admin/company).
    final target = _resolveFromTarget();
    context.go(target);
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.lock_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Welcome back',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'Student login',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.mail_outline),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _password,
                      obscureText: !_showPassword,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        prefixIcon: const Icon(Icons.lock_outline),
                        suffixIcon: IconButton(
                          onPressed: () =>
                              setState(() => _showPassword = !_showPassword),
                          icon: Icon(
                            _showPassword ? Icons.visibility_off : Icons.visibility,
                          ),
                        ),
                      ),
                    ),

                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Checkbox(
                          value: _rememberMe,
                          onChanged: (v) =>
                              setState(() => _rememberMe = v ?? false),
                        ),
                        const Text('Remember me'),
                        const Spacer(),
                        TextButton(
                          onPressed: () => context.push(Routes.forgotPassword),
                          child: const Text('Forgot password?'),
                        ),
                      ],
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(
                          _error!,
                          style: const TextStyle(color: Colors.red),
                        ),
                      ),
                    ],

                    const SizedBox(height: 14),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Login'),
                    ),

                    const SizedBox(height: 14),
                    const Divider(),
                    const SizedBox(height: 10),

                    OutlinedButton(
                      onPressed: () => context.push(Routes.companyAuth),
                      child: const Text('Login as company'),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text('No account? '),
                        TextButton(
                          onPressed: () => context.push(Routes.register),
                          child: const Text('Register'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/features/auth/presentation/screens/register_screen.dart


import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../controllers/auth_controller.dart';

class RegisterScreen extends ConsumerStatefulWidget {
  const RegisterScreen({super.key});

  @override
  ConsumerState<RegisterScreen> createState() => _RegisterScreenState();
}

class _RegisterScreenState extends ConsumerState<RegisterScreen> {
  final _fullName = TextEditingController();
  final _email = TextEditingController();
  final _password = TextEditingController();
  final _confirm = TextEditingController();

  bool _showPassword = false;
  bool _acceptTerms = false;

  String? _department;
  int? _year;

  String? _error;

  static const departments = [
    "Bilgisayar Mühendisliği",
    "Yazılım Mühendisliği",
    "Elektrik-Elektronik Mühendisliği",
    "Endüstri Mühendisliği",
    "Makine Mühendisliği",
    "İnşaat Mühendisliği",
    "Mimarlık",
    "İşletme",
    "İktisat",
    "Hukuk",
    "Tıp",
    "Diş Hekimliği",
    "Eczacılık",
    "Hemşirelik",
    "Psikoloji",
    "Öğretmenlik",
    "İletişim",
    "Güzel Sanatlar",
    "Diğer",
  ];

  @override
  void dispose() {
    _fullName.dispose();
    _email.dispose();
    _password.dispose();
    _confirm.dispose();
    super.dispose();
  }

  bool _validate() {
    setState(() => _error = null);

    if (_password.text != _confirm.text) {
      setState(() => _error = 'Passwords do not match.');
      return false;
    }
    if (_password.text.length < 6) {
      setState(() => _error = 'Password must be at least 6 characters.');
      return false;
    }
    if (_department == null) {
      setState(() => _error = 'Please select your department.');
      return false;
    }
    if (_year == null) {
      setState(() => _error = 'Please select your year.');
      return false;
    }
    if (!_acceptTerms) {
      setState(() => _error = 'You must accept Terms & Privacy.');
      return false;
    }
    return true;
  }

  Future<void> _submit() async {
    if (!_validate()) return;

    final email = _email.text.trim();
    final pass = _password.text;
    final fullName = _fullName.text.trim();

    final err = await ref
        .read(authActionLoadingProvider.notifier)
        .signUp(email, pass, fullName);

    if (!mounted) return;

    if (err != null) {
      setState(() => _error = err);
      return;
    }

    // Try to update profile (same as React). Ignore errors if RLS blocks it.
    try {
      final user = SupabaseService.client.auth.currentUser;
      if (user != null) {
        await SupabaseService.client.from('profiles').update({
          'full_name': fullName,
          'department': _department,
          'year': _year,
          'email': email,
          'updated_at': DateTime.now().toIso8601String(),
        }).eq('id', user.id);
      }
    } catch (_) {
      // ignore
    }

    // Professional flow: show email verification page, with email hint
    final uri = Uri(
      path: Routes.emailVerification,
      queryParameters: {'email': email},
    ).toString();

    context.go(uri);
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Register')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.person_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Create your account',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'Student registration',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _fullName,
                      decoration: const InputDecoration(
                        labelText: 'Full name',
                        prefixIcon: Icon(Icons.badge_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.mail_outline),
                      ),
                    ),
                    const SizedBox(height: 12),

                    DropdownButtonFormField<String>(
                      initialValue: _department,
                      items: departments
                          .map((d) => DropdownMenuItem(value: d, child: Text(d)))
                          .toList(),
                      onChanged: (v) => setState(() => _department = v),
                      decoration: const InputDecoration(
                        labelText: 'Department',
                        prefixIcon: Icon(Icons.school_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    DropdownButtonFormField<int>(
                      initialValue: _year,
                      items: const [1, 2, 3, 4, 5]
                          .map((y) => DropdownMenuItem(
                                value: y,
                                child: Text(y == 5 ? '5+ (and above)' : '$y'),
                              ))
                          .toList(),
                      onChanged: (v) => setState(() => _year = v),
                      decoration: const InputDecoration(
                        labelText: 'Year',
                        prefixIcon: Icon(Icons.calendar_today_outlined),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _password,
                      obscureText: !_showPassword,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        prefixIcon: const Icon(Icons.lock_outline),
                        suffixIcon: IconButton(
                          onPressed: () => setState(() => _showPassword = !_showPassword),
                          icon: Icon(_showPassword ? Icons.visibility_off : Icons.visibility),
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),

                    TextField(
                      controller: _confirm,
                      obscureText: !_showPassword,
                      decoration: const InputDecoration(
                        labelText: 'Confirm password',
                        prefixIcon: Icon(Icons.lock_outline),
                      ),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Checkbox(
                          value: _acceptTerms,
                          onChanged: (v) => setState(() => _acceptTerms = v ?? false),
                        ),
                        Expanded(
                          child: Padding(
                            padding: const EdgeInsets.only(top: 10),
                            child: Wrap(
                              children: [
                                const Text('I accept '),
                                GestureDetector(
                                  onTap: () => context.push(Routes.terms),
                                  child: Text(
                                    'Terms of Service',
                                    style: TextStyle(
                                      color: Theme.of(context).colorScheme.primary,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                                const Text(' and '),
                                GestureDetector(
                                  onTap: () => context.push(Routes.privacy),
                                  child: Text(
                                    'Privacy Policy',
                                    style: TextStyle(
                                      color: Theme.of(context).colorScheme.primary,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ),
                                const Text('.'),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(_error!, style: const TextStyle(color: Colors.red)),
                      ),
                    ],

                    const SizedBox(height: 14),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Register'),
                    ),

                    const SizedBox(height: 14),
                    const Divider(),
                    const SizedBox(height: 10),

                    OutlinedButton(
                      onPressed: () => context.push(Routes.companyAuth),
                      child: const Text('Register as company'),
                    ),

                    const SizedBox(height: 12),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Text('Already have an account? '),
                        TextButton(
                          onPressed: () => context.go(Routes.login),
                          child: const Text('Login'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/features/auth/presentation/screens/forgot_password_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../../../../core/routing/routes.dart';
import '../controllers/auth_controller.dart';

class ForgotPasswordScreen extends ConsumerStatefulWidget {
  const ForgotPasswordScreen({super.key});

  @override
  ConsumerState<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends ConsumerState<ForgotPasswordScreen> {
  final _email = TextEditingController();
  bool _submitted = false;
  String? _error;

  @override
  void dispose() {
    _email.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    setState(() => _error = null);

    final email = _email.text.trim();
    if (email.isEmpty) return;

    final err = await ref.read(authActionLoadingProvider.notifier).resetPassword(email);

    if (!mounted) return;

    if (err != null) {
      setState(() => _error = err);
    } else {
      setState(() => _submitted = true);
    }
  }

  @override
  Widget build(BuildContext context) {
    final busy = ref.watch(authActionLoadingProvider);

    if (_submitted) {
      return Scaffold(
        appBar: AppBar(title: const Text('Forgot Password')),
        body: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 520),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Card(
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Icon(Icons.check_circle_outline, size: 54),
                      const SizedBox(height: 12),
                      Text(
                        'Email sent!',
                        style: Theme.of(context).textTheme.titleLarge?.copyWith(
                              fontWeight: FontWeight.w700,
                            ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'A password reset link was sent to:\n${_email.text.trim()}',
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.amber.withOpacity(0.15),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.amber.withOpacity(0.35)),
                        ),
                        child: const Text(
                          'If you don’t see it, check your spam/junk folder.',
                          textAlign: TextAlign.center,
                        ),
                      ),
                      const SizedBox(height: 14),
                      TextButton(
                        onPressed: () => Navigator.of(context).pushNamed(Routes.login),
                        child: const Text('Back to Login'),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ),
      );
    }

    return Scaffold(
      appBar: AppBar(title: const Text('Forgot Password')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Center(
                      child: Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.primaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.mail_outline,
                          size: 34,
                          color: Theme.of(context).colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 14),
                    Text(
                      'Reset your password',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 6),
                    Text(
                      'We will send a reset link to your email.',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 18),

                    TextField(
                      controller: _email,
                      keyboardType: TextInputType.emailAddress,
                      decoration: const InputDecoration(
                        labelText: 'Email',
                        prefixIcon: Icon(Icons.alternate_email),
                      ),
                    ),

                    if (_error != null) ...[
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.10),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.red.withOpacity(0.25)),
                        ),
                        child: Text(
                          _error!,
                          style: const TextStyle(color: Colors.red),
                        ),
                      ),
                    ],

                    const SizedBox(height: 16),

                    ElevatedButton(
                      onPressed: busy ? null : _submit,
                      child: busy
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Send reset link'),
                    ),

                    const SizedBox(height: 10),

                    TextButton.icon(
                      onPressed: () => Navigator.of(context).pushNamed(Routes.login),
                      icon: const Icon(Icons.arrow_back),
                      label: const Text('Back to Login'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/core/routing/app_router.dart

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../features/auth/domain/auth_models.dart';
import '../../features/auth/presentation/controllers/auth_controller.dart';
import '../../features/auth/presentation/screens/company_auth_screen.dart';
import '../../features/auth/presentation/screens/email_verification_screen.dart';
import '../../features/auth/presentation/screens/forgot_password_screen.dart';
import '../../features/auth/presentation/screens/login_screen.dart';
import '../../features/auth/presentation/screens/register_screen.dart';
import '../../features/auth/presentation/screens/reset_password_screen.dart';
import '../../features/home/presentation/screens/home_screen.dart';
import '../../shared/widgets/app_navbar.dart';
import '../../shared/widgets/empty_state.dart';
import 'route_guards.dart';
import 'routes.dart';

final goRouterProvider = Provider<GoRouter>((ref) {
  final authStream = ref.watch(authViewStateProvider.stream);

  // ✅ IMPORTANT (Web): use the real browser URL, not defaultRouteName "/"
  final String initialLocation = () {
    if (kIsWeb) {
      final base = Uri.base;

      // Keep full path + query (React-like behavior)
      var loc = base.path;
      if (loc.isEmpty) loc = Routes.home;
      if (!loc.startsWith('/')) loc = '/$loc';

      if (base.hasQuery) loc = '$loc?${base.query}';
      return loc;
    }

    // Mobile/desktop: platform initial route name is fine
    final initial = WidgetsBinding.instance.platformDispatcher.defaultRouteName;
    return initial.isEmpty ? Routes.home : initial;
  }();

  return GoRouter(
    initialLocation: initialLocation,
    refreshListenable: GoRouterRefreshStream(authStream),

    redirect: (context, state) {
      final location = state.uri.path;

      final authAsync = ref.read(authViewStateProvider);
      if (authAsync.isLoading) return null;

      final auth = authAsync.value;
      if (auth == null) return null;

      // ✅ Always allow reset-password (deep-link recovery flow)
      if (location == Routes.resetPassword) return null;

      final isAuthorized = auth.isAuthenticated;

      // 1) Not authorized: allow only public routes
      if (!isAuthorized) {
        if (RouteGuards.isPublicPath(location)) return null;

        // Preserve "from" like React (login then come back)
        final from = Uri.encodeComponent(state.uri.toString());
        return '${Routes.login}?from=$from';
      }

      // 2) Authorized: role-based protection (protected areas)
      final roleRedirect = RouteGuards.redirectForRole(
        userType: auth.userType,
        location: location,
      );
      if (roleRedirect != null) return roleRedirect;

      // 3) Keep authenticated users out of auth pages
      const authPages = <String>{
        Routes.login,
        Routes.register,
        Routes.forgotPassword,
        Routes.emailVerification,
        Routes.companyAuth,
        Routes.companyRegister,
        Routes.adminLogin,
        Routes.adminSetup,
      };

      if (authPages.contains(location)) {
        if (auth.userType == UserType.admin) return Routes.adminDashboard;
        if (auth.userType == UserType.company) return Routes.companyDashboard;
        return Routes.dashboard;
      }

      // 4) Optional: redirect "/" for admin/company (students can see home)
      if (location == Routes.home) {
        if (auth.userType == UserType.admin) return Routes.adminDashboard;
        if (auth.userType == UserType.company) return Routes.companyDashboard;
      }

      return null;
    },

    routes: [
      // -----------------------------
      // Admin auth routes (standalone)
      // -----------------------------
      GoRoute(
        path: Routes.adminLogin,
        builder: (_, __) =>
            const PlaceholderScreen(title: 'Admin Login', showAppBar: true),
      ),
      GoRoute(
        path: Routes.adminSetup,
        builder: (_, __) =>
            const PlaceholderScreen(title: 'Admin Setup', showAppBar: true),
      ),

      // -------------
      // Admin shell
      // -------------
      ShellRoute(
        builder: (context, state, child) => AdminShell(child: child),
        routes: [
          GoRoute(
            path: Routes.adminDashboard,
            builder: (_, __) => const PlaceholderView(title: 'Admin Dashboard'),
          ),
          GoRoute(
            path: Routes.adminCompanies,
            builder: (_, __) => const PlaceholderView(title: 'Admin Companies'),
          ),
          GoRoute(
            path: Routes.adminUsers,
            builder: (_, __) => const PlaceholderView(title: 'Admin Users'),
          ),
          GoRoute(
            path: Routes.adminJobs,
            builder: (_, __) => const PlaceholderView(title: 'Admin Jobs'),
          ),
          GoRoute(
            path: Routes.adminSubscriptions,
            builder: (_, __) =>
                const PlaceholderView(title: 'Admin Subscriptions'),
          ),
          GoRoute(
            path: Routes.adminReports,
            builder: (_, __) => const PlaceholderView(title: 'Admin Reports'),
          ),
          GoRoute(
            path: Routes.adminSettings,
            builder: (_, __) => const PlaceholderView(title: 'Admin Settings'),
          ),
          GoRoute(
            path: Routes.adminLogs,
            builder: (_, __) => const PlaceholderView(title: 'Admin Logs'),
          ),
          GoRoute(
            path: Routes.adminProfile,
            builder: (_, __) => const PlaceholderView(title: 'Admin Profile'),
          ),
        ],
      ),

      // -----------------------------
      // Main shell (public + student + company)
      // -----------------------------
      ShellRoute(
        builder: (context, state, child) => MainShell(child: child),
        routes: [
          // Public
          GoRoute(
            path: Routes.home,
            builder: (_, __) => const HomeScreen(),
          ),

          // Auth screens
          GoRoute(
            path: Routes.login,
            builder: (context, state) => LoginScreen(
              from: state.uri.queryParameters['from'],
            ),
          ),
          GoRoute(
            path: Routes.register,
            builder: (_, __) => const RegisterScreen(),
          ),
          GoRoute(
            path: Routes.forgotPassword,
            builder: (_, __) => const ForgotPasswordScreen(),
          ),
          GoRoute(
            path: Routes.emailVerification,
            builder: (context, state) => EmailVerificationScreen(
              emailHint: state.uri.queryParameters['email'],
            ),
          ),
          GoRoute(
            path: Routes.resetPassword,
            builder: (_, __) => const ResetPasswordScreen(),
          ),

          // Company auth
          GoRoute(
            path: Routes.companyAuth,
            builder: (_, __) => const CompanyAuthScreen(),
          ),
          GoRoute(
            path: Routes.companyRegister,
            builder: (_, __) => const CompanyAuthScreen(initialIsLogin: false),
          ),

          // Footer pages (public)
          GoRoute(
            path: Routes.howItWorks,
            builder: (_, __) => const PlaceholderView(title: 'How It Works'),
          ),
          GoRoute(
            path: Routes.about,
            builder: (_, __) => const PlaceholderView(title: 'About'),
          ),
          GoRoute(
            path: Routes.contact,
            builder: (_, __) => const PlaceholderView(title: 'Contact'),
          ),
          GoRoute(
            path: Routes.privacy,
            builder: (_, __) => const PlaceholderView(title: 'Privacy Policy'),
          ),
          GoRoute(
            path: Routes.terms,
            builder: (_, __) => const PlaceholderView(title: 'Terms of Service'),
          ),
          GoRoute(
            path: Routes.pointsSystem,
            builder: (_, __) => const PlaceholderView(title: 'Points System'),
          ),

          // Student protected
          GoRoute(
            path: Routes.dashboard,
            builder: (_, __) => const PlaceholderView(title: 'Dashboard'),
          ),
          GoRoute(
            path: Routes.profile,
            builder: (_, __) => const PlaceholderView(title: 'Profile'),
          ),
          GoRoute(
            path: Routes.settings,
            builder: (_, __) => const PlaceholderView(title: 'Settings'),
          ),
          GoRoute(
            path: Routes.courses,
            builder: (_, __) => const PlaceholderView(title: 'Courses'),
          ),
          GoRoute(
            path: Routes.courseDetail,
            builder: (_, s) => PlaceholderView(
              title: 'Course Detail',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.jobs,
            builder: (_, __) => const PlaceholderView(title: 'Jobs'),
          ),
          GoRoute(
            path: Routes.jobDetail,
            builder: (_, s) => PlaceholderView(
              title: 'Job Detail',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.internships,
            builder: (_, __) => const PlaceholderView(title: 'Internships'),
          ),
          GoRoute(
            path: Routes.internshipDetail,
            builder: (_, s) => PlaceholderView(
              title: 'Internship Detail',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.applications,
            builder: (_, __) => const PlaceholderView(title: 'Applications'),
          ),
          GoRoute(
            path: Routes.favorites,
            builder: (_, __) => const PlaceholderView(title: 'Favorites'),
          ),
          GoRoute(
            path: Routes.notifications,
            builder: (_, __) => const PlaceholderView(title: 'Notifications'),
          ),
          GoRoute(
            path: Routes.leaderboard,
            builder: (_, __) => const PlaceholderView(title: 'Leaderboard'),
          ),
          GoRoute(
            path: Routes.debug,
            builder: (_, __) => const PlaceholderView(title: 'Database Debug'),
          ),

          // Company protected
          GoRoute(
            path: Routes.companyDashboard,
            builder: (_, __) => const PlaceholderView(title: 'Company Dashboard'),
          ),
          GoRoute(
            path: Routes.companyJobs,
            builder: (_, __) => const PlaceholderView(title: 'Company Jobs'),
          ),
          GoRoute(
            path: Routes.companyJobsCreate,
            builder: (_, __) => const PlaceholderView(title: 'Create Job'),
          ),
          GoRoute(
            path: Routes.companyJobsEdit,
            builder: (_, s) => PlaceholderView(
              title: 'Edit Job',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyJobApplications,
            builder: (_, s) => PlaceholderView(
              title: 'Job Applications',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyInternships,
            builder: (_, __) =>
                const PlaceholderView(title: 'Internship Management'),
          ),
          GoRoute(
            path: Routes.companyInternshipsCreate,
            builder: (_, __) => const PlaceholderView(title: 'Create Internship'),
          ),
          GoRoute(
            path: Routes.companyInternshipsEdit,
            builder: (_, s) => PlaceholderView(
              title: 'Edit Internship',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyInternshipApplications,
            builder: (_, s) => PlaceholderView(
              title: 'Internship Applications',
              subtitle: 'id=${s.pathParameters['id']}',
            ),
          ),
          GoRoute(
            path: Routes.companyProfile,
            builder: (_, __) => const PlaceholderView(title: 'Company Profile'),
          ),
          GoRoute(
            path: Routes.companyReports,
            builder: (_, __) => const PlaceholderView(title: 'Reports'),
          ),
          GoRoute(
            path: Routes.companyApplications,
            builder: (_, __) =>
                const PlaceholderView(title: 'Company Applications'),
          ),
          GoRoute(
            path: Routes.companyPricing,
            builder: (_, __) => const PlaceholderView(title: 'Pricing'),
          ),
        ],
      ),
    ],

    errorBuilder: (_, state) => PlaceholderScreen(
      title: '404',
      subtitle: state.error?.toString(),
      showAppBar: true,
    ),
  );
});

class GoRouterRefreshStream extends ChangeNotifier {
  GoRouterRefreshStream(Stream<dynamic> stream) {
    _sub = stream.listen((_) => notifyListeners());
  }

  late final StreamSubscription _sub;

  @override
  void dispose() {
    _sub.cancel();
    super.dispose();
  }
}

/// Main Shell (React-like Navbar + Footer)
class MainShell extends StatelessWidget {
  const MainShell({super.key, required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      // ✅ No AppBar (we reproduce React navbar)
      body: Column(
        children: [
          const AppNavbar(), // sticky-like top
          Expanded(child: child),
          const _Footer(),
        ],
      ),
    );
  }
}

/// Admin Shell (temporary)
class AdminShell extends StatelessWidget {
  const AdminShell({super.key, required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Admin')),
      body: child,
    );
  }
}

class _Footer extends StatelessWidget {
  const _Footer();

  @override
  Widget build(BuildContext context) {
    return SafeArea(
      top: false,
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Text(
          '© ${DateTime.now().year} Öğrenci Intelligence',
          style: Theme.of(context).textTheme.bodySmall,
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
// lib/src/core/deeplink/deep_link_service.dart

// lib/src/core/deeplink/deep_link_service.dart
import 'dart:async';

import 'package:app_links/app_links.dart';
import 'package:flutter/foundation.dart';
import 'package:go_router/go_router.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../config/env.dart';
import '../routing/routes.dart';

class DeepLinkService {
  DeepLinkService({SupabaseClient? client, GoRouter? router})
      : _client = client ?? Supabase.instance.client,
        _router = router;

  final SupabaseClient _client;
  final GoRouter? _router;

  final AppLinks _appLinks = AppLinks();
  StreamSubscription<Uri>? _sub;

  /// Start listening to deep links.
  /// app_links ^6.x: `uriLinkStream` emits the initial link + subsequent links.
  Future<void> start() async {
    if (_sub != null) return;

    _sub = _appLinks.uriLinkStream.listen(
      (uri) => unawaited(_handle(uri)),
      onError: (e) {
        if (kDebugMode) debugPrint('DeepLink stream error: $e');
      },
    );
  }

  /// Stop listening (matches how you call it from app.dart)
  Future<void> stop() async {
    await _sub?.cancel();
    _sub = null;
  }

  bool _shouldHandle(Uri uri) {
    if (uri.scheme != Env.deepLinkScheme) return false;
    return uri.host == 'login-callback' || uri.host == 'reset-password';
  }

  Future<void> _handle(Uri uri) async {
    if (!_shouldHandle(uri)) return;

    if (kDebugMode) debugPrint('DeepLink received: $uri');

    // 1) Let Supabase parse tokens & establish session (recovery/login callback)
    try {
      await _client.auth.getSessionFromUrl(uri);
    } catch (e) {
      if (kDebugMode) debugPrint('getSessionFromUrl error: $e');
    }

    // 2) Reproduce React behavior: open the correct screen
    // - reset-password deep link should land on /reset-password
    // - login-callback can land on / and redirects will take over
    if (_router != null) {
      await Future.microtask(() {
        if (uri.host == 'reset-password') {
          _router.go(Routes.resetPassword);
        } else if (uri.host == 'login-callback') {
          _router.go(Routes.home);
        }
      });
    }
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/email_verification_screen.dart

import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../controllers/auth_controller.dart';

class EmailVerificationScreen extends ConsumerStatefulWidget {
  const EmailVerificationScreen({super.key, this.emailHint});

  /// If user session is null (e.g., signUp returns no session),
  /// we still show the email and allow "resend" using this.
  final String? emailHint;

  @override
  ConsumerState<EmailVerificationScreen> createState() =>
      _EmailVerificationScreenState();
}

class _EmailVerificationScreenState extends ConsumerState<EmailVerificationScreen> {
  Timer? _timer;
  int _countdown = 0;

  bool _resending = false;
  bool _checking = false;

  @override
  void dispose() {
    _timer?.cancel();
    super.dispose();
  }

  void _startCountdown(int seconds) {
    _timer?.cancel();
    setState(() => _countdown = seconds);

    _timer = Timer.periodic(const Duration(seconds: 1), (t) {
      if (!mounted) return;
      if (_countdown <= 1) {
        t.cancel();
        setState(() => _countdown = 0);
      } else {
        setState(() => _countdown -= 1);
      }
    });
  }

  String? _emailToShow() {
    final auth = ref.watch(authViewStateProvider).value;
    return auth?.user?.email ?? widget.emailHint;
  }

  Future<void> _resend() async {
    final email = _emailToShow();
    if (email == null || email.trim().isEmpty) {
      _snack('Email not found. Please login again.', isError: true);
      return;
    }

    if (_countdown > 0 || _resending) return;

    setState(() => _resending = true);
    try {
      // Supabase resend signup verification email
      await SupabaseService.client.auth.resend(
        type: OtpType.signup,
        email: email.trim(),
      );

      _snack('Verification email sent again.');
      _startCountdown(60);
    } catch (e) {
      _snack('Failed to resend email: $e', isError: true);
    } finally {
      if (mounted) setState(() => _resending = false);
    }
  }

  Future<void> _check() async {
    final auth = ref.watch(authViewStateProvider).value;
    final user = auth?.user;

    // If no session/user, we cannot call getUser() reliably.
    if (user == null) {
      _snack('Please login again after verifying your email.', isError: true);
      return;
    }

    if (_checking) return;

    setState(() => _checking = true);
    try {
      final res = await SupabaseService.client.auth.getUser();
      final updated = res.user;

      if (updated?.emailConfirmedAt != null) {
        _snack('Email verified successfully!');
        if (!mounted) return;

        // React goes to /profile
        // Guards will redirect if company/admin.
        // ignore: use_build_context_synchronously
        Navigator.of(context).popUntil((route) => route.isFirst);
        // Better with GoRouter, but keep this screen self-contained.
        // Your router will handle redirect from home -> role dashboard.
      } else {
        _snack('Email not verified yet.', isError: true);
      }
    } catch (e) {
      _snack('Verification check failed: $e', isError: true);
    } finally {
      if (mounted) setState(() => _checking = false);
    }
  }

  void _snack(String msg, {bool isError = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: isError ? Colors.red : null,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final auth = ref.watch(authViewStateProvider).value;
    final email = _emailToShow() ?? '—';
    final hasUser = auth?.user != null;

    return Scaffold(
      appBar: AppBar(title: const Text('Email Verification')),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 520),
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Card(
              elevation: 2,
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    const SizedBox(height: 6),
                    Center(
                      child: Container(
                        width: 84,
                        height: 84,
                        decoration: BoxDecoration(
                          color: Theme.of(context).colorScheme.secondaryContainer,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.mail_outline,
                          size: 42,
                          color: Theme.of(context).colorScheme.onSecondaryContainer,
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      'Email verification pending',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.w700,
                          ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'To activate your account, please verify your email address.',
                      textAlign: TextAlign.center,
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    const SizedBox(height: 16),

                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Theme.of(context).colorScheme.primaryContainer,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Text(
                        'Verification link sent to: $email',
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                            ),
                      ),
                    ),

                    const SizedBox(height: 18),
                    _StepTile(
                      index: 1,
                      title: 'Check your inbox',
                      subtitle: 'The verification email should arrive in a few minutes.',
                    ),
                    _StepTile(
                      index: 2,
                      title: 'Click the verification link',
                      subtitle: 'Open the email and confirm your account.',
                    ),
                    _StepTile(
                      index: 3,
                      title: 'Return to the app',
                      subtitle: 'After verification, you can access all features.',
                    ),

                    const SizedBox(height: 16),

                    ElevatedButton.icon(
                      onPressed: (_checking || !hasUser) ? null : _check,
                      icon: _checking
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Icon(Icons.verified_outlined),
                      label: Text(_checking ? 'Checking...' : 'I verified my email'),
                    ),

                    const SizedBox(height: 10),

                    OutlinedButton.icon(
                      onPressed: (_resending || _countdown > 0) ? null : _resend,
                      icon: _resending
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Icon(Icons.refresh),
                      label: Text(
                        _resending
                            ? 'Sending...'
                            : _countdown > 0
                                ? 'Resend ($_countdown s)'
                                : 'Resend email',
                      ),
                    ),

                    const SizedBox(height: 14),

                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.amber.withOpacity(0.15),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: Colors.amber.withOpacity(0.35)),
                      ),
                      child: const Text(
                        'Didn’t receive the email? Check spam/junk, or try resending.',
                        style: TextStyle(fontSize: 13),
                      ),
                    ),

                    const SizedBox(height: 16),

                    TextButton(
                      onPressed: () {
                        // Use GoRouter if available
                        // ignore: use_build_context_synchronously
                        Navigator.of(context).pushNamed(Routes.login);
                      },
                      child: const Text('Login with a different account'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _StepTile extends StatelessWidget {
  const _StepTile({
    required this.index,
    required this.title,
    required this.subtitle,
  });

  final int index;
  final String title;
  final String subtitle;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(top: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.primaryContainer,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: Text(
                '$index',
                style: TextStyle(
                  fontWeight: FontWeight.w700,
                  color: Theme.of(context).colorScheme.onPrimaryContainer,
                ),
              ),
            ),
          ),
          const SizedBox(width: 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title,
                    style: Theme.of(context)
                        .textTheme
                        .titleSmall
                        ?.copyWith(fontWeight: FontWeight.w700)),
                const SizedBox(height: 2),
                Text(subtitle, style: Theme.of(context).textTheme.bodySmall),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/auth/presentation/screens/company_auth_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/supabase/supabase_service.dart';
import '../../../../core/routing/routes.dart';
import '../../data/auth_repository.dart';
import '../controllers/auth_controller.dart';

class CompanyAuthScreen extends ConsumerStatefulWidget {
  const CompanyAuthScreen({super.key, this.initialIsLogin = true});

  final bool initialIsLogin;

  @override
  ConsumerState<CompanyAuthScreen> createState() => _CompanyAuthScreenState();
}

class _CompanyAuthScreenState extends ConsumerState<CompanyAuthScreen> {
  static const _sectors = <String>[
    "Yazılım",
    "Finans",
    "Eğitim",
    "Sağlık",
    "Üretim",
    "Danışmanlık",
    "E-ticaret",
    "Turizm",
    "Diğer",
  ];

  static const _cities = <String>[
    "İstanbul",
    "Ankara",
    "İzmir",
    "Bursa",
    "Antalya",
    "Adana",
    "Konya",
    "Gaziantep",
    "Kayseri",
    "Diğer",
  ];

  late bool _isLogin;
  bool _showPassword = false;
  bool _loading = false;

  // Login
  final _loginEmail = TextEditingController();
  final _loginPassword = TextEditingController();

  // Register
  final _regCompanyName = TextEditingController();
  String? _regSector;
  String? _regCity;
  final _regTaxNumber = TextEditingController();
  final _regEmail = TextEditingController();
  final _regPassword = TextEditingController();
  final _regPhone = TextEditingController();
  final _regAddress = TextEditingController();

  String? _error;

  @override
  void initState() {
    super.initState();
    _isLogin = widget.initialIsLogin;
  }

  @override
  void dispose() {
    _loginEmail.dispose();
    _loginPassword.dispose();

    _regCompanyName.dispose();
    _regTaxNumber.dispose();
    _regEmail.dispose();
    _regPassword.dispose();
    _regPhone.dispose();
    _regAddress.dispose();
    super.dispose();
  }

  void _snack(String msg, {bool error = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: error ? Colors.red : null,
      ),
    );
  }

  Future<void> _handleLogin() async {
    final email = _loginEmail.text.trim();
    final pass = _loginPassword.text;

    if (email.isEmpty || pass.isEmpty) {
      _snack('Lütfen tüm alanları doldurun', error: true);
      return;
    }

    setState(() {
      _error = null;
      _loading = true;
    });

    try {
      // 1) Supabase sign-in (your repo already blocks unverified emails)
      final err = await ref
          .read(authActionLoadingProvider.notifier)
          .signIn(email, pass);

      if (err != null) {
        setState(() => _error = err);
        return;
      }

      // 2) Verify that this account is actually a company account
      final repo = ref.read(authRepositoryProvider);
      final user = repo.currentUser;

      if (user == null) {
        setState(() => _error = 'Giriş başarısız: kullanıcı bulunamadı');
        return;
      }

      final membership = await repo.fetchCompanyMembership(user.id);
      if (membership == null) {
        await repo.signOut();
        setState(() => _error = 'Bu hesap bir işletme hesabı değil');
        return;
      }

      _snack('Giriş başarılı!');
      if (!mounted) return;
      context.go(Routes.companyDashboard);
    } catch (e) {
      setState(() => _error = 'Bir hata oluştu: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  Future<void> _handleRegister() async {
    final companyName = _regCompanyName.text.trim();
    final sector = _regSector;
    final city = _regCity;
    final tax = _regTaxNumber.text.trim();
    final email = _regEmail.text.trim();
    final pass = _regPassword.text;
    final phone = _regPhone.text.trim();
    final address = _regAddress.text.trim();

    if (companyName.isEmpty ||
        sector == null ||
        city == null ||
        tax.isEmpty ||
        email.isEmpty ||
        pass.isEmpty ||
        phone.isEmpty) {
      _snack('Lütfen tüm zorunlu alanları doldurun', error: true);
      return;
    }

    if (pass.length < 6) {
      _snack('Şifre en az 6 karakter olmalıdır', error: true);
      return;
    }

    setState(() {
      _error = null;
      _loading = true;
    });

    try {
      final client = SupabaseService.client;

      // 1) Tax number uniqueness check
      final existing = await client
          .from('companies')
          .select('id')
          .eq('tax_number', tax)
          .maybeSingle();

      if (existing != null) {
        _snack('Bu vergi numarası ile kayıtlı bir şirket zaten var', error: true);
        return;
      }

      // 2) Create auth user (company user)
      //
      // React also sets user metadata user_type='company'.
      // This is optional for our Flutter logic (we rely on company_users table),
      // but we mirror it for parity.
      final signUpRes = await client.auth.signUp(
        email: email,
        password: pass,
        data: {
          'full_name': companyName,
          'user_type': 'company',
        },
      );

      final user = signUpRes.user;
      if (user == null) {
        _snack('Kullanıcı oluşturulamadı', error: true);
        return;
      }

      // 3) Create company row
      final nowIso = DateTime.now().toIso8601String();
      final createdCompany = await client
          .from('companies')
          .insert({
            'name': companyName,
            'sector': sector,
            'tax_number': tax,
            'phone': phone,
            'city': city,
            'address': address.isEmpty ? null : address,
            'verified': false,
            'created_at': nowIso,
            'updated_at': nowIso,
          })
          .select('id')
          .single();

      final companyId = createdCompany['id'] as String;

      // 4) Link user to company in company_users
      await client.from('company_users').insert({
        'company_id': companyId,
        'user_id': user.id,
        'role': 'owner',
        'permissions': ['all'],
        'created_at': nowIso,
      });

      _snack('Kayıt başarılı! Lütfen email adresinizi doğrulayın.');
      if (!mounted) return;

      // Mirror React: switch back to login.
      setState(() => _isLogin = true);

      // Optional: route to email verification page (recommended UX)
      context.go(Uri(path: Routes.emailVerification, queryParameters: {'email': email}).toString());
    } catch (e) {
      // Important note:
      // React attempted supabase.auth.admin.deleteUser(...) on failure.
      // That’s NOT safe/possible from a client without service_role.
      // So here we show the error and leave cleanup to backend/admin tools.
      setState(() => _error = 'Bir hata oluştu: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final auth = ref.watch(authViewStateProvider).value;
    final isAuthed = auth?.isAuthenticated ?? false;

    // If someone is already logged in, let router redirects handle it.
    // (Your app_router already pushes company->dashboard, student->dashboard)
    if (isAuthed) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    final w = MediaQuery.of(context).size.width;
    final showLeftPanel = w >= 980;

    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Color(0xFF0F172A), // slate-900
              Color(0xFF1E293B), // slate-800
              Color(0xFF1E3A8A), // blue-900
            ],
          ),
        ),
        child: Row(
          children: [
            if (showLeftPanel) Expanded(child: _LeftPanel()),
            Expanded(
              child: Center(
                child: ConstrainedBox(
                  constraints: const BoxConstraints(maxWidth: 520),
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(18),
                    child: _GlassCard(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.stretch,
                        children: [
                          const SizedBox(height: 8),
                          Center(
                            child: Container(
                              width: 84,
                              height: 84,
                              decoration: BoxDecoration(
                                borderRadius: BorderRadius.circular(20),
                                gradient: const LinearGradient(
                                  colors: [Color(0xFF3B82F6), Color(0xFF7C3AED)],
                                ),
                                boxShadow: const [
                                  BoxShadow(
                                    blurRadius: 20,
                                    offset: Offset(0, 8),
                                    color: Colors.black26,
                                  )
                                ],
                              ),
                              child: const Icon(Icons.business, color: Colors.white, size: 44),
                            ),
                          ),
                          const SizedBox(height: 14),
                          Text(
                            _isLogin ? 'İşletme Girişi' : 'İşletme Kaydı',
                            textAlign: TextAlign.center,
                            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                                  color: Colors.white,
                                  fontWeight: FontWeight.w800,
                                ),
                          ),
                          const SizedBox(height: 6),
                          Text(
                            _isLogin ? 'Hesabınıza giriş yapın' : 'Yeni işletme hesabı oluşturun',
                            textAlign: TextAlign.center,
                            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                                  color: Colors.white70,
                                ),
                          ),
                          const SizedBox(height: 18),

                          if (_isLogin) _buildLoginForm(context) else _buildRegisterForm(context),

                          const SizedBox(height: 14),

                          if (_error != null) ...[
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.red.withOpacity(0.12),
                                borderRadius: BorderRadius.circular(14),
                                border: Border.all(color: Colors.red.withOpacity(0.25)),
                              ),
                              child: Text(
                                _error!,
                                style: const TextStyle(color: Colors.redAccent),
                              ),
                            ),
                            const SizedBox(height: 14),
                          ],

                          _GradientButton(
                            text: _isLogin ? 'Giriş Yap' : 'Kayıt Ol',
                            loading: _loading,
                            onPressed: _loading ? null : () async {
                              if (_isLogin) {
                                await _handleLogin();
                              } else {
                                await _handleRegister();
                              }
                            },
                          ),

                          const SizedBox(height: 16),

                          Center(
                            child: Wrap(
                              alignment: WrapAlignment.center,
                              crossAxisAlignment: WrapCrossAlignment.center,
                              children: [
                                Text(
                                  _isLogin ? 'Hesabınız yok mu?' : 'Zaten hesabınız var mı?',
                                  style: const TextStyle(color: Colors.white70),
                                ),
                                TextButton(
                                  onPressed: _loading
                                      ? null
                                      : () => setState(() {
                                            _error = null;
                                            _isLogin = !_isLogin;
                                          }),
                                  child: Text(
                                    _isLogin ? 'Kayıt Ol' : 'Giriş Yap',
                                    style: const TextStyle(
                                      color: Color(0xFF60A5FA),
                                      fontWeight: FontWeight.w800,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 6),
                          Center(
                            child: TextButton(
                              onPressed: _loading ? null : () => context.go(Routes.login),
                              child: const Text(
                                'Öğrenci girişine dön',
                                style: TextStyle(color: Colors.white70),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLoginForm(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        _DarkField(
          label: 'E-posta Adresi',
          controller: _loginEmail,
          keyboardType: TextInputType.emailAddress,
          icon: Icons.mail_outline,
          hint: 'ornek@sirket.com',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Şifre',
          controller: _loginPassword,
          icon: Icons.lock_outline,
          hint: '••••••••',
          obscureText: !_showPassword,
          suffix: IconButton(
            onPressed: () => setState(() => _showPassword = !_showPassword),
            icon: Icon(
              _showPassword ? Icons.visibility_off : Icons.visibility,
              color: Colors.white70,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildRegisterForm(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        _DarkField(
          label: 'Şirket Adı *',
          controller: _regCompanyName,
          icon: Icons.apartment,
          hint: 'Şirket adınız',
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: _DarkDropdown(
                label: 'Sektör *',
                value: _regSector,
                items: _sectors,
                icon: Icons.work_outline,
                onChanged: (v) => setState(() => _regSector = v),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _DarkDropdown(
                label: 'Şehir *',
                value: _regCity,
                items: _cities,
                icon: Icons.location_on_outlined,
                onChanged: (v) => setState(() => _regCity = v),
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Vergi Numarası *',
          controller: _regTaxNumber,
          icon: Icons.receipt_long_outlined,
          hint: 'Vergi numaranız',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'E-posta Adresi *',
          controller: _regEmail,
          keyboardType: TextInputType.emailAddress,
          icon: Icons.mail_outline,
          hint: 'ornek@sirket.com',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Şifre *',
          controller: _regPassword,
          icon: Icons.lock_outline,
          hint: 'En az 6 karakter',
          obscureText: !_showPassword,
          suffix: IconButton(
            onPressed: () => setState(() => _showPassword = !_showPassword),
            icon: Icon(
              _showPassword ? Icons.visibility_off : Icons.visibility,
              color: Colors.white70,
            ),
          ),
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Telefon *',
          controller: _regPhone,
          keyboardType: TextInputType.phone,
          icon: Icons.phone_outlined,
          hint: '0532 XXX XX XX',
        ),
        const SizedBox(height: 12),
        _DarkField(
          label: 'Adres',
          controller: _regAddress,
          icon: Icons.home_outlined,
          hint: 'Şirket adresi (opsiyonel)',
          maxLines: 2,
        ),
      ],
    );
  }
}

class _LeftPanel extends StatelessWidget {
  const _LeftPanel();

  @override
  Widget build(BuildContext context) {
    final features = const [
      (Icons.work_outline, 'İlan Yönetimi', 'İş ve staj ilanlarınızı kolayca yönetin'),
      (Icons.people_outline, 'Başvuru Takibi', 'Tüm başvuruları tek panelden inceleyin'),
      (Icons.trending_up, 'Detaylı Analizler', 'İlan performanslarını takip edin'),
      (Icons.emoji_events_outlined, 'Yetenekleri Keşfedin', 'En uygun adayları bulun'),
    ];

    return Stack(
      children: [
        Positioned.fill(
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Colors.blue.withOpacity(0.20),
                  Colors.purple.withOpacity(0.18),
                ],
              ),
            ),
          ),
        ),
        Padding(
          padding: const EdgeInsets.all(28),
          child: Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 520),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Icon(Icons.business, size: 68, color: Color(0xFF60A5FA)),
                  const SizedBox(height: 14),
                  const Text(
                    'İşletme Yönetim Paneli',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 34,
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  const SizedBox(height: 10),
                  const Text(
                    'Geleceğin yetenekleriyle buluşun',
                    style: TextStyle(color: Colors.white70, fontSize: 18),
                  ),
                  const SizedBox(height: 22),
                  ...features.map((f) {
                    final icon = f.$1;
                    final title = f.$2;
                    final desc = f.$3;

                    return Container(
                      margin: const EdgeInsets.only(bottom: 14),
                      padding: const EdgeInsets.all(14),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.10),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.white.withOpacity(0.18)),
                      ),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Container(
                            padding: const EdgeInsets.all(10),
                            decoration: BoxDecoration(
                              gradient: const LinearGradient(
                                colors: [Color(0xFF3B82F6), Color(0xFF7C3AED)],
                              ),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Icon(icon, color: Colors.white, size: 22),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  title,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.w800,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(desc, style: const TextStyle(color: Colors.white70)),
                              ],
                            ),
                          ),
                        ],
                      ),
                    );
                  }),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class _GlassCard extends StatelessWidget {
  const _GlassCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(18),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.10),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: Colors.white.withOpacity(0.18)),
        boxShadow: const [
          BoxShadow(blurRadius: 28, offset: Offset(0, 14), color: Colors.black38),
        ],
      ),
      child: child,
    );
  }
}

class _DarkField extends StatelessWidget {
  const _DarkField({
    required this.label,
    required this.controller,
    required this.icon,
    this.hint,
    this.keyboardType,
    this.obscureText = false,
    this.suffix,
    this.maxLines = 1,
  });

  final String label;
  final TextEditingController controller;
  final IconData icon;
  final String? hint;
  final TextInputType? keyboardType;
  final bool obscureText;
  final Widget? suffix;
  final int maxLines;

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: controller,
      keyboardType: keyboardType,
      obscureText: obscureText,
      maxLines: maxLines,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.white70),
        hintText: hint,
        hintStyle: const TextStyle(color: Colors.white38),
        prefixIcon: Icon(icon, color: Colors.white70),
        suffixIcon: suffix,
        filled: true,
        fillColor: Colors.white.withOpacity(0.10),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.18)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 2),
        ),
      ),
    );
  }
}

class _DarkDropdown extends StatelessWidget {
  const _DarkDropdown({
    required this.label,
    required this.value,
    required this.items,
    required this.icon,
    required this.onChanged,
  });

  final String label;
  final String? value;
  final List<String> items;
  final IconData icon;
  final ValueChanged<String?> onChanged;

  @override
  Widget build(BuildContext context) {
    return DropdownButtonFormField<String>(
      value: value,
      dropdownColor: const Color(0xFF111827),
      style: const TextStyle(color: Colors.white),
      items: items
          .map((v) => DropdownMenuItem<String>(
                value: v,
                child: Text(v, style: const TextStyle(color: Colors.white)),
              ))
          .toList(),
      onChanged: onChanged,
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.white70),
        prefixIcon: Icon(icon, color: Colors.white70),
        filled: true,
        fillColor: Colors.white.withOpacity(0.10),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.18)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 2),
        ),
      ),
    );
  }
}

class _GradientButton extends StatelessWidget {
  const _GradientButton({
    required this.text,
    required this.loading,
    required this.onPressed,
  });

  final String text;
  final bool loading;
  final VoidCallback? onPressed;

  @override
  Widget build(BuildContext context) {
    return DecoratedBox(
      decoration: BoxDecoration(
        gradient: const LinearGradient(colors: [Color(0xFF2563EB), Color(0xFF7C3AED)]),
        borderRadius: BorderRadius.circular(14),
        boxShadow: const [
          BoxShadow(blurRadius: 22, offset: Offset(0, 10), color: Colors.black26),
        ],
      ),
      child: ElevatedButton(
        style: ElevatedButton.styleFrom(
          backgroundColor: Colors.transparent,
          shadowColor: Colors.transparent,
          padding: const EdgeInsets.symmetric(vertical: 14),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
        ),
        onPressed: onPressed,
        child: loading
            ? const SizedBox(
                width: 22,
                height: 22,
                child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
              )
            : Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(text, style: const TextStyle(fontWeight: FontWeight.w800)),
                  const SizedBox(width: 10),
                  const Icon(Icons.arrow_forward, size: 18),
                ],
              ),
      ),
    );
  }
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\test\widget_test.dart


import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'package:ogrenci_intelligence/src/app/app.dart';

void main() {
  testWidgets('App boots (smoke test)', (WidgetTester tester) async {
    // Build the real app root
    await tester.pumpWidget(const ProviderScope(child: App()));

    // Let first frames build
    await tester.pump();

    // If we reach here without exceptions, boot is OK.
    expect(find.byType(App), findsOneWidget);
  });
}

✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\app\bootstrap.dart

import '../core/config/env.dart';
import '../core/supabase/supabase_service.dart';

Future<void> bootstrap() async {
  await Env.load();

  await SupabaseService.initialize(
    supabaseUrl: Env.supabaseUrl,
    supabaseAnonKey: Env.supabaseAnonKey,
  );
}
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
D:\Dev\ogrenci_intelligence\lib\src\features\home\presentation\screens\home_screen.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../../../core/supabase/supabase_service.dart';
import '../../../auth/presentation/controllers/auth_controller.dart';
import '../widgets/how_it_works_section.dart';

class HomeScreen extends ConsumerWidget {
  const HomeScreen({super.key});

  // Tailwind-like palette (close to your React UI)
  static const _bgTop = Color(0xFFFFFFFF);
  static const _bgBottom = Color(0xFFFAF5FF); // purple-50
  static const _purple700 = Color(0xFF7E22CE);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsync = ref.watch(authViewStateProvider);

    final isLoading = authAsync.isLoading;
    final auth = authAsync.value;
    final isLoggedIn = (!isLoading) && (auth?.isAuthenticated ?? false);

    return DecoratedBox(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [_bgTop, _bgBottom],
        ),
      ),
      child: SafeArea(
        bottom: false,
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 24),
          child: Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 1080),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  _Hero(
                    isLoggedIn: isLoggedIn,
                    isLoading: isLoading,
                    onRegister: () => context.go(Routes.register),
                    onLogin: () => context.go(Routes.login),
                    onProfile: () => context.go(Routes.profile),
                    onLogout: () async {
                      await SupabaseService.client.auth.signOut();
                      if (context.mounted) context.go(Routes.home);
                    },
                  ),

                  const SizedBox(height: 36),

                  _SectionGrid(
                    title: null,
                    cards: const [
                      _InfoCard(
                        icon: Icons.school_outlined,
                        iconColor: _purple700,
                        title: 'Alanına Özel İçerikler',
                        description:
                            'Bölümüne uygun kurslar, stajlar ve iş ilanlarıyla odaklanmış öğrenme.',
                      ),
                      _InfoCard(
                        icon: Icons.work_outline,
                        iconColor: _purple700,
                        title: 'Kariyerine Yön Ver',
                        description:
                            'Kişiselleştirilmiş kariyer rehberliği ve fırsatlarla desteklen.',
                      ),
                      _InfoCard(
                        icon: Icons.assignment_outlined,
                        iconColor: _purple700,
                        title: 'Kolay ve Hızlı Kullanım',
                        description:
                            'Modern tasarım ve kullanıcı dostu arayüz ile zamandan tasarruf et.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  _SectionGrid(
                    title: 'Öğrenciler İçin Faydalar',
                    cards: const [
                      _InfoCard(
                        icon: Icons.track_changes_outlined,
                        iconColor: _purple700,
                        title: 'Hedef Odaklı İçerik',
                        description:
                            'Alanına uygun fırsatlarla zaman kaybetmeden hedefe ulaş.',
                      ),
                      _InfoCard(
                        icon: Icons.star_outline,
                        iconColor: _purple700,
                        title: 'Rekabet Avantajı',
                        description:
                            'Özgeçmişini güçlendirecek fırsatlara herkesten önce ulaş.',
                      ),
                      _InfoCard(
                        icon: Icons.bar_chart_outlined,
                        iconColor: _purple700,
                        title: 'Gelişim Takibi',
                        description:
                            'İlerleyişini takip et, eksiklerini zamanında fark et.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  _SectionGrid(
                    title: 'İşletmeler İçin Faydalar',
                    cards: const [
                      _InfoCard(
                        icon: Icons.people_outline,
                        iconColor: _purple700,
                        title: 'Genç Yeteneklere Erişim',
                        description:
                            'Motivasyonu yüksek, alanına ilgili öğrencilere ulaşın.',
                      ),
                      _InfoCard(
                        icon: Icons.handshake_outlined,
                        iconColor: _purple700,
                        title: 'İşbirliği Olanakları',
                        description:
                            'Projelerinizde üniversite öğrencileriyle birlikte çalışın.',
                      ),
                      _InfoCard(
                        icon: Icons.query_stats_outlined,
                        iconColor: _purple700,
                        title: 'Veriye Dayalı Seçim',
                        description:
                            'Profil verileriyle doğru kişiyi kolayca belirleyin.',
                      ),
                    ],
                  ),

                  const SizedBox(height: 56),

                  // ✅ Keep it here, from widgets/how_it_works_section.dart
                  const HowItWorksSection(),

                  const SizedBox(height: 24),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _Hero extends StatelessWidget {
  const _Hero({
    required this.isLoggedIn,
    required this.isLoading,
    required this.onRegister,
    required this.onLogin,
    required this.onProfile,
    required this.onLogout,
  });

  final bool isLoggedIn;
  final bool isLoading;
  final VoidCallback onRegister;
  final VoidCallback onLogin;
  final VoidCallback onProfile;
  final Future<void> Function() onLogout;

  static const _purple700 = Color(0xFF7E22CE);
  static const _indigo700 = Color(0xFF4338CA);
  static const _blue800 = Color(0xFF1E40AF);
  static const _yellow400 = Color(0xFFFACC15);
  static const _green400 = Color(0xFF4ADE80);
  static const _red400 = Color(0xFFF87171);

  @override
  Widget build(BuildContext context) {
    final titleStyle = Theme.of(context).textTheme.headlineMedium?.copyWith(
          color: Colors.white,
          fontWeight: FontWeight.w800,
          height: 1.15,
        );

    final subtitleStyle = Theme.of(context).textTheme.titleMedium?.copyWith(
          color: const Color(0xFFC7D2FE), // indigo-200 vibe
          height: 1.5,
        );

    return TweenAnimationBuilder<double>(
      duration: const Duration(milliseconds: 900),
      tween: Tween(begin: 0, end: 1),
      builder: (context, t, child) => Opacity(
        opacity: t,
        child: Transform.translate(offset: Offset(0, (1 - t) * 40), child: child),
      ),
      child: Container(
        padding: const EdgeInsets.all(18),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [_purple700, _indigo700, _blue800],
          ),
          borderRadius: BorderRadius.circular(28),
          boxShadow: const [
            BoxShadow(
              blurRadius: 20,
              spreadRadius: 2,
              offset: Offset(0, 10),
              color: Color(0x26000000),
            )
          ],
        ),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 26),
          child: Column(
            children: [
              Text(
                'Üniversite Hayatını Güçlendir,\nKariyerine Hızla Yön Ver!',
                textAlign: TextAlign.center,
                style: titleStyle,
              ),
              const SizedBox(height: 14),
              ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 720),
                child: Text(
                  'Alanına özel kurslar, stajlar ve iş ilanları ile geleceğine sağlam adımlarla ilerle.',
                  textAlign: TextAlign.center,
                  style: subtitleStyle,
                ),
              ),
              const SizedBox(height: 22),
              if (isLoading)
                const Padding(
                  padding: EdgeInsets.all(8),
                  child: CircularProgressIndicator(color: Colors.white),
                )
              else
                Wrap(
                  spacing: 14,
                  runSpacing: 12,
                  alignment: WrapAlignment.center,
                  children: [
                    if (!isLoggedIn) ...[
                      _FilledCta(
                        label: 'Kayıt Ol',
                        color: _yellow400,
                        textColor: Color(0xFF111827),
                        onTap: onRegister,
                      ),
                      _FilledCta(
                        label: 'Giriş Yap',
                        color: _yellow400,
                        textColor: Color(0xFF111827),
                        onTap: onLogin,
                      ),
                    ] else ...[
                      _FilledCta(
                        label: 'Profil',
                        color: _green400,
                        textColor: Color(0xFF111827),
                        icon: Icons.person_outline,
                        onTap: onProfile,
                      ),
                      _FilledCta(
                        label: 'Çıkış Yap',
                        color: _red400,
                        textColor: Colors.white,
                        icon: Icons.logout_outlined,
                        onTapAsync: onLogout,
                      ),
                    ]
                  ],
                ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FilledCta extends StatefulWidget {
  const _FilledCta({
    required this.label,
    required this.color,
    required this.textColor,
    this.icon,
    this.onTap,
    this.onTapAsync,
  });

  final String label;
  final Color color;
  final Color textColor;
  final IconData? icon;
  final VoidCallback? onTap;
  final Future<void> Function()? onTapAsync;

  @override
  State<_FilledCta> createState() => _FilledCtaState();
}

class _FilledCtaState extends State<_FilledCta> {
  bool _busy = false;

  @override
  Widget build(BuildContext context) {
    final onPressed = (widget.onTapAsync != null)
        ? () async {
            if (_busy) return;
            setState(() => _busy = true);
            try {
              await widget.onTapAsync!.call();
            } finally {
              if (mounted) setState(() => _busy = false);
            }
          }
        : widget.onTap;

    return ElevatedButton(
      onPressed: onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: widget.color,
        foregroundColor: widget.textColor,
        elevation: 10,
        padding: const EdgeInsets.symmetric(horizontal: 22, vertical: 16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (widget.icon != null) ...[
            Icon(widget.icon, size: 18),
            const SizedBox(width: 8),
          ],
          Text(
            _busy ? '...' : widget.label,
            style: const TextStyle(fontWeight: FontWeight.w800),
          ),
        ],
      ),
    );
  }
}

class _SectionGrid extends StatelessWidget {
  const _SectionGrid({
    required this.title,
    required this.cards,
  });

  final String? title;
  final List<_InfoCard> cards;

  @override
  Widget build(BuildContext context) {
    final headerStyle = Theme.of(context).textTheme.headlineSmall?.copyWith(
          fontWeight: FontWeight.w800,
          color: const Color(0xFF3B0764), // deep purple
        );

    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        if (title != null) ...[
          Text(title!, textAlign: TextAlign.center, style: headerStyle),
          const SizedBox(height: 18),
        ],
        LayoutBuilder(
          builder: (context, c) {
            final w = c.maxWidth;
            final gap = 18.0;
            final minItem = 280.0;

            final count = (w / (minItem + gap)).floor().clamp(1, 3);
            final itemW = (w - gap * (count - 1)) / count;

            return Wrap(
              spacing: gap,
              runSpacing: gap,
              children: [
                for (final card in cards) SizedBox(width: itemW, child: card),
              ],
            );
          },
        ),
      ],
    );
  }
}

class _InfoCard extends StatelessWidget {
  const _InfoCard({
    required this.icon,
    required this.iconColor,
    required this.title,
    required this.description,
  });

  final IconData icon;
  final Color iconColor;
  final String title;
  final String description;

  @override
  Widget build(BuildContext context) {
    final titleStyle = Theme.of(context).textTheme.titleLarge?.copyWith(
          fontWeight: FontWeight.w700,
          color: const Color(0xFF5B21B6),
        );

    final descStyle = Theme.of(context).textTheme.bodyMedium?.copyWith(
          color: const Color(0xFF4B5563),
          height: 1.45,
        );

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(26),
        boxShadow: const [
          BoxShadow(
            blurRadius: 14,
            offset: Offset(0, 8),
            color: Color(0x1A000000),
          )
        ],
      ),
      child: Column(
        children: [
          Icon(icon, size: 46, color: iconColor),
          const SizedBox(height: 12),
          Text(title, textAlign: TextAlign.center, style: titleStyle),
          const SizedBox(height: 10),
          Text(description, textAlign: TextAlign.center, style: descStyle),
        ],
      ),
    );
  }
}


✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib/src/features/home/presentation/widgets/how_it_works_section.dart


import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../../core/routing/routes.dart';
import '../../../auth/presentation/controllers/auth_controller.dart';

class HowItWorksSection extends ConsumerWidget {
  const HowItWorksSection({super.key});

  static const _bg = Color(0xFFF9FAFB); // gray-50

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsync = ref.watch(authViewStateProvider);
    final isLoading = authAsync.isLoading;
    final isLoggedIn = (!isLoading) && (authAsync.value?.isAuthenticated ?? false);

    final w = MediaQuery.of(context).size.width;

    // Breakpoints proches du React: md=2 cols, lg=4 cols
    final columns = w >= 1024 ? 4 : (w >= 768 ? 2 : 1);
    final showArrows = columns >= 4;

    const steps = <_HowStep>[
      _HowStep(
        index: 1,
        title: 'Eğitim Modülü',
        description:
            'Alanına özel temel bilgiler, video anlatımlar ve mini sınavlarla kariyer yolculuğuna güçlü bir başlangıç yap.',
        icon: Icons.menu_book_outlined,
        iconColor: Color(0xFF4F46E5), // indigo-600
        bgColor: Color(0xFFEFF6FF), // indigo-50 vibe
        borderColor: Color(0xFFC7D2FE), // indigo-200
      ),
      _HowStep(
        index: 2,
        title: 'Saha Uygulaması',
        description:
            'Teorik bilgilerini pratikte uygulayarak gerçek iş ortamında deneyim kazan. Mentör desteği ile gelişimini pekiştir.',
        icon: Icons.business_center_outlined,
        iconColor: Color(0xFF7C3AED), // purple-600
        bgColor: Color(0xFFF3E8FF), // purple-50
        borderColor: Color(0xFFD8B4FE), // purple-200
      ),
      _HowStep(
        index: 3,
        title: 'Network Oluştur',
        description:
            'Sektör profesyonelleri ve diğer öğrencilerle tanış, kariyer ağını genişlet ve yeni fırsatlar keşfet.',
        icon: Icons.groups_outlined,
        iconColor: Color(0xFF16A34A), // green-600
        bgColor: Color(0xFFECFDF5), // green-50
        borderColor: Color(0xFFBBF7D0), // green-200
      ),
      _HowStep(
        index: 4,
        title: 'Başarıyı Yakala',
        description:
            'Sertifikalarını al, referanslarını topla ve hayalindeki kariyere doğru emin adımlarla ilerle.',
        icon: Icons.emoji_events_outlined,
        iconColor: Color(0xFFCA8A04), // yellow-600
        bgColor: Color(0xFFFFFBEB), // yellow-50
        borderColor: Color(0xFFFDE68A), // yellow-200
      ),
    ];

    return Container(
      width: double.infinity,
      color: _bg,
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 56),
      child: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 1080),
          child: Column(
            children: [
              // Title
              Text(
                'Nasıl Çalışır?',
                textAlign: TextAlign.center,
                style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                      fontWeight: FontWeight.w800,
                      color: const Color(0xFF1F2937),
                    ),
              ),
              const SizedBox(height: 12),
              ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 720),
                child: Text(
                  'Platformumuz dört temel aşamadan oluşur. Her adımda yanındayız!',
                  textAlign: TextAlign.center,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        color: const Color(0xFF6B7280),
                        height: 1.5,
                      ),
                ),
              ),
              const SizedBox(height: 28),

              // Grid
              LayoutBuilder(
                builder: (context, c) {
                  final gap = 16.0;
                  final totalW = c.maxWidth;
                  final itemW = (columns == 1)
                      ? totalW
                      : (totalW - gap * (columns - 1)) / columns;

                  return Wrap(
                    spacing: gap,
                    runSpacing: gap,
                    children: [
                      for (var i = 0; i < steps.length; i++)
                        SizedBox(
                          width: itemW,
                          child: _HowStepCard(
                            step: steps[i],
                            showArrow: showArrows && i < steps.length - 1,
                          ),
                        ),
                    ],
                  );
                },
              ),

              const SizedBox(height: 34),

              // CTA
              _CtaButton(
                label: isLoggedIn ? "Dashboard'a Git" : "Hemen Başla",
                onTap: () => context.go(
                  isLoggedIn ? Routes.dashboard : Routes.register,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _HowStep {
  const _HowStep({
    required this.index,
    required this.title,
    required this.description,
    required this.icon,
    required this.iconColor,
    required this.bgColor,
    required this.borderColor,
  });

  final int index;
  final String title;
  final String description;
  final IconData icon;
  final Color iconColor;
  final Color bgColor;
  final Color borderColor;
}

class _HowStepCard extends StatefulWidget {
  const _HowStepCard({required this.step, required this.showArrow});

  final _HowStep step;
  final bool showArrow;

  @override
  State<_HowStepCard> createState() => _HowStepCardState();
}

class _HowStepCardState extends State<_HowStepCard> {
  bool _hover = false;

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) {
        if (!_hover) setState(() => _hover = true);
      },
      onExit: (_) {
        if (_hover) setState(() => _hover = false);
      },
      child: Stack(
        clipBehavior: Clip.none,
        children: [
          AnimatedContainer(
            duration: const Duration(milliseconds: 180),
            transform: Matrix4.identity()..translate(0.0, _hover ? -4.0 : 0.0),
            padding: const EdgeInsets.all(18),
            decoration: BoxDecoration(
              color: widget.step.bgColor,
              borderRadius: BorderRadius.circular(18),
              border: Border.all(color: widget.step.borderColor, width: 2),
              boxShadow: _hover
                  ? const [
                      BoxShadow(
                        blurRadius: 18,
                        offset: Offset(0, 10),
                        color: Color(0x1A000000),
                      )
                    ]
                  : const [],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Icon(widget.step.icon, size: 40, color: widget.step.iconColor),
                const SizedBox(height: 12),
                Text(
                  widget.step.title,
                  style: Theme.of(context).textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: const Color(0xFF1F2937),
                      ),
                ),
                const SizedBox(height: 10),
                Text(
                  widget.step.description,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        color: const Color(0xFF4B5563),
                        height: 1.45,
                      ),
                ),
              ],
            ),
          ),

          // Step number (top-right)
          Positioned(
            top: -10,
            right: -10,
            child: Container(
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: const Color(0xFF111827),
                borderRadius: BorderRadius.circular(999),
              ),
              alignment: Alignment.center,
              child: Text(
                '${widget.step.index}',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w800,
                  fontSize: 12,
                ),
              ),
            ),
          ),

          // Arrow (only large screens / not last)
          if (widget.showArrow)
            const Positioned(
              right: -14,
              top: 0,
              bottom: 0,
              child: Center(
                child: Icon(
                  Icons.arrow_forward,
                  size: 22,
                  color: Color(0xFF9CA3AF),
                ),
              ),
            ),
        ],
      ),
    );
  }
}

class _CtaButton extends StatefulWidget {
  const _CtaButton({required this.label, required this.onTap});

  final String label;
  final VoidCallback onTap;

  @override
  State<_CtaButton> createState() => _CtaButtonState();
}

class _CtaButtonState extends State<_CtaButton> {
  bool _hover = false;
  static const _purple = Color(0xFF7C3AED);
  static const _purpleHover = Color(0xFF6D28D9);

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) {
        if (!_hover) setState(() => _hover = true);
      },
      onExit: (_) {
        if (_hover) setState(() => _hover = false);
      },
      child: AnimatedScale(
        duration: const Duration(milliseconds: 160),
        scale: _hover ? 1.05 : 1.0,
        child: ElevatedButton(
          onPressed: widget.onTap,
          style: ElevatedButton.styleFrom(
            backgroundColor: _hover ? _purpleHover : _purple,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 14),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            elevation: 10,
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(widget.label, style: const TextStyle(fontWeight: FontWeight.w800)),
              const SizedBox(width: 10),
              const Icon(Icons.arrow_forward, size: 18),
            ],
          ),
        ),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
lib\src\shared\widgets\app_navbar.dart


// lib/src/shared/widgets/app_navbar.dart
import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../core/routing/routes.dart';
import '../../core/supabase/supabase_service.dart';
import '../../features/auth/domain/auth_models.dart';
import '../../features/auth/presentation/controllers/auth_controller.dart';

class AppNavbar extends ConsumerStatefulWidget {
  const AppNavbar({super.key});

  @override
  ConsumerState<AppNavbar> createState() => _AppNavbarState();
}

class _AppNavbarState extends ConsumerState<AppNavbar> {
  bool _mobileOpen = false;

  // Points cache (student only)
  Future<int>? _pointsFuture;
  String? _pointsUserId;

  // ✅ Type-safe metadata read
  String? _metaString(Map<String, dynamic>? meta, String key) {
    final v = meta?[key];
    if (v is String) {
      final s = v.trim();
      return s.isEmpty ? null : s;
    }
    return null;
  }

  String _displayNameFromUser(User? user) {
    if (user == null) return 'Kullanıcı';

    final fullName = _metaString(user.userMetadata, 'full_name');
    if (fullName != null) return fullName;

    final email = user.email;
    if (email != null && email.contains('@')) return email.split('@').first;

    return 'Kullanıcı';
  }

  Future<void> _logout(BuildContext context) async {
    final err = await ref.read(authActionLoadingProvider.notifier).signOut();
    _closeMobile();

    if (!mounted) return;

    if (err != null && err.isNotEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Çıkış yapılamadı: $err')),
      );
      return;
    }
    context.go(Routes.home);
  }

  @override
  Widget build(BuildContext context) {
    final authAsync = ref.watch(authViewStateProvider);
    final isLoading = authAsync.isLoading;
    final auth = authAsync.value;

    final isLoggedIn = (!isLoading) && (auth?.isAuthenticated ?? false);

    // ✅ IMPORTANT: default should be guest (not student)
    final userType = auth?.userType ?? UserType.guest;

    // ✅ Real Supabase User (from AuthViewState)
    final user = auth?.user;

    // ✅ Safe display name
    final userName = _displayNameFromUser(user);

    final isCompany = isLoggedIn && userType == UserType.company;
    final isStudent = isLoggedIn && userType == UserType.student;

    // React-like menu sets
    final studentMenu = const <_NavItem>[
      _NavItem('Anasayfa', Routes.home),
      _NavItem('Kurslar', Routes.courses),
      _NavItem('İş İlanları', Routes.jobs),
      _NavItem('Stajlar', Routes.internships),
    ];

    final companyMenu = const <_NavItem>[
      _NavItem('İlanlarım', Routes.companyJobs),
      _NavItem('Staj Yönetimi', Routes.companyInternships),
      _NavItem('Başvurular', Routes.companyApplications),
      _NavItem('Raporlar', Routes.companyReports),
    ];

    final menuItems = isCompany ? companyMenu : studentMenu;

    final studentDropdown = const <_NavItem>[
      _NavItem('Profilim', Routes.profile),
      _NavItem('Dashboard', Routes.dashboard),
      _NavItem('Başvurularım', Routes.applications),
      _NavItem('Favorilerim', Routes.favorites),
      _NavItem('Bildirimler', Routes.notifications),
      _NavItem('Ayarlar', Routes.settings),
    ];

    final companyDropdown = const <_NavItem>[
      _NavItem('Şirket Profili', Routes.companyProfile),
      _NavItem('Dashboard', Routes.companyDashboard),
      _NavItem('Paketler ve Fiyatlar', Routes.companyPricing),
    ];

    final dropdownItems = isCompany ? companyDropdown : studentDropdown;

    // Desktop breakpoint similar to React md+
    final w = MediaQuery.of(context).size.width;
    final isDesktop = w >= 768;

    // Student points chip: prepare/cached future
    if (isStudent) {
      final uid = user?.id;
      if (uid != null && uid.isNotEmpty && uid != _pointsUserId) {
        _pointsUserId = uid;
        _pointsFuture = _fetchUserTotalPoints(uid);
      }
    } else {
      _pointsUserId = null;
      _pointsFuture = null;
    }

    return Material(
      elevation: 0,
      color: Colors.white,
      child: Container(
        decoration: const BoxDecoration(
          border: Border(bottom: BorderSide(color: Color(0xFFE5E7EB))),
          boxShadow: [
            BoxShadow(
              blurRadius: 10,
              offset: Offset(0, 2),
              color: Color(0x14000000),
            )
          ],
        ),
        child: Column(
          children: [
            // Top bar
            SafeArea(
              bottom: false,
              child: Center(
                child: ConstrainedBox(
                  constraints: const BoxConstraints(maxWidth: 1080),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                    child: Row(
                      children: [
                        // Logo + Title (React: logo changes for company)
                        InkWell(
                          onTap: () {
                            _closeMobile();
                            if (isCompany) {
                              context.go(Routes.companyDashboard);
                            } else {
                              context.go(Routes.home);
                            }
                          },
                          child: Row(
                            children: [
                              if (isCompany) ...[
                                const Icon(Icons.apartment, size: 34, color: Color(0xFF6D28D9)),
                                const SizedBox(width: 10),
                                if (isDesktop)
                                  const Text(
                                    'İşletme Paneli',
                                    style: TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.w800,
                                      color: Color(0xFF6D28D9),
                                    ),
                                  ),
                              ] else ...[
                                Image.asset(
                                  'assets/logo.png',
                                  height: 40,
                                  fit: BoxFit.contain,
                                  errorBuilder: (_, __, ___) => const Icon(
                                    Icons.school,
                                    size: 34,
                                    color: Color(0xFF6D28D9),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                if (isDesktop)
                                  const Text(
                                    'Öğrenci İntelligence',
                                    style: TextStyle(
                                      fontSize: 20,
                                      fontWeight: FontWeight.w800,
                                      color: Color(0xFF6D28D9),
                                    ),
                                  ),
                              ]
                            ],
                          ),
                        ),

                        const Spacer(),

                        // Desktop menu
                        if (isDesktop) ...[
                          Row(
                            children: [
                              for (final item in menuItems)
                                Padding(
                                  padding: const EdgeInsets.symmetric(horizontal: 8),
                                  child: _NavTextLink(
                                    label: item.label,
                                    onTap: () {
                                      _closeMobile();
                                      context.go(item.path);
                                    },
                                  ),
                                ),
                            ],
                          ),

                          const Spacer(),

                          // Right actions (React-like)
                          if (!isLoggedIn) ...[
                            _PrimaryPill(
                              label: 'İşletme Girişi',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.companyAuth);
                              },
                            ),
                            const SizedBox(width: 10),
                          ],

                          if (isLoading)
                            const SizedBox(width: 90, height: 36, child: _SkeletonPill())
                          else if (isLoggedIn) ...[
                            if (isStudent) ...[
                              _PointsChip(
                                future: _pointsFuture,
                                onTap: () {
                                  _closeMobile();
                                  context.go(Routes.pointsSystem);
                                },
                              ),
                              const SizedBox(width: 12),
                            ],

                            if (isCompany) ...[
                              _PrimaryPill(
                                label: 'Yeni İlan',
                                rounded: 14,
                                onTap: () {
                                  _closeMobile();
                                  context.go(Routes.companyJobsCreate);
                                },
                              ),
                              const SizedBox(width: 12),
                            ],

                            _ProfileDropdown(
                              userName: userName,
                              isCompany: isCompany,
                              items: dropdownItems,
                              onItemTap: (path) {
                                _closeMobile();
                                context.go(path);
                              },
                              // ✅ Use controller signOut (type-safe flow)
                              onLogout: () => _logout(context),
                            ),
                          ] else ...[
                            _PrimaryPill(
                              label: 'Öğrenci Girişi',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.login);
                              },
                            ),
                            const SizedBox(width: 10),
                            _PrimaryPill(
                              label: 'Kayıt Ol',
                              onTap: () {
                                _closeMobile();
                                context.go(Routes.register);
                              },
                            ),
                          ],
                        ],

                        // Mobile hamburger
                        if (!isDesktop)
                          IconButton(
                            tooltip: _mobileOpen ? 'Kapat' : 'Menü',
                            onPressed: () => setState(() => _mobileOpen = !_mobileOpen),
                            icon: Icon(_mobileOpen ? Icons.close : Icons.menu),
                          ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // Mobile menu (React slideDown)
            if (!isDesktop)
              AnimatedSize(
                duration: const Duration(milliseconds: 180),
                curve: Curves.easeOut,
                child: _mobileOpen
                    ? Container(
                        width: double.infinity,
                        decoration: const BoxDecoration(
                          border: Border(top: BorderSide(color: Color(0xFFE5E7EB))),
                        ),
                        padding: const EdgeInsets.fromLTRB(16, 10, 16, 16),
                        child: Center(
                          child: ConstrainedBox(
                            constraints: const BoxConstraints(maxWidth: 520),
                            child: Column(
                              children: [
                                for (final item in menuItems)
                                  _MobileTile(
                                    label: item.label,
                                    onTap: () {
                                      _closeMobile();
                                      context.go(item.path);
                                    },
                                  ),

                                const SizedBox(height: 8),

                                if (!isLoggedIn)
                                  _MobilePrimary(
                                    label: 'İşletme Girişi',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.companyAuth);
                                    },
                                  ),

                                if (isLoading) ...[
                                  const SizedBox(height: 12),
                                  const _SkeletonBlock(),
                                ] else if (isLoggedIn) ...[
                                  const SizedBox(height: 10),

                                  if (isStudent)
                                    _MobileTile(
                                      label: 'Puan Sistemi',
                                      leading: const Icon(Icons.emoji_events, size: 18),
                                      onTap: () {
                                        _closeMobile();
                                        context.go(Routes.pointsSystem);
                                      },
                                    ),

                                  if (isCompany) ...[
                                    const SizedBox(height: 6),
                                    _MobilePrimary(
                                      label: 'Yeni İlan',
                                      onTap: () {
                                        _closeMobile();
                                        context.go(Routes.companyJobsCreate);
                                      },
                                    ),
                                  ],

                                  const Divider(height: 22),

                                  _MobileHeader(
                                    title: userName,
                                    badge: isCompany ? 'İşletme' : null,
                                  ),

                                  for (final it in dropdownItems)
                                    _MobileTile(
                                      label: it.label,
                                      onTap: () {
                                        _closeMobile();
                                        context.go(it.path);
                                      },
                                    ),

                                  const SizedBox(height: 8),
                                  _MobileDanger(
                                    label: 'Çıkış Yap',
                                    onTap: () => _logout(context),
                                  ),
                                ] else ...[
                                  const SizedBox(height: 10),
                                  _MobilePrimary(
                                    label: 'Öğrenci Girişi',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.login);
                                    },
                                  ),
                                  const SizedBox(height: 8),
                                  _MobilePrimary(
                                    label: 'Kayıt Ol',
                                    onTap: () {
                                      _closeMobile();
                                      context.go(Routes.register);
                                    },
                                  ),
                                ],
                              ],
                            ),
                          ),
                        ),
                      )
                    : const SizedBox.shrink(),
              ),
          ],
        ),
      ),
    );
  }

  void _closeMobile() {
    if (_mobileOpen) setState(() => _mobileOpen = false);
  }

  Future<int> _fetchUserTotalPoints(String userId) async {
    try {
      final data = await SupabaseService.client
          .from('profiles')
          .select('total_points')
          .eq('id', userId)
          .single();

      final v = data['total_points'];
      if (v is int) return v;
      if (v is num) return v.toInt();
      return 0;
    } catch (_) {
      return 0;
    }
  }
}

class _NavItem {
  const _NavItem(this.label, this.path);
  final String label;
  final String path;
}

class _NavTextLink extends StatelessWidget {
  const _NavTextLink({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(10),
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
        child: Text(
          label,
          style: const TextStyle(
            fontWeight: FontWeight.w600,
            fontSize: 13,
            color: Color(0xFF374151),
          ),
        ),
      ),
    );
  }
}

class _PrimaryPill extends StatefulWidget {
  const _PrimaryPill({
    required this.label,
    required this.onTap,
    this.rounded = 10,
  });

  final String label;
  final VoidCallback onTap;
  final double rounded;

  @override
  State<_PrimaryPill> createState() => _PrimaryPillState();
}

class _PrimaryPillState extends State<_PrimaryPill> {
  bool _hover = false;
  static const _purple = Color(0xFF7C3AED);
  static const _purpleHover = Color(0xFF6D28D9);

  @override
  Widget build(BuildContext context) {
    final enableHover = kIsWeb;
    return MouseRegion(
      onEnter: enableHover ? (_) => setState(() => _hover = true) : null,
      onExit: enableHover ? (_) => setState(() => _hover = false) : null,
      child: AnimatedScale(
        duration: const Duration(milliseconds: 140),
        scale: _hover ? 1.05 : 1.0,
        child: InkWell(
          borderRadius: BorderRadius.circular(widget.rounded),
          onTap: widget.onTap,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
            decoration: BoxDecoration(
              color: _hover ? _purpleHover : _purple,
              borderRadius: BorderRadius.circular(widget.rounded),
              boxShadow: const [
                BoxShadow(
                  blurRadius: 10,
                  offset: Offset(0, 6),
                  color: Color(0x14000000),
                )
              ],
            ),
            child: Text(
              widget.label,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w700,
                fontSize: 13,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _PointsChip extends StatelessWidget {
  const _PointsChip({required this.future, required this.onTap});
  final Future<int>? future;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(12),
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
        decoration: BoxDecoration(
          color: const Color(0xFFF3E8FF),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          children: [
            const Icon(Icons.emoji_events, size: 16, color: Color(0xFF6D28D9)),
            const SizedBox(width: 6),
            FutureBuilder<int>(
              future: future,
              builder: (_, snap) {
                final v = snap.data ?? 0;
                return Text(
                  '$v',
                  style: const TextStyle(
                    color: Color(0xFF6D28D9),
                    fontWeight: FontWeight.w800,
                    fontSize: 13,
                  ),
                );
              },
            ),
          ],
        ),
      ),
    );
  }
}

class _ProfileDropdown extends StatelessWidget {
  const _ProfileDropdown({
    required this.userName,
    required this.isCompany,
    required this.items,
    required this.onItemTap,
    required this.onLogout,
  });

  final String userName;
  final bool isCompany;
  final List<_NavItem> items;
  final void Function(String path) onItemTap;
  final Future<void> Function() onLogout;

  @override
  Widget build(BuildContext context) {
    return PopupMenuButton<_NavItem?>(
      tooltip: 'Profil Menüsü',
      offset: const Offset(0, 12),
      onSelected: (selected) async {
        if (selected == null) {
          await onLogout();
        } else {
          onItemTap(selected.path);
        }
      },
      itemBuilder: (context) => [
        for (final it in items)
          PopupMenuItem<_NavItem?>(
            value: it,
            child: Text(it.label),
          ),
        const PopupMenuDivider(),
        const PopupMenuItem<_NavItem?>(
          value: null,
          child: Text(
            'Çıkış Yap',
            style: TextStyle(color: Colors.red),
          ),
        ),
      ],
      child: Row(
        children: [
          Icon(isCompany ? Icons.apartment : Icons.person, size: 18, color: const Color(0xFF374151)),
          const SizedBox(width: 8),
          Text(
            userName,
            style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 13, color: Color(0xFF374151)),
          ),
          if (isCompany) ...[
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
              decoration: BoxDecoration(
                color: const Color(0xFFF3E8FF),
                borderRadius: BorderRadius.circular(999),
              ),
              child: const Text(
                'İşletme',
                style: TextStyle(color: Color(0xFF6D28D9), fontSize: 11, fontWeight: FontWeight.w700),
              ),
            ),
          ],
          const SizedBox(width: 6),
          const Icon(Icons.expand_more, size: 18, color: Color(0xFF6B7280)),
        ],
      ),
    );
  }
}

// --------------------
// Mobile widgets
// --------------------

class _MobileTile extends StatelessWidget {
  const _MobileTile({required this.label, required this.onTap, this.leading});
  final String label;
  final VoidCallback onTap;
  final Widget? leading;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(12),
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 12),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            if (leading != null) ...[leading!, const SizedBox(width: 8)],
            Text(
              label,
              style: const TextStyle(fontWeight: FontWeight.w600, color: Color(0xFF374151)),
            ),
          ],
        ),
      ),
    );
  }
}

class _MobilePrimary extends StatelessWidget {
  const _MobilePrimary({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return _PrimaryPill(label: label, onTap: onTap, rounded: 14);
  }
}

class _MobileDanger extends StatelessWidget {
  const _MobileDanger({required this.label, required this.onTap});
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: BorderRadius.circular(14),
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
        decoration: BoxDecoration(
          color: const Color(0xFFEF4444),
          borderRadius: BorderRadius.circular(14),
        ),
        child: Center(
          child: Text(
            label,
            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w800),
          ),
        ),
      ),
    );
  }
}

class _MobileHeader extends StatelessWidget {
  const _MobileHeader({required this.title, this.badge});
  final String title;
  final String? badge;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(title, style: const TextStyle(fontWeight: FontWeight.w800, color: Color(0xFF6D28D9))),
          if (badge != null) ...[
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
              decoration: BoxDecoration(
                color: const Color(0xFFF3E8FF),
                borderRadius: BorderRadius.circular(999),
              ),
              child: Text(
                badge!,
                style: const TextStyle(color: Color(0xFF6D28D9), fontSize: 11, fontWeight: FontWeight.w800),
              ),
            )
          ],
        ],
      ),
    );
  }
}

class _SkeletonPill extends StatelessWidget {
  const _SkeletonPill();

  @override
  Widget build(BuildContext context) {
    return DecoratedBox(
      decoration: BoxDecoration(
        color: const Color(0xFFE5E7EB),
        borderRadius: BorderRadius.circular(12),
      ),
    );
  }
}

class _SkeletonBlock extends StatelessWidget {
  const _SkeletonBlock();

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 48,
      decoration: BoxDecoration(
        color: const Color(0xFFE5E7EB),
        borderRadius: BorderRadius.circular(14),
      ),
    );
  }
}



✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅

